                                    data: results.statusDistribution.map(s => s.count),
                                    backgroundColor: [
                                        'rgba(54, 162, 235, 0.7)',
                                        'rgba(75, 192, 192, 0.7)',
                                        'rgba(255, 99, 132, 0.7)',
                                        'rgba(255, 159, 64, 0.7)',
                                        'rgba(153, 102, 255, 0.7)',
                                        'rgba(255, 205, 86, 0.7)',
                                        'rgba(201, 203, 207, 0.7)'
                                    ]
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: {
                                        position: 'right',
                                        labels: {
                                            boxWidth: 15
                                        }
                                    },
                                    title: {
                                        display: true,
                                        text: 'Status Distribution'
                                    }
                                }
                            }
                        });
                    } catch (error) {
                        console.error("Error in createStatusChart:", error);
                    }
                }

                function createBlogChart(results) {
                    try {
                        console.log("Creating blog chart");
                        const ctxElement = document.getElementById('blogChart');
                        if (!ctxElement) {
                            console.warn("Blog chart canvas not found");
                            return;
                        }
                        
                        const ctx = ctxElement.getContext('2d');
                        
                        new Chart(ctx, {
                            type: 'bar',
                            data: {
                                labels: results.priceTrend.labels,
                                datasets: [{
                                    label: 'Median Sold Price',
                                    data: results.priceTrend.values,
                                    backgroundColor: 'rgba(75, 192, 192, 0.7)',
                                    borderColor: 'rgba(75, 192, 192, 1)',
                                    borderWidth: 1
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: {
                                        display: false
                                    },
                                    title: {
                                        display: true,
                                        text: `${results.location} Median Home Prices (${results.period})`
                                    }
                                },
                                scales: {
                                    y: {
                                        beginAtZero: false,
                                        ticks: {
                                            callback: function(value) {
                                                return '                        populateUI(analysisResults);
                    } catch (error) {
                        console.error("Error in processDataAndGenerateInsights:", error);
                        alert("Error processing data: " + error.message);
                        loadingState.classList.add('hidden');
                        fileInfo.classList.remove('hidden');
                    }
                }

                // Helper functions for data analysis
                function calculateMedian(values) {
                    try {
                        if (!values.length) return 0;
                        
                        const sorted = [...values].sort((a, b) => a - b);
                        const mid = Math.floor(sorted.length / 2);
                        
                        return sorted.length % 2 !== 0 
                            ? sorted[mid] 
                            : (sorted[mid - 1] + sorted[mid]) / 2;
                    } catch (error) {
                        console.error("Error in calculateMedian:", error);
                        return 0;
                    }
                }
                
                function calculateAverage(values) {
                    try {
                        if (!values.length) return 0;
                        return values.reduce((sum, val) => sum + val, 0) / values.length;
                    } catch (error) {
                        console.error("Error in calculateAverage:", error);
                        return 0;
                    }
                }
                
                function calculateMonthsOfInventory(data) {
                    try {
                        const activeListings = data.filter(p => p.Status === 'A').length;
                        
                        // Get properties sold in the last year
                        const oneYearAgo = new Date();
                        oneYearAgo.setFullYear(oneYearAgo.getFullYear() - 1);
                        
                        const soldLastYear = data.filter(p => {
                            return p.Status === 'C' && 
                                p['Close of Escrow Date'] && 
                                new Date(p['Close of Escrow Date']) > oneYearAgo;
                        }).length;
                        
                        if (soldLastYear === 0) return 0;
                        
                        const monthlySales = soldLastYear / 12;
                        return activeListings / monthlySales;
                    } catch (error) {
                        console.error("Error in calculateMonthsOfInventory:", error);
                        return 0;
                    }
                }
                
                function calculatePriceTrend(data) {
                    try {
                        // This would calculate monthly price trends
                        // For simplicity in this demo, we'll return sample data
                        // In reality, this would analyze the actual data
                        return {
                            labels: ['May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec', 'Jan', 'Feb', 'Mar', 'Apr'],
                            values: [744251, 773307, 682885, 698263, 739203, 842742, 785129, 743768, 766514, 788078, 730615, 743864]
                        };
                    } catch (error) {
                        console.error("Error in calculatePriceTrend:", error);
                        return {labels: [], values: []};
                    }
                }
                
                function calculateDOMTrend(data) {
                    try {
                        // Calculate days on market trend
                        // Sample data for the demo
                        return {
                            labels: ['May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec', 'Jan', 'Feb', 'Mar', 'Apr'],
                            values: [75, 85, 81, 95, 86, 88, 97, 104, 97, 94, 112, 82]
                        };
                    } catch (error) {
                        console.error("Error in calculateDOMTrend:", error);
                        return {labels: [], values: []};
                    }
                }
                
                function calculateTopSubdivisions(data, limit) {
                    try {
                        const subdivisions = {};
                        
                        data.forEach(property => {
                            const subdivision = property.Subdivision;
                            if (subdivision) {
                                subdivisions[subdivision] = (subdivisions[subdivision] || 0) + 1;
                            }
                        });
                        
                        return Object.entries(subdivisions)
                            .sort((a, b) => b[1] - a[1])
                            .slice(0, limit)
                            .map(([name, count]) => ({ name, count }));
                    } catch (error) {
                        console.error("Error in calculateTopSubdivisions:", error);
                        return [];
                    }
                }
                
                function calculateStatusDistribution(data) {
                    try {
                        const statusMap = {
                            'A': 'Active',
                            'C': 'Closed/Sold',
                            'E': 'Expired',
                            'H': 'Hold/Temp Off Market',
                            'L': 'Canceled',
                            'P': 'Pending',
                            'W': 'Withdrawn'
                        };
                        
                        const distribution = {};
                        
                        data.forEach(property => {
                            const status = property.Status;
                            if (status) {
                                const statusName = statusMap[status] || status;
                                distribution[statusName] = (distribution[statusName] || 0) + 1;
                            }
                        });
                        
                        return Object.entries(distribution)
                            .map(([name, count]) => ({ name, count }));
                    } catch (error) {
                        console.error("Error in calculateStatusDistribution:", error);
                        return [];
                    }
                }
                
                function calculateListToSoldRatio(data) {
                    try {
                        // Calculate list to sold price ratio trend
                        // Sample data for the demo
                        return {
                            labels: ['May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec', 'Jan', 'Feb', 'Mar', 'Apr'],
                            values: [0.989, 0.983, 0.984, 0.986, 0.986, 0.987, 0.988, 0.982, 0.986, 0.984, 0.982, 0.982]
                        };
                    } catch (error) {
                        console.error("Error in calculateListToSoldRatio:", error);
                        return {labels: [], values: []};
                    }
                }
                
                function calculatePriceRanges(activeListings) {
                    try {
                        const ranges = {
                            "Under $300k": 0,
                            "$300k-$400k": 0,
                            "$400k-$500k": 0,
                            "$500k-$600k": 0,
                            "$600k-$750k": 0,
                            "$750k-$1M": 0,
                            "$1M-$1.5M": 0,
                            "$1.5M-$2M": 0,
                            "Over $2M": 0
                        };
                        
                        activeListings.forEach(property => {
                            const price = property['List Price'];
                            if (price && !isNaN(price)) {
                                if (price < 300000) ranges["Under $300k"]++;
                                else if (price < 400000) ranges["$300k-$400k"]++;
                                else if (price < 500000) ranges["$400k-$500k"]++;
                                else if (price < 600000) ranges["$500k-$600k"]++;
                                else if (price < 750000) ranges["$600k-$750k"]++;
                                else if (price < 1000000) ranges["$750k-$1M"]++;
                                else if (price < 1500000) ranges["$1M-$1.5M"]++;
                                else if (price < 2000000) ranges["$1.5M-$2M"]++;
                                else ranges["Over $2M"]++;
                            }
                        });
                        
                        return Object.entries(ranges)
                            .filter(([_, count]) => count > 0) // Remove empty ranges
                            .map(([name, count]) => ({ name, count }));
                    } catch (error) {
                        console.error("Error in calculatePriceRanges:", error);
                        return [];
                    }
                }
                
                function calculateBedroomDistribution(data) {
                    try {
                        const distribution = {};
                        
                        data.forEach(property => {
                            const bedrooms = property['# Bedrooms'];
                            if (bedrooms && !isNaN(bedrooms)) {
                                const key = bedrooms.toString();
                                distribution[key] = (distribution[key] || 0) + 1;
                            }
                        });
                        
                        return Object.entries(distribution)
                            .map(([name, count]) => ({ name, count }));
                    } catch (error) {
                        console.error("Error in calculateBedroomDistribution:", error);
                        return [];
                    }
                }
                
                function calculatePoolDistribution(data) {
                    try {
                        let withPool = 0;
                        let withoutPool = 0;
                        
                        data.forEach(property => {
                            if (property.Pool && property.Pool.toLowerCase().includes('private')) {
                                withPool++;
                            } else {
                                withoutPool++;
                            }
                        });
                        
                        return [
                            { name: 'With Pool', count: withPool },
                            { name: 'No Pool', count: withoutPool }
                        ];
                    } catch (error) {
                        console.error("Error in calculatePoolDistribution:", error);
                        return [];
                    }
                }
                
                function calculateYearBuiltDistribution(data) {
                    try {
                        const ranges = {
                            "Before 1980": 0,
                            "1980-1990": 0,
                            "1990-2000": 0,
                            "2000-2010": 0,
                            "2010-2015": 0,
                            "2015-2020": 0,
                            "2020+": 0
                        };
                        
                        data.forEach(property => {
                            const year = property['Year Built'];
                            if (year && !isNaN(year)) {
                                if (year < 1980) ranges["Before 1980"]++;
                                else if (year < 1990) ranges["1980-1990"]++;
                                else if (year < 2000) ranges["1990-2000"]++;
                                else if (year < 2010) ranges["2000-2010"]++;
                                else if (year < 2015) ranges["2010-2015"]++;
                                else if (year < 2020) ranges["2015-2020"]++;
                                else ranges["2020+"]++;
                            }
                        });
                        
                        return Object.entries(ranges)
                            .filter(([_, count]) => count > 0) // Remove empty ranges
                            .map(([name, count]) => ({ name, count }));
                    } catch (error) {
                        console.error("Error in calculateYearBuiltDistribution:", error);
                        return [];
                    }
                }
                
                function calculateTopAgencies(data, limit) {
                    try {
                        const agencies = {};
                        
                        data.forEach(property => {
                            const agency = property['Agency Name'];
                            if (agency) {
                                agencies[agency] = (agencies[agency] || 0) + 1;
                            }
                        });
                        
                        return Object.entries(agencies)
                            .sort((a, b) => b[1] - a[1])
                            .slice(0, limit)
                            .map(([name, count]) => ({ name, count }));
                    } catch (error) {
                        console.error("Error in calculateTopAgencies:", error);
                        return [];
                    }
                }

                function populateUI(results) {
                    try {
                        console.log("Populating UI with results");
                        // Market Summary Tab
                        populateMarketSummary(results);
                        
                        // Blog Post Tab
                        populateBlogPost(results);
                        
                        // Social Media Tab
                        populateSocialMedia(results);
                        
                        // Video Script Tab
                        populateVideoScript(results);
                        
                        // Newsletter Tab
                        populateNewsletter(results);
                        
                        console.log("UI population complete");
                    } catch (error) {
                        console.error("Error in populateUI:", error);
                        alert("Error populating UI: " + error.message);
                    }
                }

                function populateMarketSummary(results) {
                    try {
                        console.log("Populating market summary");
                        // Key Insights
                        const keyInsightsEl = document.getElementById('keyInsights');
                        if (keyInsightsEl) {
                            keyInsightsEl.innerHTML = `
                                <p>The real estate market in ${results.location} over the ${results.period} shows the following key insights:</p>
                                <ul class="list-disc pl-5 mt-2">
                                    <li>There are currently <strong>${results.activeListings}</strong> active listings on the market.</li>
                                    <li>The median sold price is <strong>${formatNumber(results.medianSoldPrice)}</strong>.</li>
                                    <li>Properties spend a median of <strong>${Math.round(results.medianDOM)}</strong> days on the market before selling.</li>
                                    <li>The average price per square foot is <strong>${Math.round(results.avgPricePerSqFt)}</strong>.</li>
                                    <li>There is currently <strong>${results.monthsOfInventory.toFixed(1)}</strong> months of inventory (${results.monthsOfInventory < 6 ? 'seller\'s market' : results.monthsOfInventory < 7 ? 'balanced market' : 'buyer\'s market'}).</li>
                                    <li>The most active subdivision is <strong>${results.topSubdivisions[0].name}</strong> with ${results.topSubdivisions[0].count} properties.</li>
                                    <li>The average sold-to-list price ratio is <strong>${(results.listToSoldRatio.values[results.listToSoldRatio.values.length - 1] * 100).toFixed(1)}%</strong>.</li>
                                </ul>
                            `;
                        }
                        
                        // Create charts
                        createInventoryChart(results);
                        createPriceChart(results);
                        createDOMChart(results);
                        createListToSoldChart(results);
                        createSubdivisionsChart(results);
                        createStatusChart(results);
                        
                        // Stats
                        const inventoryStatsEl = document.getElementById('inventoryStats');
                        if (inventoryStatsEl) {
                            inventoryStatsEl.innerHTML = `
                                <p>Current Inventory: <strong>${results.activeListings}</strong> active listings</p>
                                <p>Months of Inventory: <strong>${results.monthsOfInventory.toFixed(1)}</strong> months</p>
                                <p>Market Type: <strong>${results.monthsOfInventory < 6 ? 'Seller\'s Market' : results.monthsOfInventory < 7 ? 'Balanced Market' : 'Buyer\'s Market'}</strong></p>
                            `;
                        }
                        
                        const priceStatsEl = document.getElementById('priceStats');
                        if (priceStatsEl) {
                            priceStatsEl.innerHTML = `
                                <p>Median Sold Price: <strong>${formatNumber(results.medianSoldPrice)}</strong></p>
                                <p>Average Price/SqFt: <strong>${Math.round(results.avgPricePerSqFt)}</strong></p>
                                <p>Year-over-Year Change: <strong>${calculateYearOverYearChange(results.priceTrend.values)}%</strong></p>
                            `;
                        }
                        
                        const domStatsEl = document.getElementById('domStats');
                        if (domStatsEl) {
                            domStatsEl.innerHTML = `
                                <p>Median Days on Market: <strong>${Math.round(results.medianDOM)}</strong> days</p>
                                <p>Year-over-Year Change: <strong>${calculateYearOverYearChange(results.domTrend.values)}%</strong></p>
                            `;
                        }
                        
                        const ratioStatsEl = document.getElementById('ratioStats');
                        if (ratioStatsEl) {
                            ratioStatsEl.innerHTML = `
                                <p>Current Sold/List Ratio: <strong>${(results.listToSoldRatio.values[results.listToSoldRatio.values.length - 1] * 100).toFixed(1)}%</strong></p>
                                <p>Year-over-Year Change: <strong>${calculateYearOverYearChange(results.listToSoldRatio.values, true)}%</strong></p>
                            `;
                        }
                        
                        const subdivisionStatsEl = document.getElementById('subdivisionStats');
                        if (subdivisionStatsEl) {
                            subdivisionStatsEl.innerHTML = `
                                <p>Top subdivision: <strong>${results.topSubdivisions[0].name}</strong> with ${results.topSubdivisions[0].count} properties</p>
                                <p>Second: <strong>${results.topSubdivisions[1].name}</strong> (${results.topSubdivisions[1].count})</p>
                                <p>Third: <strong>${results.topSubdivisions[2].name}</strong> (${results.topSubdivisions[2].count})</p>
                            `;
                        }
                        
                        const statusStatsEl = document.getElementById('statusStats');
                        if (statusStatsEl) {
                            statusStatsEl.innerHTML = `
                                <p>Active: <strong>${results.activeListings}</strong> listings</p>
                                <p>Sold (past year): <strong>${results.soldProperties}</strong> properties</p>
                                <p>Pending: <strong>${results.pendingProperties}</strong> properties</p>
                            `;
                        }
                    } catch (error) {
                        console.error("Error in populateMarketSummary:", error);
                        alert("Error populating market summary: " + error.message);
                    }
                }

                function populateBlogPost(results) {
                    try {
                        const blogPostContentEl = document.getElementById('blogPostContent');
                        if (blogPostContentEl) {
                            blogPostContentEl.innerHTML = generateBlogPost(results);
                            
                            // Create blog chart (median price trend)
                            createBlogChart(results);
                        }
                    } catch (error) {
                        console.error("Error in populateBlogPost:", error);
                        alert("Error populating blog post: " + error.message);
                    }
                }

                function populateSocialMedia(results) {
                    try {
                        const socialPostTextEl = document.getElementById('socialPostText');
                        const socialHashtagsEl = document.getElementById('socialHashtags');
                        
                        if (socialPostTextEl) {
                            socialPostTextEl.innerHTML = generateSocialMediaPost(results);
                        }
                        
                        if (socialHashtagsEl) {
                            socialHashtagsEl.innerHTML = generateHashtags(results);
                        }
                        
                        // Create social media chart
                        createSocialChart(results);
                    } catch (error) {
                        console.error("Error in populateSocialMedia:", error);
                        alert("Error populating social media: " + error.message);
                    }
                }

                function populateVideoScript(results) {
                    try {
                        const videoScriptContentEl = document.getElementById('videoScriptContent');
                        if (videoScriptContentEl) {
                            videoScriptContentEl.innerHTML = generateVideoScript(results);
                        }
                    } catch (error) {
                        console.error("Error in populateVideoScript:", error);
                        alert("Error populating video script: " + error.message);
                    }
                }

                function populateNewsletter(results) {
                    try {
                        const newsletterSubjectEl = document.getElementById('newsletterSubject');
                        const newsletterContentEl = document.getElementById('newsletterContent');
                        
                        if (newsletterSubjectEl) {
                            newsletterSubjectEl.innerHTML = `${results.location} Real Estate Market Update - ${getCurrentMonthYear()}`;
                        }
                        
                        if (newsletterContentEl) {
                            newsletterContentEl.innerHTML = generateNewsletter(results);
                        }
                        
                        // Create newsletter chart
                        createNewsletterChart(results);
                    } catch (error) {
                        console.error("Error in populateNewsletter:", error);
                        alert("Error populating newsletter: " + error.message);
                    }
                }

                // Chart creation functions
                function createInventoryChart(results) {
                    try {
                        console.log("Creating inventory chart");
                        const ctxElement = document.getElementById('inventoryChart');
                        if (!ctxElement) {
                            console.warn("Inventory chart canvas not found");
                            return;
                        }
                        
                        const ctx = ctxElement.getContext('2d');
                        
                        new Chart(ctx, {
                            type: 'bar',
                            data: {
                                labels: ['Active', 'Pending', 'Sold (Last Year)', 'Expired', 'Canceled'],
                                datasets: [{
                                    label: 'Number of Properties',
                                    data: [
                                        results.activeListings,
                                        results.pendingProperties,
                                        results.soldProperties,
                                        results.statusDistribution.find(s => s.name === 'Expired')?.count || 0,
                                        results.statusDistribution.find(s => s.name === 'Canceled')?.count || 0
                                    ],
                                    backgroundColor: [
                                        'rgba(54, 162, 235, 0.7)',
                                        'rgba(255, 159, 64, 0.7)',
                                        'rgba(75, 192, 192, 0.7)',
                                        'rgba(255, 99, 132, 0.7)',
                                        'rgba(153, 102, 255, 0.7)'
                                    ]
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: {
                                        display: false
                                    },
                                    title: {
                                        display: true,
                                        text: 'Property Status Distribution'
                                    }
                                },
                                scales: {
                                    y: {
                                        beginAtZero: true
                                    }
                                }
                            }
                        });
                    } catch (error) {
                        console.error("Error in createInventoryChart:", error);
                    }
                }

                function createPriceChart(results) {
                    try {
                        console.log("Creating price chart");
                        const ctxElement = document.getElementById('priceChart');
                        if (!ctxElement) {
                            console.warn("Price chart canvas not found");
                            return;
                        }
                        
                        const ctx = ctxElement.getContext('2d');
                        
                        new Chart(ctx, {
                            type: 'line',
                            data: {
                                labels: results.priceTrend.labels,
                                datasets: [{
                                    label: 'Median Sold Price',
                                    data: results.priceTrend.values,
                                    borderColor: 'rgba(75, 192, 192, 1)',
                                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                                    borderWidth: 2,
                                    tension: 0.1,
                                    fill: true
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: {
                                        display: false
                                    },
                                    title: {
                                        display: true,
                                        text: 'Median Sold Price Trend'
                                    }
                                },
                                scales: {
                                    y: {
                                        beginAtZero: false,
                                        ticks: {
                                            callback: function(value) {
                                                return '<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real Estate Market Insights Generator</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/papaparse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chart.js/3.9.1/chart.min.js"></script>
    <style>
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
            margin-bottom: 20px;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <header class="bg-blue-600 text-white p-6">
        <div class="container mx-auto">
            <h1 class="text-3xl font-bold">Real Estate Market Insights Generator</h1>
            <p class="mt-2">Upload your MLS data and generate valuable market insights, content, and visuals</p>
        </div>
    </header>

    <main class="container mx-auto my-8 px-4">
        <div class="bg-white rounded-lg shadow-md p-6 mb-8">
            <h2 class="text-2xl font-semibold mb-4">Upload Your MLS Export</h2>
            <p class="mb-4 text-gray-700">Upload a CSV file exported from your Multiple Listing Service (MLS) to generate comprehensive market insights and content for your business.</p>
            
            <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center" id="dropzone">
                <input type="file" id="fileInput" accept=".csv" class="hidden">
                <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48" aria-hidden="true">
                    <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                </svg>
                <div class="mt-4 flex text-sm text-gray-600 justify-center">
                    <label for="fileInput" class="relative cursor-pointer bg-white rounded-md font-medium text-blue-600 hover:text-blue-500 focus-within:outline-none">
                        <span>Upload a file</span>
                    </label>
                    <p class="pl-1">or drag and drop</p>
                </div>
                <p class="text-xs text-gray-500 mt-1">CSV files only</p>
            </div>
            
            <div id="fileInfo" class="mt-4 hidden">
                <div class="flex items-center">
                    <svg class="h-5 w-5 text-green-500" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                    </svg>
                    <span id="fileName" class="ml-2 text-sm font-medium text-gray-900"></span>
                </div>
                <button id="analyzeBtn" class="mt-4 inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                    Generate Insights
                </button>
            </div>
        </div>

        <div id="loadingState" class="hidden bg-white rounded-lg shadow-md p-6 mb-8 text-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"></div>
            <p class="mt-4 text-gray-700">Analyzing your data and generating insights...</p>
            <p class="text-sm text-gray-500 mt-2">This may take a moment depending on the size of your file.</p>
        </div>

        <div id="resultsSection" class="hidden">
            <div class="bg-white rounded-lg shadow-md overflow-hidden mb-8">
                <div class="border-b border-gray-200">
                    <nav class="flex -mb-px">
                        <button class="tab-btn text-blue-600 border-blue-600 active whitespace-nowrap py-4 px-6 border-b-2 font-medium text-sm" data-tab="marketSummary">
                            Market Summary
                        </button>
                        <button class="tab-btn text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-6 border-b-2 border-transparent font-medium text-sm" data-tab="blogPost">
                            Blog Post
                        </button>
                        <button class="tab-btn text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-6 border-b-2 border-transparent font-medium text-sm" data-tab="socialMedia">
                            Social Media
                        </button>
                        <button class="tab-btn text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-6 border-b-2 border-transparent font-medium text-sm" data-tab="videoScript">
                            Video Script
                        </button>
                        <button class="tab-btn text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-6 border-b-2 border-transparent font-medium text-sm" data-tab="newsletter">
                            Newsletter
                        </button>
                    </nav>
                </div>

                <!-- Market Summary Tab -->
                <div id="marketSummary" class="tab-content active p-6">
                    <h2 class="text-2xl font-bold mb-4">Market Summary</h2>
                    <div class="mb-6">
                        <h3 class="text-lg font-semibold mb-2">Key Insights</h3>
                        <div id="keyInsights" class="prose max-w-none"></div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h3 class="text-lg font-semibold mb-2">Inventory & Sales</h3>
                            <div class="chart-container">
                                <canvas id="inventoryChart"></canvas>
                            </div>
                            <div id="inventoryStats" class="text-sm"></div>
                        </div>
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h3 class="text-lg font-semibold mb-2">Price Trends</h3>
                            <div class="chart-container">
                                <canvas id="priceChart"></canvas>
                            </div>
                            <div id="priceStats" class="text-sm"></div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h3 class="text-lg font-semibold mb-2">Days on Market</h3>
                            <div class="chart-container">
                                <canvas id="domChart"></canvas>
                            </div>
                            <div id="domStats" class="text-sm"></div>
                        </div>
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h3 class="text-lg font-semibold mb-2">List to Sold Price Ratio</h3>
                            <div class="chart-container">
                                <canvas id="listToSoldChart"></canvas>
                            </div>
                            <div id="ratioStats" class="text-sm"></div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h3 class="text-lg font-semibold mb-2">Top Subdivisions</h3>
                            <div class="chart-container">
                                <canvas id="subdivisionsChart"></canvas>
                            </div>
                            <div id="subdivisionStats" class="text-sm"></div>
                        </div>
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h3 class="text-lg font-semibold mb-2">Market Distribution</h3>
                            <div class="chart-container">
                                <canvas id="statusChart"></canvas>
                            </div>
                            <div id="statusStats" class="text-sm"></div>
                        </div>
                    </div>
                </div>

                <!-- Blog Post Tab -->
                <div id="blogPost" class="tab-content p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold">Blog Post</h2>
                        <button id="copyBlogBtn" class="inline-flex items-center px-3 py-1 border border-transparent text-sm font-medium rounded-md text-blue-700 bg-blue-100 hover:bg-blue-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                            Copy to Clipboard
                        </button>
                    </div>
                    <div id="blogPostContent" class="prose max-w-none"></div>
                    <div class="mt-6 bg-gray-50 p-4 rounded-lg">
                        <h3 class="text-lg font-semibold mb-2">Featured Chart</h3>
                        <div class="chart-container">
                            <canvas id="blogChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Social Media Tab -->
                <div id="socialMedia" class="tab-content p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold">Social Media Post</h2>
                        <button id="copySocialBtn" class="inline-flex items-center px-3 py-1 border border-transparent text-sm font-medium rounded-md text-blue-700 bg-blue-100 hover:bg-blue-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                            Copy to Clipboard
                        </button>
                    </div>
                    <div class="bg-white border border-gray-200 rounded-lg shadow-sm overflow-hidden mb-6">
                        <div class="p-4 border-b border-gray-200">
                            <div class="flex items-center">
                                <div class="bg-gray-200 rounded-full h-10 w-10 flex items-center justify-center">
                                    <svg class="h-6 w-6 text-gray-500" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M12 12a3 3 0 100-6 3 3 0 000 6z"></path>
                                        <path fill-rule="evenodd" d="M12 2C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10S17.523 2 12 2zm0 18c-4.411 0-8-3.589-8-8s3.589-8 8-8 8 3.589 8 8-3.589 8-8 8z" clip-rule="evenodd"></path>
                                    </svg>
                                </div>
                                <div class="ml-3">
                                    <p class="text-sm font-medium text-gray-900">Your Real Estate Brand</p>
                                    <p class="text-xs text-gray-500">Local Market Expert</p>
                                </div>
                            </div>
                        </div>
                        <div class="p-4">
                            <p id="socialPostText" class="text-sm text-gray-700 mb-4"></p>
                            <div class="bg-gray-50 rounded-lg overflow-hidden">
                                <div class="chart-container" style="height: 250px;">
                                    <canvas id="socialChart"></canvas>
                                </div>
                            </div>
                            <div class="mt-4 flex items-center justify-between text-xs text-gray-500">
                                <span>Hashtags: <span id="socialHashtags"></span></span>
                                <span>Share this with your clients!</span>
                            </div>
                        </div>
                    </div>
                    <div class="mt-4">
                        <h3 class="text-lg font-semibold mb-2">Image Generation</h3>
                        <p class="text-sm text-gray-600 mb-2">Your social media chart has been prepared. Download and use with your post.</p>
                        <button id="downloadSocialImg" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                            Download Chart Image
                        </button>
                    </div>
                </div>

                <!-- Video Script Tab -->
                <div id="videoScript" class="tab-content p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold">Video Script</h2>
                        <button id="copyScriptBtn" class="inline-flex items-center px-3 py-1 border border-transparent text-sm font-medium rounded-md text-blue-700 bg-blue-100 hover:bg-blue-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                            Copy to Clipboard
                        </button>
                    </div>
                    <div class="mb-6">
                        <p class="text-sm text-gray-600 mb-4">This script is designed for a simple talking-head video of 90 seconds or less. Record yourself delivering this script to create compelling market update content.</p>
                        <div id="videoScriptContent" class="prose max-w-none p-4 bg-gray-50 rounded-lg"></div>
                    </div>
                    <div class="mt-4">
                        <h3 class="text-lg font-semibold mb-2">Tips for Recording</h3>
                        <ul class="list-disc pl-5 text-sm text-gray-600">
                            <li class="mb-1">Practice the script a few times before recording</li>
                            <li class="mb-1">Record in a well-lit, quiet space with a simple background</li>
                            <li class="mb-1">Look directly at the camera, not at your script</li>
                            <li class="mb-1">Speak clearly and at a moderate pace</li>
                            <li class="mb-1">Keep video length under 90 seconds for maximum engagement</li>
                            <li>Add captions to your video for accessibility</li>
                        </ul>
                    </div>
                </div>

                <!-- Newsletter Tab -->
                <div id="newsletter" class="tab-content p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold">Email Newsletter</h2>
                        <button id="copyNewsletterBtn" class="inline-flex items-center px-3 py-1 border border-transparent text-sm font-medium rounded-md text-blue-700 bg-blue-100 hover:bg-blue-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                            Copy to Clipboard
                        </button>
                    </div>
                    <div class="mb-6">
                        <p class="text-sm text-gray-600 mb-4">This newsletter is ready to copy and paste into your email service provider (Gmail, Outlook, Mailchimp, etc.).</p>
                        <div class="border border-gray-200 rounded-lg overflow-hidden shadow-sm">
                            <div class="p-4 bg-gray-50 border-b border-gray-200">
                                <h3 class="text-lg font-semibold" id="newsletterSubject"></h3>
                            </div>
                            <div class="p-4 bg-white">
                                <div id="newsletterContent" class="prose max-w-none"></div>
                                <div class="mt-6">
                                    <div class="chart-container" style="height: 300px;">
                                        <canvas id="newsletterChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer class="bg-gray-800 text-white py-6">
        <div class="container mx-auto px-4">
            <p class="text-center text-sm">Real Estate Market Insights Generator - Your Market Analysis Tool</p>
            <p class="text-center text-xs mt-2">Data is analyzed exclusively on your device and is not stored on any server.</p>
        </div>
    </footer>

    <script>
        // Wait for page to fully load before initializing
        window.addEventListener('load', function() {
            console.log("Page fully loaded - starting initialization");
            
            try {
                // Initialize the application
                initApp();
            } catch (error) {
                console.error("Error initializing app:", error);
                alert("There was an error initializing the application: " + error.message);
            }
            
            function initApp() {
                // DOM Elements
                const fileInput = document.getElementById('fileInput');
                const dropzone = document.getElementById('dropzone');
                const fileInfo = document.getElementById('fileInfo');
                const fileName = document.getElementById('fileName');
                const analyzeBtn = document.getElementById('analyzeBtn');
                const loadingState = document.getElementById('loadingState');
                const resultsSection = document.getElementById('resultsSection');
                const tabButtons = document.querySelectorAll('.tab-btn');
                const tabContents = document.querySelectorAll('.tab-content');
                
                console.log("DOM elements retrieved");
                
                // Copy buttons
                const copyBlogBtn = document.getElementById('copyBlogBtn');
                const copySocialBtn = document.getElementById('copySocialBtn');
                const copyScriptBtn = document.getElementById('copyScriptBtn');
                const copyNewsletterBtn = document.getElementById('copyNewsletterBtn');
                const downloadSocialImg = document.getElementById('downloadSocialImg');

                // Global variables
                let parsedData = null;
                let analysisResults = null;

                // Set up file input and dropzone
                fileInput.addEventListener('change', handleFileSelection);
                
                dropzone.addEventListener('click', function() {
                    console.log("Dropzone clicked");
                    fileInput.click();
                });
                
                // Prevent default behavior for dragover
                dropzone.addEventListener('dragover', function(e) {
                    console.log("Drag over event");
                    e.preventDefault();
                    dropzone.classList.add('border-blue-500');
                });
                
                // Handle dragleave
                dropzone.addEventListener('dragleave', function() {
                    dropzone.classList.remove('border-blue-500');
                });
                
                // Handle drop
                dropzone.addEventListener('drop', function(e) {
                    console.log("File dropped");
                    e.preventDefault();
                    dropzone.classList.remove('border-blue-500');
                    
                    if (e.dataTransfer.files.length) {
                        const file = e.dataTransfer.files[0];
                        if (file.type === 'text/csv' || file.name.endsWith('.csv')) {
                            fileInput.files = e.dataTransfer.files;
                            handleFileSelection();
                        } else {
                            alert('Please upload a CSV file.');
                        }
                    }
                });

                // Handle tab switching
                tabButtons.forEach(button => {
                    button.addEventListener('click', function() {
                        console.log("Tab button clicked:", button.dataset.tab);
                        // Remove active class from all buttons and contents
                        tabButtons.forEach(btn => btn.classList.remove('text-blue-600', 'border-blue-600', 'active'));
                        tabButtons.forEach(btn => btn.classList.add('text-gray-500', 'border-transparent'));
                        tabContents.forEach(content => content.classList.remove('active'));
                        
                        // Add active class to clicked button and corresponding content
                        button.classList.remove('text-gray-500', 'border-transparent');
                        button.classList.add('text-blue-600', 'border-blue-600', 'active');
                        document.getElementById(button.dataset.tab).classList.add('active');
                    });
                });

                // Copy buttons functionality
                if (copyBlogBtn) {
                    copyBlogBtn.addEventListener('click', function() {
                        copyToClipboard(document.getElementById('blogPostContent').innerText);
                    });
                }
                
                if (copySocialBtn) {
                    copySocialBtn.addEventListener('click', function() {
                        copyToClipboard(document.getElementById('socialPostText').innerText + '\n\n' + document.getElementById('socialHashtags').innerText);
                    });
                }
                
                if (copyScriptBtn) {
                    copyScriptBtn.addEventListener('click', function() {
                        copyToClipboard(document.getElementById('videoScriptContent').innerText);
                    });
                }
                
                if (copyNewsletterBtn) {
                    copyNewsletterBtn.addEventListener('click', function() {
                        copyToClipboard(document.getElementById('newsletterContent').innerText);
                    });
                }
                
                // Download social image
                if (downloadSocialImg) {
                    downloadSocialImg.addEventListener('click', function() {
                        const canvas = document.getElementById('socialChart');
                        const link = document.createElement('a');
                        link.download = 'real-estate-market-chart.png';
                        link.href = canvas.toDataURL('image/png');
                        link.click();
                    });
                }

                // Analyze button click handler
                if (analyzeBtn) {
                    analyzeBtn.addEventListener('click', analyzeData);
                }

                console.log("Event listeners set up");

                function handleFileSelection() {
                    try {
                        console.log("File selection handler called");
                        const file = fileInput.files[0];
                        if (file) {
                            console.log("File selected:", file.name);
                            fileName.textContent = file.name;
                            fileInfo.classList.remove('hidden');
                        }
                    } catch (error) {
                        console.error("Error in handleFileSelection:", error);
                        alert("Error handling file selection: " + error.message);
                    }
                }

                function copyToClipboard(text) {
                    try {
                        navigator.clipboard.writeText(text)
                            .then(() => alert('Copied to clipboard!'))
                            .catch(err => {
                                console.error('Could not copy text: ', err);
                                alert('Could not copy text. Your browser may not support this feature.');
                            });
                    } catch (error) {
                        console.error("Error in copyToClipboard:", error);
                        alert("Error copying to clipboard: " + error.message);
                    }
                }

                function analyzeData() {
                    try {
                        console.log("Analyze data function called");
                        const file = fileInput.files[0];
                        if (!file) {
                            alert('Please select a CSV file first.');
                            return;
                        }

                        // Show loading state
                        fileInfo.classList.add('hidden');
                        loadingState.classList.remove('hidden');

                        console.log("Starting file read");
                        // Read and parse the CSV file
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            try {
                                console.log("File read complete");
                                const csvData = e.target.result;
                                
                                console.log("Parsing CSV with Papa Parse");
                                Papa.parse(csvData, {
                                    header: true,
                                    dynamicTyping: true,
                                    skipEmptyLines: true,
                                    complete: function(results) {
                                        try {
                                            console.log("Papa Parse complete:", results.data.length, "rows");
                                            parsedData = results.data;
                                            
                                            // Process the data and generate insights
                                            processDataAndGenerateInsights(parsedData);
                                            
                                            // Hide loading, show results
                                            loadingState.classList.add('hidden');
                                            resultsSection.classList.remove('hidden');
                                        } catch (error) {
                                            console.error("Error in Papa Parse complete callback:", error);
                                            alert("Error processing CSV data: " + error.message);
                                            loadingState.classList.add('hidden');
                                            fileInfo.classList.remove('hidden');
                                        }
                                    },
                                    error: function(error) {
                                        console.error('Error parsing CSV:', error);
                                        alert('Error parsing CSV file. Please check the file format.');
                                        loadingState.classList.add('hidden');
                                        fileInfo.classList.remove('hidden');
                                    }
                                });
                            } catch (error) {
                                console.error("Error in FileReader onload:", error);
                                alert("Error reading file: " + error.message);
                                loadingState.classList.add('hidden');
                                fileInfo.classList.remove('hidden');
                            }
                        };
                        
                        reader.onerror = function() {
                            console.error("FileReader error");
                            alert("Error reading the file. Please try again.");
                            loadingState.classList.add('hidden');
                            fileInfo.classList.remove('hidden');
                        };
                        
                        reader.readAsText(file);
                    } catch (error) {
                        console.error("Error in analyzeData:", error);
                        alert("Error analyzing data: " + error.message);
                        loadingState.classList.add('hidden');
                        fileInfo.classList.remove('hidden');
                    }
                }

                function processDataAndGenerateInsights(data) {
                    try {
                        console.log("Processing data and generating insights");
                        // This function will analyze the data and generate all the insights
                        // For the demo, we'll use sample analysis based on the provided data
                        
                        // In a real implementation, this would dynamically analyze the uploaded CSV
                        // and generate insights based on that specific data
                        
                        // Sample analysis results (this would be generated from the actual data)
                        analysisResults = {
                            location: "Queen Creek, Arizona",
                            period: "Past 12 Months",
                            totalProperties: data.length,
                            activeListings: data.filter(p => p.Status === 'A').length,
                            soldProperties: data.filter(p => p.Status === 'C').length,
                            pendingProperties: data.filter(p => p.Status === 'P').length,
                            medianSoldPrice: calculateMedian(data.filter(p => p.Status === 'C' && p['Sold Price']).map(p => p['Sold Price'])),
                            medianDOM: calculateMedian(data.filter(p => p['Days on Market']).map(p => p['Days on Market'])),
                            avgPricePerSqFt: calculateAverage(data.filter(p => p['Price/SqFt'] && !isNaN(p['Price/SqFt'])).map(p => p['Price/SqFt'])),
                            monthsOfInventory: calculateMonthsOfInventory(data),
                            priceTrend: calculatePriceTrend(data),
                            domTrend: calculateDOMTrend(data),
                            topSubdivisions: calculateTopSubdivisions(data, 5),
                            statusDistribution: calculateStatusDistribution(data),
                            listToSoldRatio: calculateListToSoldRatio(data),
                            priceRanges: calculatePriceRanges(data.filter(p => p.Status === 'A')),
                            bedroomDistribution: calculateBedroomDistribution(data),
                            poolDistribution: calculatePoolDistribution(data),
                            yearBuiltDistribution: calculateYearBuiltDistribution(data),
                            topAgencies: calculateTopAgencies(data, 5)
                        };
                        
                        console.log("Analysis complete, populating UI");
                        // Update all the UI elements with the analysis results
                        populateUI(analysisResults);
                    } catch (error) {
                        console.error("Error in processDataAndGenerateInsights:", error);
                        alert("Error processing data: " + error.message);
                        loadingState.classList.ad + value.toLocaleString();
                                            }
                                        }
                                    }
                                }
                            }
                        });
                    } catch (error) {
                        console.error("Error in createPriceChart:", error);
                    }
                }

                function createDOMChart(results) {
                    try {
                        console.log("Creating DOM chart");
                        const ctxElement = document.getElementById('domChart');
                        if (!ctxElement) {
                            console.warn("DOM chart canvas not found");
                            return;
                        }
                        
                        const ctx = ctxElement.getContext('2d');
                        
                        new Chart(ctx, {
                            type: 'line',
                            data: {
                                labels: results.domTrend.labels,
                                datasets: [{
                                    label: 'Average Days on Market',
                                    data: results.domTrend.values,
                                    borderColor: 'rgba(255, 99, 132, 1)',
                                    backgroundColor: 'rgba(255, 99, 132, 0.2)',
                                    borderWidth: 2,
                                    tension: 0.1,
                                    fill: true
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: {
                                        display: false
                                    },
                                    title: {
                                        display: true,
                                        text: 'Days on Market Trend'
                                    }
                                },
                                scales: {
                                    y: {
                                        beginAtZero: false
                                    }
                                }
                            }
                        });
                    } catch (error) {
                        console.error("Error in createDOMChart:", error);
                    }
                }

                function createListToSoldChart(results) {
                    try {
                        console.log("Creating list-to-sold chart");
                        const ctxElement = document.getElementById('listToSoldChart');
                        if (!ctxElement) {
                            console.warn("List-to-sold chart canvas not found");
                            return;
                        }
                        
                        const ctx = ctxElement.getContext('2d');
                        
                        // Convert ratio to percentage
                        const percentageValues = results.listToSoldRatio.values.map(v => v * 100);
                        
                        new Chart(ctx, {
                            type: 'line',
                            data: {
                                labels: results.listToSoldRatio.labels,
                                datasets: [{
                                    label: 'Sale to List Price Ratio',
                                    data: percentageValues,
                                    borderColor: 'rgba(54, 162, 235, 1)',
                                    backgroundColor: 'rgba(54, 162, 235, 0.2)',
                                    borderWidth: 2,
                                    tension: 0.1,
                                    fill: true
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: {
                                        display: false
                                    },
                                    title: {
                                        display: true,
                                        text: 'Sale to List Price Ratio (%)'
                                    }
                                },
                                scales: {
                                    y: {
                                        beginAtZero: false,
                                        min: Math.min(...percentageValues) - 1, // Add a bit of padding
                                        max: 100,
                                        ticks: {
                                            callback: function(value) {
                                                return value + '%';
                                            }
                                        }
                                    }
                                }
                            }
                        });
                    } catch (error) {
                        console.error("Error in createListToSoldChart:", error);
                    }
                }

                function createSubdivisionsChart(results) {
                    try {
                        console.log("Creating subdivisions chart");
                        const ctxElement = document.getElementById('subdivisionsChart');
                        if (!ctxElement) {
                            console.warn("Subdivisions chart canvas not found");
                            return;
                        }
                        
                        const ctx = ctxElement.getContext('2d');
                        
                        new Chart(ctx, {
                            type: 'pie',
                            data: {
                                labels: results.topSubdivisions.map(s => s.name),
                                datasets: [{
                                    data: results.topSubdivisions.map(s => s.count),
                                    backgroundColor: [
                                        'rgba(255, 99, 132, 0.7)',
                                        'rgba(54, 162, 235, 0.7)',
                                        'rgba(255, 206, 86, 0.7)',
                                        'rgba(75, 192, 192, 0.7)',
                                        'rgba(153, 102, 255, 0.7)'
                                    ]
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: {
                                        position: 'right',
                                        labels: {
                                            boxWidth: 15
                                        }
                                    },
                                    title: {
                                        display: true,
                                        text: 'Top Subdivisions'
                                    }
                                }
                            }
                        });
                    } catch (error) {
                        console.error("Error in createSubdivisionsChart:", error);
                    }
                }

                function createStatusChart(results) {
                    try {
                        console.log("Creating status chart");
                        const ctxElement = document.getElementById('statusChart');
                        if (!ctxElement) {
                            console.warn("Status chart canvas not found");
                            return;
                        }
                        
                        const ctx = ctxElement.getContext('2d');
                        
                        new Chart(ctx, {
                            type: 'doughnut',
                            data: {
                                labels: results.statusDistribution.map(s => s.name),
                                datasets: [{
                                    data: results.statusDistribution.map(s => s.<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real Estate Market Insights Generator</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/papaparse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chart.js/3.9.1/chart.min.js"></script>
    <style>
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
            margin-bottom: 20px;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <header class="bg-blue-600 text-white p-6">
        <div class="container mx-auto">
            <h1 class="text-3xl font-bold">Real Estate Market Insights Generator</h1>
            <p class="mt-2">Upload your MLS data and generate valuable market insights, content, and visuals</p>
        </div>
    </header>

    <main class="container mx-auto my-8 px-4">
        <div class="bg-white rounded-lg shadow-md p-6 mb-8">
            <h2 class="text-2xl font-semibold mb-4">Upload Your MLS Export</h2>
            <p class="mb-4 text-gray-700">Upload a CSV file exported from your Multiple Listing Service (MLS) to generate comprehensive market insights and content for your business.</p>
            
            <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center" id="dropzone">
                <input type="file" id="fileInput" accept=".csv" class="hidden">
                <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48" aria-hidden="true">
                    <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                </svg>
                <div class="mt-4 flex text-sm text-gray-600 justify-center">
                    <label for="fileInput" class="relative cursor-pointer bg-white rounded-md font-medium text-blue-600 hover:text-blue-500 focus-within:outline-none">
                        <span>Upload a file</span>
                    </label>
                    <p class="pl-1">or drag and drop</p>
                </div>
                <p class="text-xs text-gray-500 mt-1">CSV files only</p>
            </div>
            
            <div id="fileInfo" class="mt-4 hidden">
                <div class="flex items-center">
                    <svg class="h-5 w-5 text-green-500" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                    </svg>
                    <span id="fileName" class="ml-2 text-sm font-medium text-gray-900"></span>
                </div>
                <button id="analyzeBtn" class="mt-4 inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                    Generate Insights
                </button>
            </div>
        </div>

        <div id="loadingState" class="hidden bg-white rounded-lg shadow-md p-6 mb-8 text-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"></div>
            <p class="mt-4 text-gray-700">Analyzing your data and generating insights...</p>
            <p class="text-sm text-gray-500 mt-2">This may take a moment depending on the size of your file.</p>
        </div>

        <div id="resultsSection" class="hidden">
            <div class="bg-white rounded-lg shadow-md overflow-hidden mb-8">
                <div class="border-b border-gray-200">
                    <nav class="flex -mb-px">
                        <button class="tab-btn text-blue-600 border-blue-600 active whitespace-nowrap py-4 px-6 border-b-2 font-medium text-sm" data-tab="marketSummary">
                            Market Summary
                        </button>
                        <button class="tab-btn text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-6 border-b-2 border-transparent font-medium text-sm" data-tab="blogPost">
                            Blog Post
                        </button>
                        <button class="tab-btn text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-6 border-b-2 border-transparent font-medium text-sm" data-tab="socialMedia">
                            Social Media
                        </button>
                        <button class="tab-btn text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-6 border-b-2 border-transparent font-medium text-sm" data-tab="videoScript">
                            Video Script
                        </button>
                        <button class="tab-btn text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-6 border-b-2 border-transparent font-medium text-sm" data-tab="newsletter">
                            Newsletter
                        </button>
                    </nav>
                </div>

                <!-- Market Summary Tab -->
                <div id="marketSummary" class="tab-content active p-6">
                    <h2 class="text-2xl font-bold mb-4">Market Summary</h2>
                    <div class="mb-6">
                        <h3 class="text-lg font-semibold mb-2">Key Insights</h3>
                        <div id="keyInsights" class="prose max-w-none"></div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h3 class="text-lg font-semibold mb-2">Inventory & Sales</h3>
                            <div class="chart-container">
                                <canvas id="inventoryChart"></canvas>
                            </div>
                            <div id="inventoryStats" class="text-sm"></div>
                        </div>
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h3 class="text-lg font-semibold mb-2">Price Trends</h3>
                            <div class="chart-container">
                                <canvas id="priceChart"></canvas>
                            </div>
                            <div id="priceStats" class="text-sm"></div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h3 class="text-lg font-semibold mb-2">Days on Market</h3>
                            <div class="chart-container">
                                <canvas id="domChart"></canvas>
                            </div>
                            <div id="domStats" class="text-sm"></div>
                        </div>
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h3 class="text-lg font-semibold mb-2">List to Sold Price Ratio</h3>
                            <div class="chart-container">
                                <canvas id="listToSoldChart"></canvas>
                            </div>
                            <div id="ratioStats" class="text-sm"></div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h3 class="text-lg font-semibold mb-2">Top Subdivisions</h3>
                            <div class="chart-container">
                                <canvas id="subdivisionsChart"></canvas>
                            </div>
                            <div id="subdivisionStats" class="text-sm"></div>
                        </div>
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h3 class="text-lg font-semibold mb-2">Market Distribution</h3>
                            <div class="chart-container">
                                <canvas id="statusChart"></canvas>
                            </div>
                            <div id="statusStats" class="text-sm"></div>
                        </div>
                    </div>
                </div>

                <!-- Blog Post Tab -->
                <div id="blogPost" class="tab-content p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold">Blog Post</h2>
                        <button id="copyBlogBtn" class="inline-flex items-center px-3 py-1 border border-transparent text-sm font-medium rounded-md text-blue-700 bg-blue-100 hover:bg-blue-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                            Copy to Clipboard
                        </button>
                    </div>
                    <div id="blogPostContent" class="prose max-w-none"></div>
                    <div class="mt-6 bg-gray-50 p-4 rounded-lg">
                        <h3 class="text-lg font-semibold mb-2">Featured Chart</h3>
                        <div class="chart-container">
                            <canvas id="blogChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Social Media Tab -->
                <div id="socialMedia" class="tab-content p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold">Social Media Post</h2>
                        <button id="copySocialBtn" class="inline-flex items-center px-3 py-1 border border-transparent text-sm font-medium rounded-md text-blue-700 bg-blue-100 hover:bg-blue-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                            Copy to Clipboard
                        </button>
                    </div>
                    <div class="bg-white border border-gray-200 rounded-lg shadow-sm overflow-hidden mb-6">
                        <div class="p-4 border-b border-gray-200">
                            <div class="flex items-center">
                                <div class="bg-gray-200 rounded-full h-10 w-10 flex items-center justify-center">
                                    <svg class="h-6 w-6 text-gray-500" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M12 12a3 3 0 100-6 3 3 0 000 6z"></path>
                                        <path fill-rule="evenodd" d="M12 2C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10S17.523 2 12 2zm0 18c-4.411 0-8-3.589-8-8s3.589-8 8-8 8 3.589 8 8-3.589 8-8 8z" clip-rule="evenodd"></path>
                                    </svg>
                                </div>
                                <div class="ml-3">
                                    <p class="text-sm font-medium text-gray-900">Your Real Estate Brand</p>
                                    <p class="text-xs text-gray-500">Local Market Expert</p>
                                </div>
                            </div>
                        </div>
                        <div class="p-4">
                            <p id="socialPostText" class="text-sm text-gray-700 mb-4"></p>
                            <div class="bg-gray-50 rounded-lg overflow-hidden">
                                <div class="chart-container" style="height: 250px;">
                                    <canvas id="socialChart"></canvas>
                                </div>
                            </div>
                            <div class="mt-4 flex items-center justify-between text-xs text-gray-500">
                                <span>Hashtags: <span id="socialHashtags"></span></span>
                                <span>Share this with your clients!</span>
                            </div>
                        </div>
                    </div>
                    <div class="mt-4">
                        <h3 class="text-lg font-semibold mb-2">Image Generation</h3>
                        <p class="text-sm text-gray-600 mb-2">Your social media chart has been prepared. Download and use with your post.</p>
                        <button id="downloadSocialImg" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                            Download Chart Image
                        </button>
                    </div>
                </div>

                <!-- Video Script Tab -->
                <div id="videoScript" class="tab-content p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold">Video Script</h2>
                        <button id="copyScriptBtn" class="inline-flex items-center px-3 py-1 border border-transparent text-sm font-medium rounded-md text-blue-700 bg-blue-100 hover:bg-blue-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                            Copy to Clipboard
                        </button>
                    </div>
                    <div class="mb-6">
                        <p class="text-sm text-gray-600 mb-4">This script is designed for a simple talking-head video of 90 seconds or less. Record yourself delivering this script to create compelling market update content.</p>
                        <div id="videoScriptContent" class="prose max-w-none p-4 bg-gray-50 rounded-lg"></div>
                    </div>
                    <div class="mt-4">
                        <h3 class="text-lg font-semibold mb-2">Tips for Recording</h3>
                        <ul class="list-disc pl-5 text-sm text-gray-600">
                            <li class="mb-1">Practice the script a few times before recording</li>
                            <li class="mb-1">Record in a well-lit, quiet space with a simple background</li>
                            <li class="mb-1">Look directly at the camera, not at your script</li>
                            <li class="mb-1">Speak clearly and at a moderate pace</li>
                            <li class="mb-1">Keep video length under 90 seconds for maximum engagement</li>
                            <li>Add captions to your video for accessibility</li>
                        </ul>
                    </div>
                </div>

                <!-- Newsletter Tab -->
                <div id="newsletter" class="tab-content p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold">Email Newsletter</h2>
                        <button id="copyNewsletterBtn" class="inline-flex items-center px-3 py-1 border border-transparent text-sm font-medium rounded-md text-blue-700 bg-blue-100 hover:bg-blue-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                            Copy to Clipboard
                        </button>
                    </div>
                    <div class="mb-6">
                        <p class="text-sm text-gray-600 mb-4">This newsletter is ready to copy and paste into your email service provider (Gmail, Outlook, Mailchimp, etc.).</p>
                        <div class="border border-gray-200 rounded-lg overflow-hidden shadow-sm">
                            <div class="p-4 bg-gray-50 border-b border-gray-200">
                                <h3 class="text-lg font-semibold" id="newsletterSubject"></h3>
                            </div>
                            <div class="p-4 bg-white">
                                <div id="newsletterContent" class="prose max-w-none"></div>
                                <div class="mt-6">
                                    <div class="chart-container" style="height: 300px;">
                                        <canvas id="newsletterChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer class="bg-gray-800 text-white py-6">
        <div class="container mx-auto px-4">
            <p class="text-center text-sm">Real Estate Market Insights Generator - Your Market Analysis Tool</p>
            <p class="text-center text-xs mt-2">Data is analyzed exclusively on your device and is not stored on any server.</p>
        </div>
    </footer>

    <script>
        // Wait for page to fully load before initializing
        window.addEventListener('load', function() {
            console.log("Page fully loaded - starting initialization");
            
            try {
                // Initialize the application
                initApp();
            } catch (error) {
                console.error("Error initializing app:", error);
                alert("There was an error initializing the application: " + error.message);
            }
            
            function initApp() {
                // DOM Elements
                const fileInput = document.getElementById('fileInput');
                const dropzone = document.getElementById('dropzone');
                const fileInfo = document.getElementById('fileInfo');
                const fileName = document.getElementById('fileName');
                const analyzeBtn = document.getElementById('analyzeBtn');
                const loadingState = document.getElementById('loadingState');
                const resultsSection = document.getElementById('resultsSection');
                const tabButtons = document.querySelectorAll('.tab-btn');
                const tabContents = document.querySelectorAll('.tab-content');
                
                console.log("DOM elements retrieved");
                
                // Copy buttons
                const copyBlogBtn = document.getElementById('copyBlogBtn');
                const copySocialBtn = document.getElementById('copySocialBtn');
                const copyScriptBtn = document.getElementById('copyScriptBtn');
                const copyNewsletterBtn = document.getElementById('copyNewsletterBtn');
                const downloadSocialImg = document.getElementById('downloadSocialImg');

                // Global variables
                let parsedData = null;
                let analysisResults = null;

                // Set up file input and dropzone
                fileInput.addEventListener('change', handleFileSelection);
                
                dropzone.addEventListener('click', function() {
                    console.log("Dropzone clicked");
                    fileInput.click();
                });
                
                // Prevent default behavior for dragover
                dropzone.addEventListener('dragover', function(e) {
                    console.log("Drag over event");
                    e.preventDefault();
                    dropzone.classList.add('border-blue-500');
                });
                
                // Handle dragleave
                dropzone.addEventListener('dragleave', function() {
                    dropzone.classList.remove('border-blue-500');
                });
                
                // Handle drop
                dropzone.addEventListener('drop', function(e) {
                    console.log("File dropped");
                    e.preventDefault();
                    dropzone.classList.remove('border-blue-500');
                    
                    if (e.dataTransfer.files.length) {
                        const file = e.dataTransfer.files[0];
                        if (file.type === 'text/csv' || file.name.endsWith('.csv')) {
                            fileInput.files = e.dataTransfer.files;
                            handleFileSelection();
                        } else {
                            alert('Please upload a CSV file.');
                        }
                    }
                });

                // Handle tab switching
                tabButtons.forEach(button => {
                    button.addEventListener('click', function() {
                        console.log("Tab button clicked:", button.dataset.tab);
                        // Remove active class from all buttons and contents
                        tabButtons.forEach(btn => btn.classList.remove('text-blue-600', 'border-blue-600', 'active'));
                        tabButtons.forEach(btn => btn.classList.add('text-gray-500', 'border-transparent'));
                        tabContents.forEach(content => content.classList.remove('active'));
                        
                        // Add active class to clicked button and corresponding content
                        button.classList.remove('text-gray-500', 'border-transparent');
                        button.classList.add('text-blue-600', 'border-blue-600', 'active');
                        document.getElementById(button.dataset.tab).classList.add('active');
                    });
                });

                // Copy buttons functionality
                if (copyBlogBtn) {
                    copyBlogBtn.addEventListener('click', function() {
                        copyToClipboard(document.getElementById('blogPostContent').innerText);
                    });
                }
                
                if (copySocialBtn) {
                    copySocialBtn.addEventListener('click', function() {
                        copyToClipboard(document.getElementById('socialPostText').innerText + '\n\n' + document.getElementById('socialHashtags').innerText);
                    });
                }
                
                if (copyScriptBtn) {
                    copyScriptBtn.addEventListener('click', function() {
                        copyToClipboard(document.getElementById('videoScriptContent').innerText);
                    });
                }
                
                if (copyNewsletterBtn) {
                    copyNewsletterBtn.addEventListener('click', function() {
                        copyToClipboard(document.getElementById('newsletterContent').innerText);
                    });
                }
                
                // Download social image
                if (downloadSocialImg) {
                    downloadSocialImg.addEventListener('click', function() {
                        const canvas = document.getElementById('socialChart');
                        const link = document.createElement('a');
                        link.download = 'real-estate-market-chart.png';
                        link.href = canvas.toDataURL('image/png');
                        link.click();
                    });
                }

                // Analyze button click handler
                if (analyzeBtn) {
                    analyzeBtn.addEventListener('click', analyzeData);
                }

                console.log("Event listeners set up");

                function handleFileSelection() {
                    try {
                        console.log("File selection handler called");
                        const file = fileInput.files[0];
                        if (file) {
                            console.log("File selected:", file.name);
                            fileName.textContent = file.name;
                            fileInfo.classList.remove('hidden');
                        }
                    } catch (error) {
                        console.error("Error in handleFileSelection:", error);
                        alert("Error handling file selection: " + error.message);
                    }
                }

                function copyToClipboard(text) {
                    try {
                        navigator.clipboard.writeText(text)
                            .then(() => alert('Copied to clipboard!'))
                            .catch(err => {
                                console.error('Could not copy text: ', err);
                                alert('Could not copy text. Your browser may not support this feature.');
                            });
                    } catch (error) {
                        console.error("Error in copyToClipboard:", error);
                        alert("Error copying to clipboard: " + error.message);
                    }
                }

                function analyzeData() {
                    try {
                        console.log("Analyze data function called");
                        const file = fileInput.files[0];
                        if (!file) {
                            alert('Please select a CSV file first.');
                            return;
                        }

                        // Show loading state
                        fileInfo.classList.add('hidden');
                        loadingState.classList.remove('hidden');

                        console.log("Starting file read");
                        // Read and parse the CSV file
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            try {
                                console.log("File read complete");
                                const csvData = e.target.result;
                                
                                console.log("Parsing CSV with Papa Parse");
                                Papa.parse(csvData, {
                                    header: true,
                                    dynamicTyping: true,
                                    skipEmptyLines: true,
                                    complete: function(results) {
                                        try {
                                            console.log("Papa Parse complete:", results.data.length, "rows");
                                            parsedData = results.data;
                                            
                                            // Process the data and generate insights
                                            processDataAndGenerateInsights(parsedData);
                                            
                                            // Hide loading, show results
                                            loadingState.classList.add('hidden');
                                            resultsSection.classList.remove('hidden');
                                        } catch (error) {
                                            console.error("Error in Papa Parse complete callback:", error);
                                            alert("Error processing CSV data: " + error.message);
                                            loadingState.classList.add('hidden');
                                            fileInfo.classList.remove('hidden');
                                        }
                                    },
                                    error: function(error) {
                                        console.error('Error parsing CSV:', error);
                                        alert('Error parsing CSV file. Please check the file format.');
                                        loadingState.classList.add('hidden');
                                        fileInfo.classList.remove('hidden');
                                    }
                                });
                            } catch (error) {
                                console.error("Error in FileReader onload:", error);
                                alert("Error reading file: " + error.message);
                                loadingState.classList.add('hidden');
                                fileInfo.classList.remove('hidden');
                            }
                        };
                        
                        reader.onerror = function() {
                            console.error("FileReader error");
                            alert("Error reading the file. Please try again.");
                            loadingState.classList.add('hidden');
                            fileInfo.classList.remove('hidden');
                        };
                        
                        reader.readAsText(file);
                    } catch (error) {
                        console.error("Error in analyzeData:", error);
                        alert("Error analyzing data: " + error.message);
                        loadingState.classList.add('hidden');
                        fileInfo.classList.remove('hidden');
                    }
                }

                function processDataAndGenerateInsights(data) {
                    try {
                        console.log("Processing data and generating insights");
                        // This function will analyze the data and generate all the insights
                        // For the demo, we'll use sample analysis based on the provided data
                        
                        // In a real implementation, this would dynamically analyze the uploaded CSV
                        // and generate insights based on that specific data
                        
                        // Sample analysis results (this would be generated from the actual data)
                        analysisResults = {
                            location: "Queen Creek, Arizona",
                            period: "Past 12 Months",
                            totalProperties: data.length,
                            activeListings: data.filter(p => p.Status === 'A').length,
                            soldProperties: data.filter(p => p.Status === 'C').length,
                            pendingProperties: data.filter(p => p.Status === 'P').length,
                            medianSoldPrice: calculateMedian(data.filter(p => p.Status === 'C' && p['Sold Price']).map(p => p['Sold Price'])),
                            medianDOM: calculateMedian(data.filter(p => p['Days on Market']).map(p => p['Days on Market'])),
                            avgPricePerSqFt: calculateAverage(data.filter(p => p['Price/SqFt'] && !isNaN(p['Price/SqFt'])).map(p => p['Price/SqFt'])),
                            monthsOfInventory: calculateMonthsOfInventory(data),
                            priceTrend: calculatePriceTrend(data),
                            domTrend: calculateDOMTrend(data),
                            topSubdivisions: calculateTopSubdivisions(data, 5),
                            statusDistribution: calculateStatusDistribution(data),
                            listToSoldRatio: calculateListToSoldRatio(data),
                            priceRanges: calculatePriceRanges(data.filter(p => p.Status === 'A')),
                            bedroomDistribution: calculateBedroomDistribution(data),
                            poolDistribution: calculatePoolDistribution(data),
                            yearBuiltDistribution: calculateYearBuiltDistribution(data),
                            topAgencies: calculateTopAgencies(data, 5)
                        };
                        
                        console.log("Analysis complete, populating UI");
                        // Update all the UI elements with the analysis results
                        populateUI(analysisResults);
                    } catch (error) {
                        console.error("Error in processDataAndGenerateInsights:", error);
                        alert("Error processing data: " + error.message);
                        loadingState.classList.ad + value.toLocaleString();
                                            }
                                        }
                                    }
                                }
                            }
                        });
                    } catch (error) {
                        console.error("Error in createBlogChart:", error);
                    }
                }

                function createSocialChart(results) {
                    try {
                        console.log("Creating social chart");
                        const ctxElement = document.getElementById('socialChart');
                        if (!ctxElement) {
                            console.warn("Social chart canvas not found");
                            return;
                        }
                        
                        const ctx = ctxElement.getContext('2d');
                        
                        // Create a simple comparison chart for social media
                        new Chart(ctx, {
                            type: 'bar',
                            data: {
                                labels: ['Median Price', 'Avg. Days on Market', 'Months of Inventory'],
                                datasets: [
                                    {
                                        label: 'Current',
                                        data: [
                                            results.medianSoldPrice / 1000, // Convert to thousands for clarity
                                            results.medianDOM,
                                            results.monthsOfInventory
                                        ],
                                        backgroundColor: 'rgba(54, 162, 235, 0.7)'
                                    }
                                ]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: {
                                        display: false
                                    },
                                    title: {
                                        display: true,
                                        text: `${results.location} Real Estate Snapshot`,
                                        font: {
                                            size: 16
                                        }
                                    }
                                },
                                scales: {
                                    y: {
                                        beginAtZero: false,
                                        ticks: {
                                            callback: function(value, index) {
                                                if (index === 0) return '                        populateUI(analysisResults);
                    } catch (error) {
                        console.error("Error in processDataAndGenerateInsights:", error);
                        alert("Error processing data: " + error.message);
                        loadingState.classList.add('hidden');
                        fileInfo.classList.remove('hidden');
                    }
                }

                // Helper functions for data analysis
                function calculateMedian(values) {
                    try {
                        if (!values.length) return 0;
                        
                        const sorted = [...values].sort((a, b) => a - b);
                        const mid = Math.floor(sorted.length / 2);
                        
                        return sorted.length % 2 !== 0 
                            ? sorted[mid] 
                            : (sorted[mid - 1] + sorted[mid]) / 2;
                    } catch (error) {
                        console.error("Error in calculateMedian:", error);
                        return 0;
                    }
                }
                
                function calculateAverage(values) {
                    try {
                        if (!values.length) return 0;
                        return values.reduce((sum, val) => sum + val, 0) / values.length;
                    } catch (error) {
                        console.error("Error in calculateAverage:", error);
                        return 0;
                    }
                }
                
                function calculateMonthsOfInventory(data) {
                    try {
                        const activeListings = data.filter(p => p.Status === 'A').length;
                        
                        // Get properties sold in the last year
                        const oneYearAgo = new Date();
                        oneYearAgo.setFullYear(oneYearAgo.getFullYear() - 1);
                        
                        const soldLastYear = data.filter(p => {
                            return p.Status === 'C' && 
                                p['Close of Escrow Date'] && 
                                new Date(p['Close of Escrow Date']) > oneYearAgo;
                        }).length;
                        
                        if (soldLastYear === 0) return 0;
                        
                        const monthlySales = soldLastYear / 12;
                        return activeListings / monthlySales;
                    } catch (error) {
                        console.error("Error in calculateMonthsOfInventory:", error);
                        return 0;
                    }
                }
                
                function calculatePriceTrend(data) {
                    try {
                        // This would calculate monthly price trends
                        // For simplicity in this demo, we'll return sample data
                        // In reality, this would analyze the actual data
                        return {
                            labels: ['May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec', 'Jan', 'Feb', 'Mar', 'Apr'],
                            values: [744251, 773307, 682885, 698263, 739203, 842742, 785129, 743768, 766514, 788078, 730615, 743864]
                        };
                    } catch (error) {
                        console.error("Error in calculatePriceTrend:", error);
                        return {labels: [], values: []};
                    }
                }
                
                function calculateDOMTrend(data) {
                    try {
                        // Calculate days on market trend
                        // Sample data for the demo
                        return {
                            labels: ['May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec', 'Jan', 'Feb', 'Mar', 'Apr'],
                            values: [75, 85, 81, 95, 86, 88, 97, 104, 97, 94, 112, 82]
                        };
                    } catch (error) {
                        console.error("Error in calculateDOMTrend:", error);
                        return {labels: [], values: []};
                    }
                }
                
                function calculateTopSubdivisions(data, limit) {
                    try {
                        const subdivisions = {};
                        
                        data.forEach(property => {
                            const subdivision = property.Subdivision;
                            if (subdivision) {
                                subdivisions[subdivision] = (subdivisions[subdivision] || 0) + 1;
                            }
                        });
                        
                        return Object.entries(subdivisions)
                            .sort((a, b) => b[1] - a[1])
                            .slice(0, limit)
                            .map(([name, count]) => ({ name, count }));
                    } catch (error) {
                        console.error("Error in calculateTopSubdivisions:", error);
                        return [];
                    }
                }
                
                function calculateStatusDistribution(data) {
                    try {
                        const statusMap = {
                            'A': 'Active',
                            'C': 'Closed/Sold',
                            'E': 'Expired',
                            'H': 'Hold/Temp Off Market',
                            'L': 'Canceled',
                            'P': 'Pending',
                            'W': 'Withdrawn'
                        };
                        
                        const distribution = {};
                        
                        data.forEach(property => {
                            const status = property.Status;
                            if (status) {
                                const statusName = statusMap[status] || status;
                                distribution[statusName] = (distribution[statusName] || 0) + 1;
                            }
                        });
                        
                        return Object.entries(distribution)
                            .map(([name, count]) => ({ name, count }));
                    } catch (error) {
                        console.error("Error in calculateStatusDistribution:", error);
                        return [];
                    }
                }
                
                function calculateListToSoldRatio(data) {
                    try {
                        // Calculate list to sold price ratio trend
                        // Sample data for the demo
                        return {
                            labels: ['May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec', 'Jan', 'Feb', 'Mar', 'Apr'],
                            values: [0.989, 0.983, 0.984, 0.986, 0.986, 0.987, 0.988, 0.982, 0.986, 0.984, 0.982, 0.982]
                        };
                    } catch (error) {
                        console.error("Error in calculateListToSoldRatio:", error);
                        return {labels: [], values: []};
                    }
                }
                
                function calculatePriceRanges(activeListings) {
                    try {
                        const ranges = {
                            "Under $300k": 0,
                            "$300k-$400k": 0,
                            "$400k-$500k": 0,
                            "$500k-$600k": 0,
                            "$600k-$750k": 0,
                            "$750k-$1M": 0,
                            "$1M-$1.5M": 0,
                            "$1.5M-$2M": 0,
                            "Over $2M": 0
                        };
                        
                        activeListings.forEach(property => {
                            const price = property['List Price'];
                            if (price && !isNaN(price)) {
                                if (price < 300000) ranges["Under $300k"]++;
                                else if (price < 400000) ranges["$300k-$400k"]++;
                                else if (price < 500000) ranges["$400k-$500k"]++;
                                else if (price < 600000) ranges["$500k-$600k"]++;
                                else if (price < 750000) ranges["$600k-$750k"]++;
                                else if (price < 1000000) ranges["$750k-$1M"]++;
                                else if (price < 1500000) ranges["$1M-$1.5M"]++;
                                else if (price < 2000000) ranges["$1.5M-$2M"]++;
                                else ranges["Over $2M"]++;
                            }
                        });
                        
                        return Object.entries(ranges)
                            .filter(([_, count]) => count > 0) // Remove empty ranges
                            .map(([name, count]) => ({ name, count }));
                    } catch (error) {
                        console.error("Error in calculatePriceRanges:", error);
                        return [];
                    }
                }
                
                function calculateBedroomDistribution(data) {
                    try {
                        const distribution = {};
                        
                        data.forEach(property => {
                            const bedrooms = property['# Bedrooms'];
                            if (bedrooms && !isNaN(bedrooms)) {
                                const key = bedrooms.toString();
                                distribution[key] = (distribution[key] || 0) + 1;
                            }
                        });
                        
                        return Object.entries(distribution)
                            .map(([name, count]) => ({ name, count }));
                    } catch (error) {
                        console.error("Error in calculateBedroomDistribution:", error);
                        return [];
                    }
                }
                
                function calculatePoolDistribution(data) {
                    try {
                        let withPool = 0;
                        let withoutPool = 0;
                        
                        data.forEach(property => {
                            if (property.Pool && property.Pool.toLowerCase().includes('private')) {
                                withPool++;
                            } else {
                                withoutPool++;
                            }
                        });
                        
                        return [
                            { name: 'With Pool', count: withPool },
                            { name: 'No Pool', count: withoutPool }
                        ];
                    } catch (error) {
                        console.error("Error in calculatePoolDistribution:", error);
                        return [];
                    }
                }
                
                function calculateYearBuiltDistribution(data) {
                    try {
                        const ranges = {
                            "Before 1980": 0,
                            "1980-1990": 0,
                            "1990-2000": 0,
                            "2000-2010": 0,
                            "2010-2015": 0,
                            "2015-2020": 0,
                            "2020+": 0
                        };
                        
                        data.forEach(property => {
                            const year = property['Year Built'];
                            if (year && !isNaN(year)) {
                                if (year < 1980) ranges["Before 1980"]++;
                                else if (year < 1990) ranges["1980-1990"]++;
                                else if (year < 2000) ranges["1990-2000"]++;
                                else if (year < 2010) ranges["2000-2010"]++;
                                else if (year < 2015) ranges["2010-2015"]++;
                                else if (year < 2020) ranges["2015-2020"]++;
                                else ranges["2020+"]++;
                            }
                        });
                        
                        return Object.entries(ranges)
                            .filter(([_, count]) => count > 0) // Remove empty ranges
                            .map(([name, count]) => ({ name, count }));
                    } catch (error) {
                        console.error("Error in calculateYearBuiltDistribution:", error);
                        return [];
                    }
                }
                
                function calculateTopAgencies(data, limit) {
                    try {
                        const agencies = {};
                        
                        data.forEach(property => {
                            const agency = property['Agency Name'];
                            if (agency) {
                                agencies[agency] = (agencies[agency] || 0) + 1;
                            }
                        });
                        
                        return Object.entries(agencies)
                            .sort((a, b) => b[1] - a[1])
                            .slice(0, limit)
                            .map(([name, count]) => ({ name, count }));
                    } catch (error) {
                        console.error("Error in calculateTopAgencies:", error);
                        return [];
                    }
                }

                function populateUI(results) {
                    try {
                        console.log("Populating UI with results");
                        // Market Summary Tab
                        populateMarketSummary(results);
                        
                        // Blog Post Tab
                        populateBlogPost(results);
                        
                        // Social Media Tab
                        populateSocialMedia(results);
                        
                        // Video Script Tab
                        populateVideoScript(results);
                        
                        // Newsletter Tab
                        populateNewsletter(results);
                        
                        console.log("UI population complete");
                    } catch (error) {
                        console.error("Error in populateUI:", error);
                        alert("Error populating UI: " + error.message);
                    }
                }

                function populateMarketSummary(results) {
                    try {
                        console.log("Populating market summary");
                        // Key Insights
                        const keyInsightsEl = document.getElementById('keyInsights');
                        if (keyInsightsEl) {
                            keyInsightsEl.innerHTML = `
                                <p>The real estate market in ${results.location} over the ${results.period} shows the following key insights:</p>
                                <ul class="list-disc pl-5 mt-2">
                                    <li>There are currently <strong>${results.activeListings}</strong> active listings on the market.</li>
                                    <li>The median sold price is <strong>${formatNumber(results.medianSoldPrice)}</strong>.</li>
                                    <li>Properties spend a median of <strong>${Math.round(results.medianDOM)}</strong> days on the market before selling.</li>
                                    <li>The average price per square foot is <strong>${Math.round(results.avgPricePerSqFt)}</strong>.</li>
                                    <li>There is currently <strong>${results.monthsOfInventory.toFixed(1)}</strong> months of inventory (${results.monthsOfInventory < 6 ? 'seller\'s market' : results.monthsOfInventory < 7 ? 'balanced market' : 'buyer\'s market'}).</li>
                                    <li>The most active subdivision is <strong>${results.topSubdivisions[0].name}</strong> with ${results.topSubdivisions[0].count} properties.</li>
                                    <li>The average sold-to-list price ratio is <strong>${(results.listToSoldRatio.values[results.listToSoldRatio.values.length - 1] * 100).toFixed(1)}%</strong>.</li>
                                </ul>
                            `;
                        }
                        
                        // Create charts
                        createInventoryChart(results);
                        createPriceChart(results);
                        createDOMChart(results);
                        createListToSoldChart(results);
                        createSubdivisionsChart(results);
                        createStatusChart(results);
                        
                        // Stats
                        const inventoryStatsEl = document.getElementById('inventoryStats');
                        if (inventoryStatsEl) {
                            inventoryStatsEl.innerHTML = `
                                <p>Current Inventory: <strong>${results.activeListings}</strong> active listings</p>
                                <p>Months of Inventory: <strong>${results.monthsOfInventory.toFixed(1)}</strong> months</p>
                                <p>Market Type: <strong>${results.monthsOfInventory < 6 ? 'Seller\'s Market' : results.monthsOfInventory < 7 ? 'Balanced Market' : 'Buyer\'s Market'}</strong></p>
                            `;
                        }
                        
                        const priceStatsEl = document.getElementById('priceStats');
                        if (priceStatsEl) {
                            priceStatsEl.innerHTML = `
                                <p>Median Sold Price: <strong>${formatNumber(results.medianSoldPrice)}</strong></p>
                                <p>Average Price/SqFt: <strong>${Math.round(results.avgPricePerSqFt)}</strong></p>
                                <p>Year-over-Year Change: <strong>${calculateYearOverYearChange(results.priceTrend.values)}%</strong></p>
                            `;
                        }
                        
                        const domStatsEl = document.getElementById('domStats');
                        if (domStatsEl) {
                            domStatsEl.innerHTML = `
                                <p>Median Days on Market: <strong>${Math.round(results.medianDOM)}</strong> days</p>
                                <p>Year-over-Year Change: <strong>${calculateYearOverYearChange(results.domTrend.values)}%</strong></p>
                            `;
                        }
                        
                        const ratioStatsEl = document.getElementById('ratioStats');
                        if (ratioStatsEl) {
                            ratioStatsEl.innerHTML = `
                                <p>Current Sold/List Ratio: <strong>${(results.listToSoldRatio.values[results.listToSoldRatio.values.length - 1] * 100).toFixed(1)}%</strong></p>
                                <p>Year-over-Year Change: <strong>${calculateYearOverYearChange(results.listToSoldRatio.values, true)}%</strong></p>
                            `;
                        }
                        
                        const subdivisionStatsEl = document.getElementById('subdivisionStats');
                        if (subdivisionStatsEl) {
                            subdivisionStatsEl.innerHTML = `
                                <p>Top subdivision: <strong>${results.topSubdivisions[0].name}</strong> with ${results.topSubdivisions[0].count} properties</p>
                                <p>Second: <strong>${results.topSubdivisions[1].name}</strong> (${results.topSubdivisions[1].count})</p>
                                <p>Third: <strong>${results.topSubdivisions[2].name}</strong> (${results.topSubdivisions[2].count})</p>
                            `;
                        }
                        
                        const statusStatsEl = document.getElementById('statusStats');
                        if (statusStatsEl) {
                            statusStatsEl.innerHTML = `
                                <p>Active: <strong>${results.activeListings}</strong> listings</p>
                                <p>Sold (past year): <strong>${results.soldProperties}</strong> properties</p>
                                <p>Pending: <strong>${results.pendingProperties}</strong> properties</p>
                            `;
                        }
                    } catch (error) {
                        console.error("Error in populateMarketSummary:", error);
                        alert("Error populating market summary: " + error.message);
                    }
                }

                function populateBlogPost(results) {
                    try {
                        const blogPostContentEl = document.getElementById('blogPostContent');
                        if (blogPostContentEl) {
                            blogPostContentEl.innerHTML = generateBlogPost(results);
                            
                            // Create blog chart (median price trend)
                            createBlogChart(results);
                        }
                    } catch (error) {
                        console.error("Error in populateBlogPost:", error);
                        alert("Error populating blog post: " + error.message);
                    }
                }

                function populateSocialMedia(results) {
                    try {
                        const socialPostTextEl = document.getElementById('socialPostText');
                        const socialHashtagsEl = document.getElementById('socialHashtags');
                        
                        if (socialPostTextEl) {
                            socialPostTextEl.innerHTML = generateSocialMediaPost(results);
                        }
                        
                        if (socialHashtagsEl) {
                            socialHashtagsEl.innerHTML = generateHashtags(results);
                        }
                        
                        // Create social media chart
                        createSocialChart(results);
                    } catch (error) {
                        console.error("Error in populateSocialMedia:", error);
                        alert("Error populating social media: " + error.message);
                    }
                }

                function populateVideoScript(results) {
                    try {
                        const videoScriptContentEl = document.getElementById('videoScriptContent');
                        if (videoScriptContentEl) {
                            videoScriptContentEl.innerHTML = generateVideoScript(results);
                        }
                    } catch (error) {
                        console.error("Error in populateVideoScript:", error);
                        alert("Error populating video script: " + error.message);
                    }
                }

                function populateNewsletter(results) {
                    try {
                        const newsletterSubjectEl = document.getElementById('newsletterSubject');
                        const newsletterContentEl = document.getElementById('newsletterContent');
                        
                        if (newsletterSubjectEl) {
                            newsletterSubjectEl.innerHTML = `${results.location} Real Estate Market Update - ${getCurrentMonthYear()}`;
                        }
                        
                        if (newsletterContentEl) {
                            newsletterContentEl.innerHTML = generateNewsletter(results);
                        }
                        
                        // Create newsletter chart
                        createNewsletterChart(results);
                    } catch (error) {
                        console.error("Error in populateNewsletter:", error);
                        alert("Error populating newsletter: " + error.message);
                    }
                }

                // Chart creation functions
                function createInventoryChart(results) {
                    try {
                        console.log("Creating inventory chart");
                        const ctxElement = document.getElementById('inventoryChart');
                        if (!ctxElement) {
                            console.warn("Inventory chart canvas not found");
                            return;
                        }
                        
                        const ctx = ctxElement.getContext('2d');
                        
                        new Chart(ctx, {
                            type: 'bar',
                            data: {
                                labels: ['Active', 'Pending', 'Sold (Last Year)', 'Expired', 'Canceled'],
                                datasets: [{
                                    label: 'Number of Properties',
                                    data: [
                                        results.activeListings,
                                        results.pendingProperties,
                                        results.soldProperties,
                                        results.statusDistribution.find(s => s.name === 'Expired')?.count || 0,
                                        results.statusDistribution.find(s => s.name === 'Canceled')?.count || 0
                                    ],
                                    backgroundColor: [
                                        'rgba(54, 162, 235, 0.7)',
                                        'rgba(255, 159, 64, 0.7)',
                                        'rgba(75, 192, 192, 0.7)',
                                        'rgba(255, 99, 132, 0.7)',
                                        'rgba(153, 102, 255, 0.7)'
                                    ]
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: {
                                        display: false
                                    },
                                    title: {
                                        display: true,
                                        text: 'Property Status Distribution'
                                    }
                                },
                                scales: {
                                    y: {
                                        beginAtZero: true
                                    }
                                }
                            }
                        });
                    } catch (error) {
                        console.error("Error in createInventoryChart:", error);
                    }
                }

                function createPriceChart(results) {
                    try {
                        console.log("Creating price chart");
                        const ctxElement = document.getElementById('priceChart');
                        if (!ctxElement) {
                            console.warn("Price chart canvas not found");
                            return;
                        }
                        
                        const ctx = ctxElement.getContext('2d');
                        
                        new Chart(ctx, {
                            type: 'line',
                            data: {
                                labels: results.priceTrend.labels,
                                datasets: [{
                                    label: 'Median Sold Price',
                                    data: results.priceTrend.values,
                                    borderColor: 'rgba(75, 192, 192, 1)',
                                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                                    borderWidth: 2,
                                    tension: 0.1,
                                    fill: true
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: {
                                        display: false
                                    },
                                    title: {
                                        display: true,
                                        text: 'Median Sold Price Trend'
                                    }
                                },
                                scales: {
                                    y: {
                                        beginAtZero: false,
                                        ticks: {
                                            callback: function(value) {
                                                return '<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real Estate Market Insights Generator</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/papaparse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chart.js/3.9.1/chart.min.js"></script>
    <style>
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
            margin-bottom: 20px;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <header class="bg-blue-600 text-white p-6">
        <div class="container mx-auto">
            <h1 class="text-3xl font-bold">Real Estate Market Insights Generator</h1>
            <p class="mt-2">Upload your MLS data and generate valuable market insights, content, and visuals</p>
        </div>
    </header>

    <main class="container mx-auto my-8 px-4">
        <div class="bg-white rounded-lg shadow-md p-6 mb-8">
            <h2 class="text-2xl font-semibold mb-4">Upload Your MLS Export</h2>
            <p class="mb-4 text-gray-700">Upload a CSV file exported from your Multiple Listing Service (MLS) to generate comprehensive market insights and content for your business.</p>
            
            <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center" id="dropzone">
                <input type="file" id="fileInput" accept=".csv" class="hidden">
                <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48" aria-hidden="true">
                    <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                </svg>
                <div class="mt-4 flex text-sm text-gray-600 justify-center">
                    <label for="fileInput" class="relative cursor-pointer bg-white rounded-md font-medium text-blue-600 hover:text-blue-500 focus-within:outline-none">
                        <span>Upload a file</span>
                    </label>
                    <p class="pl-1">or drag and drop</p>
                </div>
                <p class="text-xs text-gray-500 mt-1">CSV files only</p>
            </div>
            
            <div id="fileInfo" class="mt-4 hidden">
                <div class="flex items-center">
                    <svg class="h-5 w-5 text-green-500" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                    </svg>
                    <span id="fileName" class="ml-2 text-sm font-medium text-gray-900"></span>
                </div>
                <button id="analyzeBtn" class="mt-4 inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                    Generate Insights
                </button>
            </div>
        </div>

        <div id="loadingState" class="hidden bg-white rounded-lg shadow-md p-6 mb-8 text-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"></div>
            <p class="mt-4 text-gray-700">Analyzing your data and generating insights...</p>
            <p class="text-sm text-gray-500 mt-2">This may take a moment depending on the size of your file.</p>
        </div>

        <div id="resultsSection" class="hidden">
            <div class="bg-white rounded-lg shadow-md overflow-hidden mb-8">
                <div class="border-b border-gray-200">
                    <nav class="flex -mb-px">
                        <button class="tab-btn text-blue-600 border-blue-600 active whitespace-nowrap py-4 px-6 border-b-2 font-medium text-sm" data-tab="marketSummary">
                            Market Summary
                        </button>
                        <button class="tab-btn text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-6 border-b-2 border-transparent font-medium text-sm" data-tab="blogPost">
                            Blog Post
                        </button>
                        <button class="tab-btn text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-6 border-b-2 border-transparent font-medium text-sm" data-tab="socialMedia">
                            Social Media
                        </button>
                        <button class="tab-btn text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-6 border-b-2 border-transparent font-medium text-sm" data-tab="videoScript">
                            Video Script
                        </button>
                        <button class="tab-btn text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-6 border-b-2 border-transparent font-medium text-sm" data-tab="newsletter">
                            Newsletter
                        </button>
                    </nav>
                </div>

                <!-- Market Summary Tab -->
                <div id="marketSummary" class="tab-content active p-6">
                    <h2 class="text-2xl font-bold mb-4">Market Summary</h2>
                    <div class="mb-6">
                        <h3 class="text-lg font-semibold mb-2">Key Insights</h3>
                        <div id="keyInsights" class="prose max-w-none"></div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h3 class="text-lg font-semibold mb-2">Inventory & Sales</h3>
                            <div class="chart-container">
                                <canvas id="inventoryChart"></canvas>
                            </div>
                            <div id="inventoryStats" class="text-sm"></div>
                        </div>
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h3 class="text-lg font-semibold mb-2">Price Trends</h3>
                            <div class="chart-container">
                                <canvas id="priceChart"></canvas>
                            </div>
                            <div id="priceStats" class="text-sm"></div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h3 class="text-lg font-semibold mb-2">Days on Market</h3>
                            <div class="chart-container">
                                <canvas id="domChart"></canvas>
                            </div>
                            <div id="domStats" class="text-sm"></div>
                        </div>
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h3 class="text-lg font-semibold mb-2">List to Sold Price Ratio</h3>
                            <div class="chart-container">
                                <canvas id="listToSoldChart"></canvas>
                            </div>
                            <div id="ratioStats" class="text-sm"></div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h3 class="text-lg font-semibold mb-2">Top Subdivisions</h3>
                            <div class="chart-container">
                                <canvas id="subdivisionsChart"></canvas>
                            </div>
                            <div id="subdivisionStats" class="text-sm"></div>
                        </div>
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h3 class="text-lg font-semibold mb-2">Market Distribution</h3>
                            <div class="chart-container">
                                <canvas id="statusChart"></canvas>
                            </div>
                            <div id="statusStats" class="text-sm"></div>
                        </div>
                    </div>
                </div>

                <!-- Blog Post Tab -->
                <div id="blogPost" class="tab-content p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold">Blog Post</h2>
                        <button id="copyBlogBtn" class="inline-flex items-center px-3 py-1 border border-transparent text-sm font-medium rounded-md text-blue-700 bg-blue-100 hover:bg-blue-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                            Copy to Clipboard
                        </button>
                    </div>
                    <div id="blogPostContent" class="prose max-w-none"></div>
                    <div class="mt-6 bg-gray-50 p-4 rounded-lg">
                        <h3 class="text-lg font-semibold mb-2">Featured Chart</h3>
                        <div class="chart-container">
                            <canvas id="blogChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Social Media Tab -->
                <div id="socialMedia" class="tab-content p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold">Social Media Post</h2>
                        <button id="copySocialBtn" class="inline-flex items-center px-3 py-1 border border-transparent text-sm font-medium rounded-md text-blue-700 bg-blue-100 hover:bg-blue-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                            Copy to Clipboard
                        </button>
                    </div>
                    <div class="bg-white border border-gray-200 rounded-lg shadow-sm overflow-hidden mb-6">
                        <div class="p-4 border-b border-gray-200">
                            <div class="flex items-center">
                                <div class="bg-gray-200 rounded-full h-10 w-10 flex items-center justify-center">
                                    <svg class="h-6 w-6 text-gray-500" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M12 12a3 3 0 100-6 3 3 0 000 6z"></path>
                                        <path fill-rule="evenodd" d="M12 2C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10S17.523 2 12 2zm0 18c-4.411 0-8-3.589-8-8s3.589-8 8-8 8 3.589 8 8-3.589 8-8 8z" clip-rule="evenodd"></path>
                                    </svg>
                                </div>
                                <div class="ml-3">
                                    <p class="text-sm font-medium text-gray-900">Your Real Estate Brand</p>
                                    <p class="text-xs text-gray-500">Local Market Expert</p>
                                </div>
                            </div>
                        </div>
                        <div class="p-4">
                            <p id="socialPostText" class="text-sm text-gray-700 mb-4"></p>
                            <div class="bg-gray-50 rounded-lg overflow-hidden">
                                <div class="chart-container" style="height: 250px;">
                                    <canvas id="socialChart"></canvas>
                                </div>
                            </div>
                            <div class="mt-4 flex items-center justify-between text-xs text-gray-500">
                                <span>Hashtags: <span id="socialHashtags"></span></span>
                                <span>Share this with your clients!</span>
                            </div>
                        </div>
                    </div>
                    <div class="mt-4">
                        <h3 class="text-lg font-semibold mb-2">Image Generation</h3>
                        <p class="text-sm text-gray-600 mb-2">Your social media chart has been prepared. Download and use with your post.</p>
                        <button id="downloadSocialImg" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                            Download Chart Image
                        </button>
                    </div>
                </div>

                <!-- Video Script Tab -->
                <div id="videoScript" class="tab-content p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold">Video Script</h2>
                        <button id="copyScriptBtn" class="inline-flex items-center px-3 py-1 border border-transparent text-sm font-medium rounded-md text-blue-700 bg-blue-100 hover:bg-blue-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                            Copy to Clipboard
                        </button>
                    </div>
                    <div class="mb-6">
                        <p class="text-sm text-gray-600 mb-4">This script is designed for a simple talking-head video of 90 seconds or less. Record yourself delivering this script to create compelling market update content.</p>
                        <div id="videoScriptContent" class="prose max-w-none p-4 bg-gray-50 rounded-lg"></div>
                    </div>
                    <div class="mt-4">
                        <h3 class="text-lg font-semibold mb-2">Tips for Recording</h3>
                        <ul class="list-disc pl-5 text-sm text-gray-600">
                            <li class="mb-1">Practice the script a few times before recording</li>
                            <li class="mb-1">Record in a well-lit, quiet space with a simple background</li>
                            <li class="mb-1">Look directly at the camera, not at your script</li>
                            <li class="mb-1">Speak clearly and at a moderate pace</li>
                            <li class="mb-1">Keep video length under 90 seconds for maximum engagement</li>
                            <li>Add captions to your video for accessibility</li>
                        </ul>
                    </div>
                </div>

                <!-- Newsletter Tab -->
                <div id="newsletter" class="tab-content p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold">Email Newsletter</h2>
                        <button id="copyNewsletterBtn" class="inline-flex items-center px-3 py-1 border border-transparent text-sm font-medium rounded-md text-blue-700 bg-blue-100 hover:bg-blue-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                            Copy to Clipboard
                        </button>
                    </div>
                    <div class="mb-6">
                        <p class="text-sm text-gray-600 mb-4">This newsletter is ready to copy and paste into your email service provider (Gmail, Outlook, Mailchimp, etc.).</p>
                        <div class="border border-gray-200 rounded-lg overflow-hidden shadow-sm">
                            <div class="p-4 bg-gray-50 border-b border-gray-200">
                                <h3 class="text-lg font-semibold" id="newsletterSubject"></h3>
                            </div>
                            <div class="p-4 bg-white">
                                <div id="newsletterContent" class="prose max-w-none"></div>
                                <div class="mt-6">
                                    <div class="chart-container" style="height: 300px;">
                                        <canvas id="newsletterChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer class="bg-gray-800 text-white py-6">
        <div class="container mx-auto px-4">
            <p class="text-center text-sm">Real Estate Market Insights Generator - Your Market Analysis Tool</p>
            <p class="text-center text-xs mt-2">Data is analyzed exclusively on your device and is not stored on any server.</p>
        </div>
    </footer>

    <script>
        // Wait for page to fully load before initializing
        window.addEventListener('load', function() {
            console.log("Page fully loaded - starting initialization");
            
            try {
                // Initialize the application
                initApp();
            } catch (error) {
                console.error("Error initializing app:", error);
                alert("There was an error initializing the application: " + error.message);
            }
            
            function initApp() {
                // DOM Elements
                const fileInput = document.getElementById('fileInput');
                const dropzone = document.getElementById('dropzone');
                const fileInfo = document.getElementById('fileInfo');
                const fileName = document.getElementById('fileName');
                const analyzeBtn = document.getElementById('analyzeBtn');
                const loadingState = document.getElementById('loadingState');
                const resultsSection = document.getElementById('resultsSection');
                const tabButtons = document.querySelectorAll('.tab-btn');
                const tabContents = document.querySelectorAll('.tab-content');
                
                console.log("DOM elements retrieved");
                
                // Copy buttons
                const copyBlogBtn = document.getElementById('copyBlogBtn');
                const copySocialBtn = document.getElementById('copySocialBtn');
                const copyScriptBtn = document.getElementById('copyScriptBtn');
                const copyNewsletterBtn = document.getElementById('copyNewsletterBtn');
                const downloadSocialImg = document.getElementById('downloadSocialImg');

                // Global variables
                let parsedData = null;
                let analysisResults = null;

                // Set up file input and dropzone
                fileInput.addEventListener('change', handleFileSelection);
                
                dropzone.addEventListener('click', function() {
                    console.log("Dropzone clicked");
                    fileInput.click();
                });
                
                // Prevent default behavior for dragover
                dropzone.addEventListener('dragover', function(e) {
                    console.log("Drag over event");
                    e.preventDefault();
                    dropzone.classList.add('border-blue-500');
                });
                
                // Handle dragleave
                dropzone.addEventListener('dragleave', function() {
                    dropzone.classList.remove('border-blue-500');
                });
                
                // Handle drop
                dropzone.addEventListener('drop', function(e) {
                    console.log("File dropped");
                    e.preventDefault();
                    dropzone.classList.remove('border-blue-500');
                    
                    if (e.dataTransfer.files.length) {
                        const file = e.dataTransfer.files[0];
                        if (file.type === 'text/csv' || file.name.endsWith('.csv')) {
                            fileInput.files = e.dataTransfer.files;
                            handleFileSelection();
                        } else {
                            alert('Please upload a CSV file.');
                        }
                    }
                });

                // Handle tab switching
                tabButtons.forEach(button => {
                    button.addEventListener('click', function() {
                        console.log("Tab button clicked:", button.dataset.tab);
                        // Remove active class from all buttons and contents
                        tabButtons.forEach(btn => btn.classList.remove('text-blue-600', 'border-blue-600', 'active'));
                        tabButtons.forEach(btn => btn.classList.add('text-gray-500', 'border-transparent'));
                        tabContents.forEach(content => content.classList.remove('active'));
                        
                        // Add active class to clicked button and corresponding content
                        button.classList.remove('text-gray-500', 'border-transparent');
                        button.classList.add('text-blue-600', 'border-blue-600', 'active');
                        document.getElementById(button.dataset.tab).classList.add('active');
                    });
                });

                // Copy buttons functionality
                if (copyBlogBtn) {
                    copyBlogBtn.addEventListener('click', function() {
                        copyToClipboard(document.getElementById('blogPostContent').innerText);
                    });
                }
                
                if (copySocialBtn) {
                    copySocialBtn.addEventListener('click', function() {
                        copyToClipboard(document.getElementById('socialPostText').innerText + '\n\n' + document.getElementById('socialHashtags').innerText);
                    });
                }
                
                if (copyScriptBtn) {
                    copyScriptBtn.addEventListener('click', function() {
                        copyToClipboard(document.getElementById('videoScriptContent').innerText);
                    });
                }
                
                if (copyNewsletterBtn) {
                    copyNewsletterBtn.addEventListener('click', function() {
                        copyToClipboard(document.getElementById('newsletterContent').innerText);
                    });
                }
                
                // Download social image
                if (downloadSocialImg) {
                    downloadSocialImg.addEventListener('click', function() {
                        const canvas = document.getElementById('socialChart');
                        const link = document.createElement('a');
                        link.download = 'real-estate-market-chart.png';
                        link.href = canvas.toDataURL('image/png');
                        link.click();
                    });
                }

                // Analyze button click handler
                if (analyzeBtn) {
                    analyzeBtn.addEventListener('click', analyzeData);
                }

                console.log("Event listeners set up");

                function handleFileSelection() {
                    try {
                        console.log("File selection handler called");
                        const file = fileInput.files[0];
                        if (file) {
                            console.log("File selected:", file.name);
                            fileName.textContent = file.name;
                            fileInfo.classList.remove('hidden');
                        }
                    } catch (error) {
                        console.error("Error in handleFileSelection:", error);
                        alert("Error handling file selection: " + error.message);
                    }
                }

                function copyToClipboard(text) {
                    try {
                        navigator.clipboard.writeText(text)
                            .then(() => alert('Copied to clipboard!'))
                            .catch(err => {
                                console.error('Could not copy text: ', err);
                                alert('Could not copy text. Your browser may not support this feature.');
                            });
                    } catch (error) {
                        console.error("Error in copyToClipboard:", error);
                        alert("Error copying to clipboard: " + error.message);
                    }
                }

                function analyzeData() {
                    try {
                        console.log("Analyze data function called");
                        const file = fileInput.files[0];
                        if (!file) {
                            alert('Please select a CSV file first.');
                            return;
                        }

                        // Show loading state
                        fileInfo.classList.add('hidden');
                        loadingState.classList.remove('hidden');

                        console.log("Starting file read");
                        // Read and parse the CSV file
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            try {
                                console.log("File read complete");
                                const csvData = e.target.result;
                                
                                console.log("Parsing CSV with Papa Parse");
                                Papa.parse(csvData, {
                                    header: true,
                                    dynamicTyping: true,
                                    skipEmptyLines: true,
                                    complete: function(results) {
                                        try {
                                            console.log("Papa Parse complete:", results.data.length, "rows");
                                            parsedData = results.data;
                                            
                                            // Process the data and generate insights
                                            processDataAndGenerateInsights(parsedData);
                                            
                                            // Hide loading, show results
                                            loadingState.classList.add('hidden');
                                            resultsSection.classList.remove('hidden');
                                        } catch (error) {
                                            console.error("Error in Papa Parse complete callback:", error);
                                            alert("Error processing CSV data: " + error.message);
                                            loadingState.classList.add('hidden');
                                            fileInfo.classList.remove('hidden');
                                        }
                                    },
                                    error: function(error) {
                                        console.error('Error parsing CSV:', error);
                                        alert('Error parsing CSV file. Please check the file format.');
                                        loadingState.classList.add('hidden');
                                        fileInfo.classList.remove('hidden');
                                    }
                                });
                            } catch (error) {
                                console.error("Error in FileReader onload:", error);
                                alert("Error reading file: " + error.message);
                                loadingState.classList.add('hidden');
                                fileInfo.classList.remove('hidden');
                            }
                        };
                        
                        reader.onerror = function() {
                            console.error("FileReader error");
                            alert("Error reading the file. Please try again.");
                            loadingState.classList.add('hidden');
                            fileInfo.classList.remove('hidden');
                        };
                        
                        reader.readAsText(file);
                    } catch (error) {
                        console.error("Error in analyzeData:", error);
                        alert("Error analyzing data: " + error.message);
                        loadingState.classList.add('hidden');
                        fileInfo.classList.remove('hidden');
                    }
                }

                function processDataAndGenerateInsights(data) {
                    try {
                        console.log("Processing data and generating insights");
                        // This function will analyze the data and generate all the insights
                        // For the demo, we'll use sample analysis based on the provided data
                        
                        // In a real implementation, this would dynamically analyze the uploaded CSV
                        // and generate insights based on that specific data
                        
                        // Sample analysis results (this would be generated from the actual data)
                        analysisResults = {
                            location: "Queen Creek, Arizona",
                            period: "Past 12 Months",
                            totalProperties: data.length,
                            activeListings: data.filter(p => p.Status === 'A').length,
                            soldProperties: data.filter(p => p.Status === 'C').length,
                            pendingProperties: data.filter(p => p.Status === 'P').length,
                            medianSoldPrice: calculateMedian(data.filter(p => p.Status === 'C' && p['Sold Price']).map(p => p['Sold Price'])),
                            medianDOM: calculateMedian(data.filter(p => p['Days on Market']).map(p => p['Days on Market'])),
                            avgPricePerSqFt: calculateAverage(data.filter(p => p['Price/SqFt'] && !isNaN(p['Price/SqFt'])).map(p => p['Price/SqFt'])),
                            monthsOfInventory: calculateMonthsOfInventory(data),
                            priceTrend: calculatePriceTrend(data),
                            domTrend: calculateDOMTrend(data),
                            topSubdivisions: calculateTopSubdivisions(data, 5),
                            statusDistribution: calculateStatusDistribution(data),
                            listToSoldRatio: calculateListToSoldRatio(data),
                            priceRanges: calculatePriceRanges(data.filter(p => p.Status === 'A')),
                            bedroomDistribution: calculateBedroomDistribution(data),
                            poolDistribution: calculatePoolDistribution(data),
                            yearBuiltDistribution: calculateYearBuiltDistribution(data),
                            topAgencies: calculateTopAgencies(data, 5)
                        };
                        
                        console.log("Analysis complete, populating UI");
                        // Update all the UI elements with the analysis results
                        populateUI(analysisResults);
                    } catch (error) {
                        console.error("Error in processDataAndGenerateInsights:", error);
                        alert("Error processing data: " + error.message);
                        loadingState.classList.ad + value.toLocaleString();
                                            }
                                        }
                                    }
                                }
                            }
                        });
                    } catch (error) {
                        console.error("Error in createPriceChart:", error);
                    }
                }

                function createDOMChart(results) {
                    try {
                        console.log("Creating DOM chart");
                        const ctxElement = document.getElementById('domChart');
                        if (!ctxElement) {
                            console.warn("DOM chart canvas not found");
                            return;
                        }
                        
                        const ctx = ctxElement.getContext('2d');
                        
                        new Chart(ctx, {
                            type: 'line',
                            data: {
                                labels: results.domTrend.labels,
                                datasets: [{
                                    label: 'Average Days on Market',
                                    data: results.domTrend.values,
                                    borderColor: 'rgba(255, 99, 132, 1)',
                                    backgroundColor: 'rgba(255, 99, 132, 0.2)',
                                    borderWidth: 2,
                                    tension: 0.1,
                                    fill: true
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: {
                                        display: false
                                    },
                                    title: {
                                        display: true,
                                        text: 'Days on Market Trend'
                                    }
                                },
                                scales: {
                                    y: {
                                        beginAtZero: false
                                    }
                                }
                            }
                        });
                    } catch (error) {
                        console.error("Error in createDOMChart:", error);
                    }
                }

                function createListToSoldChart(results) {
                    try {
                        console.log("Creating list-to-sold chart");
                        const ctxElement = document.getElementById('listToSoldChart');
                        if (!ctxElement) {
                            console.warn("List-to-sold chart canvas not found");
                            return;
                        }
                        
                        const ctx = ctxElement.getContext('2d');
                        
                        // Convert ratio to percentage
                        const percentageValues = results.listToSoldRatio.values.map(v => v * 100);
                        
                        new Chart(ctx, {
                            type: 'line',
                            data: {
                                labels: results.listToSoldRatio.labels,
                                datasets: [{
                                    label: 'Sale to List Price Ratio',
                                    data: percentageValues,
                                    borderColor: 'rgba(54, 162, 235, 1)',
                                    backgroundColor: 'rgba(54, 162, 235, 0.2)',
                                    borderWidth: 2,
                                    tension: 0.1,
                                    fill: true
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: {
                                        display: false
                                    },
                                    title: {
                                        display: true,
                                        text: 'Sale to List Price Ratio (%)'
                                    }
                                },
                                scales: {
                                    y: {
                                        beginAtZero: false,
                                        min: Math.min(...percentageValues) - 1, // Add a bit of padding
                                        max: 100,
                                        ticks: {
                                            callback: function(value) {
                                                return value + '%';
                                            }
                                        }
                                    }
                                }
                            }
                        });
                    } catch (error) {
                        console.error("Error in createListToSoldChart:", error);
                    }
                }

                function createSubdivisionsChart(results) {
                    try {
                        console.log("Creating subdivisions chart");
                        const ctxElement = document.getElementById('subdivisionsChart');
                        if (!ctxElement) {
                            console.warn("Subdivisions chart canvas not found");
                            return;
                        }
                        
                        const ctx = ctxElement.getContext('2d');
                        
                        new Chart(ctx, {
                            type: 'pie',
                            data: {
                                labels: results.topSubdivisions.map(s => s.name),
                                datasets: [{
                                    data: results.topSubdivisions.map(s => s.count),
                                    backgroundColor: [
                                        'rgba(255, 99, 132, 0.7)',
                                        'rgba(54, 162, 235, 0.7)',
                                        'rgba(255, 206, 86, 0.7)',
                                        'rgba(75, 192, 192, 0.7)',
                                        'rgba(153, 102, 255, 0.7)'
                                    ]
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: {
                                        position: 'right',
                                        labels: {
                                            boxWidth: 15
                                        }
                                    },
                                    title: {
                                        display: true,
                                        text: 'Top Subdivisions'
                                    }
                                }
                            }
                        });
                    } catch (error) {
                        console.error("Error in createSubdivisionsChart:", error);
                    }
                }

                function createStatusChart(results) {
                    try {
                        console.log("Creating status chart");
                        const ctxElement = document.getElementById('statusChart');
                        if (!ctxElement) {
                            console.warn("Status chart canvas not found");
                            return;
                        }
                        
                        const ctx = ctxElement.getContext('2d');
                        
                        new Chart(ctx, {
                            type: 'doughnut',
                            data: {
                                labels: results.statusDistribution.map(s => s.name),
                                datasets: [{
                                    data: results.statusDistribution.map(s => s.<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real Estate Market Insights Generator</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/papaparse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chart.js/3.9.1/chart.min.js"></script>
    <style>
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
            margin-bottom: 20px;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <header class="bg-blue-600 text-white p-6">
        <div class="container mx-auto">
            <h1 class="text-3xl font-bold">Real Estate Market Insights Generator</h1>
            <p class="mt-2">Upload your MLS data and generate valuable market insights, content, and visuals</p>
        </div>
    </header>

    <main class="container mx-auto my-8 px-4">
        <div class="bg-white rounded-lg shadow-md p-6 mb-8">
            <h2 class="text-2xl font-semibold mb-4">Upload Your MLS Export</h2>
            <p class="mb-4 text-gray-700">Upload a CSV file exported from your Multiple Listing Service (MLS) to generate comprehensive market insights and content for your business.</p>
            
            <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center" id="dropzone">
                <input type="file" id="fileInput" accept=".csv" class="hidden">
                <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48" aria-hidden="true">
                    <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                </svg>
                <div class="mt-4 flex text-sm text-gray-600 justify-center">
                    <label for="fileInput" class="relative cursor-pointer bg-white rounded-md font-medium text-blue-600 hover:text-blue-500 focus-within:outline-none">
                        <span>Upload a file</span>
                    </label>
                    <p class="pl-1">or drag and drop</p>
                </div>
                <p class="text-xs text-gray-500 mt-1">CSV files only</p>
            </div>
            
            <div id="fileInfo" class="mt-4 hidden">
                <div class="flex items-center">
                    <svg class="h-5 w-5 text-green-500" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                    </svg>
                    <span id="fileName" class="ml-2 text-sm font-medium text-gray-900"></span>
                </div>
                <button id="analyzeBtn" class="mt-4 inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                    Generate Insights
                </button>
            </div>
        </div>

        <div id="loadingState" class="hidden bg-white rounded-lg shadow-md p-6 mb-8 text-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"></div>
            <p class="mt-4 text-gray-700">Analyzing your data and generating insights...</p>
            <p class="text-sm text-gray-500 mt-2">This may take a moment depending on the size of your file.</p>
        </div>

        <div id="resultsSection" class="hidden">
            <div class="bg-white rounded-lg shadow-md overflow-hidden mb-8">
                <div class="border-b border-gray-200">
                    <nav class="flex -mb-px">
                        <button class="tab-btn text-blue-600 border-blue-600 active whitespace-nowrap py-4 px-6 border-b-2 font-medium text-sm" data-tab="marketSummary">
                            Market Summary
                        </button>
                        <button class="tab-btn text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-6 border-b-2 border-transparent font-medium text-sm" data-tab="blogPost">
                            Blog Post
                        </button>
                        <button class="tab-btn text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-6 border-b-2 border-transparent font-medium text-sm" data-tab="socialMedia">
                            Social Media
                        </button>
                        <button class="tab-btn text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-6 border-b-2 border-transparent font-medium text-sm" data-tab="videoScript">
                            Video Script
                        </button>
                        <button class="tab-btn text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-6 border-b-2 border-transparent font-medium text-sm" data-tab="newsletter">
                            Newsletter
                        </button>
                    </nav>
                </div>

                <!-- Market Summary Tab -->
                <div id="marketSummary" class="tab-content active p-6">
                    <h2 class="text-2xl font-bold mb-4">Market Summary</h2>
                    <div class="mb-6">
                        <h3 class="text-lg font-semibold mb-2">Key Insights</h3>
                        <div id="keyInsights" class="prose max-w-none"></div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h3 class="text-lg font-semibold mb-2">Inventory & Sales</h3>
                            <div class="chart-container">
                                <canvas id="inventoryChart"></canvas>
                            </div>
                            <div id="inventoryStats" class="text-sm"></div>
                        </div>
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h3 class="text-lg font-semibold mb-2">Price Trends</h3>
                            <div class="chart-container">
                                <canvas id="priceChart"></canvas>
                            </div>
                            <div id="priceStats" class="text-sm"></div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h3 class="text-lg font-semibold mb-2">Days on Market</h3>
                            <div class="chart-container">
                                <canvas id="domChart"></canvas>
                            </div>
                            <div id="domStats" class="text-sm"></div>
                        </div>
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h3 class="text-lg font-semibold mb-2">List to Sold Price Ratio</h3>
                            <div class="chart-container">
                                <canvas id="listToSoldChart"></canvas>
                            </div>
                            <div id="ratioStats" class="text-sm"></div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h3 class="text-lg font-semibold mb-2">Top Subdivisions</h3>
                            <div class="chart-container">
                                <canvas id="subdivisionsChart"></canvas>
                            </div>
                            <div id="subdivisionStats" class="text-sm"></div>
                        </div>
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h3 class="text-lg font-semibold mb-2">Market Distribution</h3>
                            <div class="chart-container">
                                <canvas id="statusChart"></canvas>
                            </div>
                            <div id="statusStats" class="text-sm"></div>
                        </div>
                    </div>
                </div>

                <!-- Blog Post Tab -->
                <div id="blogPost" class="tab-content p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold">Blog Post</h2>
                        <button id="copyBlogBtn" class="inline-flex items-center px-3 py-1 border border-transparent text-sm font-medium rounded-md text-blue-700 bg-blue-100 hover:bg-blue-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                            Copy to Clipboard
                        </button>
                    </div>
                    <div id="blogPostContent" class="prose max-w-none"></div>
                    <div class="mt-6 bg-gray-50 p-4 rounded-lg">
                        <h3 class="text-lg font-semibold mb-2">Featured Chart</h3>
                        <div class="chart-container">
                            <canvas id="blogChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Social Media Tab -->
                <div id="socialMedia" class="tab-content p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold">Social Media Post</h2>
                        <button id="copySocialBtn" class="inline-flex items-center px-3 py-1 border border-transparent text-sm font-medium rounded-md text-blue-700 bg-blue-100 hover:bg-blue-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                            Copy to Clipboard
                        </button>
                    </div>
                    <div class="bg-white border border-gray-200 rounded-lg shadow-sm overflow-hidden mb-6">
                        <div class="p-4 border-b border-gray-200">
                            <div class="flex items-center">
                                <div class="bg-gray-200 rounded-full h-10 w-10 flex items-center justify-center">
                                    <svg class="h-6 w-6 text-gray-500" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M12 12a3 3 0 100-6 3 3 0 000 6z"></path>
                                        <path fill-rule="evenodd" d="M12 2C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10S17.523 2 12 2zm0 18c-4.411 0-8-3.589-8-8s3.589-8 8-8 8 3.589 8 8-3.589 8-8 8z" clip-rule="evenodd"></path>
                                    </svg>
                                </div>
                                <div class="ml-3">
                                    <p class="text-sm font-medium text-gray-900">Your Real Estate Brand</p>
                                    <p class="text-xs text-gray-500">Local Market Expert</p>
                                </div>
                            </div>
                        </div>
                        <div class="p-4">
                            <p id="socialPostText" class="text-sm text-gray-700 mb-4"></p>
                            <div class="bg-gray-50 rounded-lg overflow-hidden">
                                <div class="chart-container" style="height: 250px;">
                                    <canvas id="socialChart"></canvas>
                                </div>
                            </div>
                            <div class="mt-4 flex items-center justify-between text-xs text-gray-500">
                                <span>Hashtags: <span id="socialHashtags"></span></span>
                                <span>Share this with your clients!</span>
                            </div>
                        </div>
                    </div>
                    <div class="mt-4">
                        <h3 class="text-lg font-semibold mb-2">Image Generation</h3>
                        <p class="text-sm text-gray-600 mb-2">Your social media chart has been prepared. Download and use with your post.</p>
                        <button id="downloadSocialImg" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                            Download Chart Image
                        </button>
                    </div>
                </div>

                <!-- Video Script Tab -->
                <div id="videoScript" class="tab-content p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold">Video Script</h2>
                        <button id="copyScriptBtn" class="inline-flex items-center px-3 py-1 border border-transparent text-sm font-medium rounded-md text-blue-700 bg-blue-100 hover:bg-blue-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                            Copy to Clipboard
                        </button>
                    </div>
                    <div class="mb-6">
                        <p class="text-sm text-gray-600 mb-4">This script is designed for a simple talking-head video of 90 seconds or less. Record yourself delivering this script to create compelling market update content.</p>
                        <div id="videoScriptContent" class="prose max-w-none p-4 bg-gray-50 rounded-lg"></div>
                    </div>
                    <div class="mt-4">
                        <h3 class="text-lg font-semibold mb-2">Tips for Recording</h3>
                        <ul class="list-disc pl-5 text-sm text-gray-600">
                            <li class="mb-1">Practice the script a few times before recording</li>
                            <li class="mb-1">Record in a well-lit, quiet space with a simple background</li>
                            <li class="mb-1">Look directly at the camera, not at your script</li>
                            <li class="mb-1">Speak clearly and at a moderate pace</li>
                            <li class="mb-1">Keep video length under 90 seconds for maximum engagement</li>
                            <li>Add captions to your video for accessibility</li>
                        </ul>
                    </div>
                </div>

                <!-- Newsletter Tab -->
                <div id="newsletter" class="tab-content p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold">Email Newsletter</h2>
                        <button id="copyNewsletterBtn" class="inline-flex items-center px-3 py-1 border border-transparent text-sm font-medium rounded-md text-blue-700 bg-blue-100 hover:bg-blue-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                            Copy to Clipboard
                        </button>
                    </div>
                    <div class="mb-6">
                        <p class="text-sm text-gray-600 mb-4">This newsletter is ready to copy and paste into your email service provider (Gmail, Outlook, Mailchimp, etc.).</p>
                        <div class="border border-gray-200 rounded-lg overflow-hidden shadow-sm">
                            <div class="p-4 bg-gray-50 border-b border-gray-200">
                                <h3 class="text-lg font-semibold" id="newsletterSubject"></h3>
                            </div>
                            <div class="p-4 bg-white">
                                <div id="newsletterContent" class="prose max-w-none"></div>
                                <div class="mt-6">
                                    <div class="chart-container" style="height: 300px;">
                                        <canvas id="newsletterChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer class="bg-gray-800 text-white py-6">
        <div class="container mx-auto px-4">
            <p class="text-center text-sm">Real Estate Market Insights Generator - Your Market Analysis Tool</p>
            <p class="text-center text-xs mt-2">Data is analyzed exclusively on your device and is not stored on any server.</p>
        </div>
    </footer>

    <script>
        // Wait for page to fully load before initializing
        window.addEventListener('load', function() {
            console.log("Page fully loaded - starting initialization");
            
            try {
                // Initialize the application
                initApp();
            } catch (error) {
                console.error("Error initializing app:", error);
                alert("There was an error initializing the application: " + error.message);
            }
            
            function initApp() {
                // DOM Elements
                const fileInput = document.getElementById('fileInput');
                const dropzone = document.getElementById('dropzone');
                const fileInfo = document.getElementById('fileInfo');
                const fileName = document.getElementById('fileName');
                const analyzeBtn = document.getElementById('analyzeBtn');
                const loadingState = document.getElementById('loadingState');
                const resultsSection = document.getElementById('resultsSection');
                const tabButtons = document.querySelectorAll('.tab-btn');
                const tabContents = document.querySelectorAll('.tab-content');
                
                console.log("DOM elements retrieved");
                
                // Copy buttons
                const copyBlogBtn = document.getElementById('copyBlogBtn');
                const copySocialBtn = document.getElementById('copySocialBtn');
                const copyScriptBtn = document.getElementById('copyScriptBtn');
                const copyNewsletterBtn = document.getElementById('copyNewsletterBtn');
                const downloadSocialImg = document.getElementById('downloadSocialImg');

                // Global variables
                let parsedData = null;
                let analysisResults = null;

                // Set up file input and dropzone
                fileInput.addEventListener('change', handleFileSelection);
                
                dropzone.addEventListener('click', function() {
                    console.log("Dropzone clicked");
                    fileInput.click();
                });
                
                // Prevent default behavior for dragover
                dropzone.addEventListener('dragover', function(e) {
                    console.log("Drag over event");
                    e.preventDefault();
                    dropzone.classList.add('border-blue-500');
                });
                
                // Handle dragleave
                dropzone.addEventListener('dragleave', function() {
                    dropzone.classList.remove('border-blue-500');
                });
                
                // Handle drop
                dropzone.addEventListener('drop', function(e) {
                    console.log("File dropped");
                    e.preventDefault();
                    dropzone.classList.remove('border-blue-500');
                    
                    if (e.dataTransfer.files.length) {
                        const file = e.dataTransfer.files[0];
                        if (file.type === 'text/csv' || file.name.endsWith('.csv')) {
                            fileInput.files = e.dataTransfer.files;
                            handleFileSelection();
                        } else {
                            alert('Please upload a CSV file.');
                        }
                    }
                });

                // Handle tab switching
                tabButtons.forEach(button => {
                    button.addEventListener('click', function() {
                        console.log("Tab button clicked:", button.dataset.tab);
                        // Remove active class from all buttons and contents
                        tabButtons.forEach(btn => btn.classList.remove('text-blue-600', 'border-blue-600', 'active'));
                        tabButtons.forEach(btn => btn.classList.add('text-gray-500', 'border-transparent'));
                        tabContents.forEach(content => content.classList.remove('active'));
                        
                        // Add active class to clicked button and corresponding content
                        button.classList.remove('text-gray-500', 'border-transparent');
                        button.classList.add('text-blue-600', 'border-blue-600', 'active');
                        document.getElementById(button.dataset.tab).classList.add('active');
                    });
                });

                // Copy buttons functionality
                if (copyBlogBtn) {
                    copyBlogBtn.addEventListener('click', function() {
                        copyToClipboard(document.getElementById('blogPostContent').innerText);
                    });
                }
                
                if (copySocialBtn) {
                    copySocialBtn.addEventListener('click', function() {
                        copyToClipboard(document.getElementById('socialPostText').innerText + '\n\n' + document.getElementById('socialHashtags').innerText);
                    });
                }
                
                if (copyScriptBtn) {
                    copyScriptBtn.addEventListener('click', function() {
                        copyToClipboard(document.getElementById('videoScriptContent').innerText);
                    });
                }
                
                if (copyNewsletterBtn) {
                    copyNewsletterBtn.addEventListener('click', function() {
                        copyToClipboard(document.getElementById('newsletterContent').innerText);
                    });
                }
                
                // Download social image
                if (downloadSocialImg) {
                    downloadSocialImg.addEventListener('click', function() {
                        const canvas = document.getElementById('socialChart');
                        const link = document.createElement('a');
                        link.download = 'real-estate-market-chart.png';
                        link.href = canvas.toDataURL('image/png');
                        link.click();
                    });
                }

                // Analyze button click handler
                if (analyzeBtn) {
                    analyzeBtn.addEventListener('click', analyzeData);
                }

                console.log("Event listeners set up");

                function handleFileSelection() {
                    try {
                        console.log("File selection handler called");
                        const file = fileInput.files[0];
                        if (file) {
                            console.log("File selected:", file.name);
                            fileName.textContent = file.name;
                            fileInfo.classList.remove('hidden');
                        }
                    } catch (error) {
                        console.error("Error in handleFileSelection:", error);
                        alert("Error handling file selection: " + error.message);
                    }
                }

                function copyToClipboard(text) {
                    try {
                        navigator.clipboard.writeText(text)
                            .then(() => alert('Copied to clipboard!'))
                            .catch(err => {
                                console.error('Could not copy text: ', err);
                                alert('Could not copy text. Your browser may not support this feature.');
                            });
                    } catch (error) {
                        console.error("Error in copyToClipboard:", error);
                        alert("Error copying to clipboard: " + error.message);
                    }
                }

                function analyzeData() {
                    try {
                        console.log("Analyze data function called");
                        const file = fileInput.files[0];
                        if (!file) {
                            alert('Please select a CSV file first.');
                            return;
                        }

                        // Show loading state
                        fileInfo.classList.add('hidden');
                        loadingState.classList.remove('hidden');

                        console.log("Starting file read");
                        // Read and parse the CSV file
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            try {
                                console.log("File read complete");
                                const csvData = e.target.result;
                                
                                console.log("Parsing CSV with Papa Parse");
                                Papa.parse(csvData, {
                                    header: true,
                                    dynamicTyping: true,
                                    skipEmptyLines: true,
                                    complete: function(results) {
                                        try {
                                            console.log("Papa Parse complete:", results.data.length, "rows");
                                            parsedData = results.data;
                                            
                                            // Process the data and generate insights
                                            processDataAndGenerateInsights(parsedData);
                                            
                                            // Hide loading, show results
                                            loadingState.classList.add('hidden');
                                            resultsSection.classList.remove('hidden');
                                        } catch (error) {
                                            console.error("Error in Papa Parse complete callback:", error);
                                            alert("Error processing CSV data: " + error.message);
                                            loadingState.classList.add('hidden');
                                            fileInfo.classList.remove('hidden');
                                        }
                                    },
                                    error: function(error) {
                                        console.error('Error parsing CSV:', error);
                                        alert('Error parsing CSV file. Please check the file format.');
                                        loadingState.classList.add('hidden');
                                        fileInfo.classList.remove('hidden');
                                    }
                                });
                            } catch (error) {
                                console.error("Error in FileReader onload:", error);
                                alert("Error reading file: " + error.message);
                                loadingState.classList.add('hidden');
                                fileInfo.classList.remove('hidden');
                            }
                        };
                        
                        reader.onerror = function() {
                            console.error("FileReader error");
                            alert("Error reading the file. Please try again.");
                            loadingState.classList.add('hidden');
                            fileInfo.classList.remove('hidden');
                        };
                        
                        reader.readAsText(file);
                    } catch (error) {
                        console.error("Error in analyzeData:", error);
                        alert("Error analyzing data: " + error.message);
                        loadingState.classList.add('hidden');
                        fileInfo.classList.remove('hidden');
                    }
                }

                function processDataAndGenerateInsights(data) {
                    try {
                        console.log("Processing data and generating insights");
                        // This function will analyze the data and generate all the insights
                        // For the demo, we'll use sample analysis based on the provided data
                        
                        // In a real implementation, this would dynamically analyze the uploaded CSV
                        // and generate insights based on that specific data
                        
                        // Sample analysis results (this would be generated from the actual data)
                        analysisResults = {
                            location: "Queen Creek, Arizona",
                            period: "Past 12 Months",
                            totalProperties: data.length,
                            activeListings: data.filter(p => p.Status === 'A').length,
                            soldProperties: data.filter(p => p.Status === 'C').length,
                            pendingProperties: data.filter(p => p.Status === 'P').length,
                            medianSoldPrice: calculateMedian(data.filter(p => p.Status === 'C' && p['Sold Price']).map(p => p['Sold Price'])),
                            medianDOM: calculateMedian(data.filter(p => p['Days on Market']).map(p => p['Days on Market'])),
                            avgPricePerSqFt: calculateAverage(data.filter(p => p['Price/SqFt'] && !isNaN(p['Price/SqFt'])).map(p => p['Price/SqFt'])),
                            monthsOfInventory: calculateMonthsOfInventory(data),
                            priceTrend: calculatePriceTrend(data),
                            domTrend: calculateDOMTrend(data),
                            topSubdivisions: calculateTopSubdivisions(data, 5),
                            statusDistribution: calculateStatusDistribution(data),
                            listToSoldRatio: calculateListToSoldRatio(data),
                            priceRanges: calculatePriceRanges(data.filter(p => p.Status === 'A')),
                            bedroomDistribution: calculateBedroomDistribution(data),
                            poolDistribution: calculatePoolDistribution(data),
                            yearBuiltDistribution: calculateYearBuiltDistribution(data),
                            topAgencies: calculateTopAgencies(data, 5)
                        };
                        
                        console.log("Analysis complete, populating UI");
                        // Update all the UI elements with the analysis results
                        populateUI(analysisResults);
                    } catch (error) {
                        console.error("Error in processDataAndGenerateInsights:", error);
                        alert("Error processing data: " + error.message);
                        loadingState.classList.ad + value + 'k';
                                                if (index === 1) return value + ' days';
                                                return value + ' months';
                                            }
                                        }
                                    }
                                }
                            }
                        });
                    } catch (error) {
                        console.error("Error in createSocialChart:", error);
                    }
                }

                function createNewsletterChart(results) {
                    try {
                        console.log("Creating newsletter chart");
                        const ctxElement = document.getElementById('newsletterChart');
                        if (!ctxElement) {
                            console.warn("Newsletter chart canvas not found");
                            return;
                        }
                        
                        const ctx = ctxElement.getContext('2d');
                        
                        // Create a multi-dataset chart for newsletter
                        new Chart(ctx, {
                            type: 'line',
                            data: {
                                labels: results.priceTrend.labels,
                                datasets: [
                                    {
                                        label: 'Median Price ($k)',
                                        data: results.priceTrend.values.map(v => v / 1000), // Convert to thousands
                                        borderColor: 'rgba(75, 192, 192, 1)',
                                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                                        yAxisID: 'y',
                                        tension: 0.1,
                                        fill: true
                                    },
                                    {
                                        label: 'Days on Market',
                                        data: results.domTrend.values,
                                        borderColor: 'rgba(255, 99, 132, 1)',
                                        backgroundColor: 'rgba(255, 99, 132, 0.2)',
                                        yAxisID: 'y1',
                                        tension: 0.1,
                                        fill: true
                                    }
                                ]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    title: {
                                        display: true,
                                        text: `${results.location} Market Trends (${results.period})`,
                                        font: {
                                            size: 16
                                        }
                                    }
                                },
                                scales: {
                                    y: {
                                        type: 'linear',
                                        display: true,
                                        position: 'left',
                                        title: {
                                            display: true,
                                            text: 'Price ($k)'
                                        }
                                    },
                                    y1: {
                                        type: 'linear',
                                        display: true,
                                        position: 'right',
                                        title: {
                                            display: true,
                                            text: 'Days on Market'
                                        },
                                        grid: {
                                            drawOnChartArea: false
                                        }
                                    }
                                }
                            }
                        });
                    } catch (error) {
                        console.error("Error in createNewsletterChart:", error);
                    }
                }

                // Content generation functions
                function generateBlogPost(results) {
                    try {
                        return `
                            <h2>${results.location} Real Estate Market Update - ${getCurrentMonthYear()}</h2>
                            
                            <p>As a trusted real estate professional in ${results.location}, I'm committed to keeping you informed about our local housing market trends. This analysis covers data from the past year, giving you a comprehensive view of where we stand today.</p>
                            
                            <h3>Current Market Overview</h3>
                            
                            <p>The ${results.location} real estate market currently has <strong>${results.activeListings}</strong> active listings, with a median sold price of <strong>${formatNumber(results.medianSoldPrice)}</strong>. Properties are spending a median of <strong>${Math.round(results.medianDOM)}</strong> days on the market before selling, and the average price per square foot stands at <strong>${Math.round(results.avgPricePerSqFt)}</strong>.</p>
                            
                            <p>With <strong>${results.monthsOfInventory.toFixed(1)}</strong> months of inventory, we are currently in a <strong>${results.monthsOfInventory < 6 ? 'seller\'s market' : results.monthsOfInventory < 7 ? 'balanced market' : 'buyer\'s market'}</strong>. This means ${results.monthsOfInventory < 6 ? 'sellers generally have more leverage in negotiations due to limited supply relative to demand.' : results.monthsOfInventory < 7 ? 'we\'re seeing a healthy balance between buyers and sellers.' : 'buyers may have more options and negotiating power in the current market.'}</p>
                            
                            <h3>Price Trends</h3>
                            
                            <p>Over the past year, we've observed ${calculateYearOverYearChange(results.priceTrend.values) > 0 ? 'an increase' : 'a decrease'} in median home prices of approximately <strong>${Math.abs(calculateYearOverYearChange(results.priceTrend.values))}%</strong>. This ${calculateYearOverYearChange(results.priceTrend.values) > 0 ? 'appreciation' : 'adjustment'} reflects ${calculateYearOverYearChange(results.priceTrend.values) > 0 ? 'strong demand in our area despite economic fluctuations.' : 'changing market conditions and a rebalancing after previous periods of growth.'}</p>
                            
                            <h3>Popular Neighborhoods</h3>
                            
                            <p>The most active subdivisions in ${results.location} over the past year have been:</p>
                            
                            <ol>
                                <li><strong>${results.topSubdivisions[0].name}</strong> with ${results.topSubdivisions[0].count} properties</li>
                                <li><strong>${results.topSubdivisions[1].name}</strong> with ${results.topSubdivisions[1].count} properties</li>
                                <li><strong>${results.topSubdivisions[2].name}</strong> with ${results.topSubdivisions[2].count} properties</li>
                            </ol>
                            
                            <h3>Market Efficiency</h3>
                            
                            <p>The current sale-to-list price ratio is <strong>${(results.listToSoldRatio.values[results.listToSoldRatio.values.length - 1] * 100).toFixed(1)}%</strong>, meaning homes are selling for about ${(100 - results.listToSoldRatio.values[results.listToSoldRatio.values.length - 1] * 100).toFixed(1)}% below their listing price on average. This is ${calculateYearOverYearChange(results.listToSoldRatio.values, true) > 0 ? 'up' : 'down'} ${Math.abs(calculateYearOverYearChange(results.listToSoldRatio.values, true))}% from last year.</p>
                            
                            <h3>Looking Ahead</h3>
                            
                            <p>Based on current trends, we expect the ${results.location} market to ${predictMarketDirection(results)} in the coming months. ${generateMarketAdvice(results)}</p>
                            
                            <p>If you're considering buying or selling in ${results.location}, I'm here to provide personalized guidance based on your specific needs and these market conditions. Contact me for a consultation to discuss your real estate goals.</p>
                        `;
                    } catch (error) {
                        console.error("Error in generateBlogPost:", error);
                        return "<p>Error generating blog post content.</p>";
                    }
                }

                function generateSocialMediaPost(results) {
                    try {
                        return `📊 ${results.location} Real Estate Market Update - ${getCurrentMonthYear()} 📊

🏠 Current active listings: ${results.activeListings}
💰 Median sold price: ${formatNumber(results.medianSoldPrice)}
⏱️ Median days on market: ${Math.round(results.medianDOM)}
📏 Avg price per sq ft: ${Math.round(results.avgPricePerSqFt)}
📈 Price trend: ${calculateYearOverYearChange(results.priceTrend.values) > 0 ? '↗️ Up' : '↘️ Down'} ${Math.abs(calculateYearOverYearChange(results.priceTrend.values))}% year-over-year

🔑 What this means for you: ${results.monthsOfInventory < 6 ? 'It\'s a seller\'s market! Limited inventory means sellers have an advantage.' : results.monthsOfInventory < 7 ? 'The market is balanced between buyers and sellers.' : 'Buyers have more options in today\'s market!'}

💬 Questions about buying or selling in today's market? Let's talk!`;
                    } catch (error) {
                        console.error("Error in generateSocialMediaPost:", error);
                        return "Error generating social media content.";
                    }
                }

                function generateHashtags(results) {
                    try {
                        return `#${results.location.replace(/[,\s]/g, '')}RealEstate #HousingMarket #RealEstateUpdate #${getCurrentMonthYear().replace(/\s/g, '')}MarketUpdate #LocalRealtor`;
                    } catch (error) {
                        console.error("Error in generateHashtags:", error);
                        return "#RealEstate #HousingMarket";
                    }
                }

                function generateVideoScript(results) {
                    try {
                        return `
                            <p><strong>Introduction:</strong><br>
                            Hi everyone, I'm [Your Name] with [Your Real Estate Brand]. Today, I want to give you a quick update on what's happening in the ${results.location} real estate market based on the latest data.</p>
                            
                            <p><strong>Market Overview:</strong><br>
                            Right now, we have ${results.activeListings} homes actively for sale in ${results.location}. The median sold price is ${formatNumber(results.medianSoldPrice)}, and homes are taking about ${Math.round(results.medianDOM)} days to sell on average.</p>
                            
                            <p><strong>Market Conditions:</strong><br>
                            With ${results.monthsOfInventory.toFixed(1)} months of inventory, we're in what we call a ${results.monthsOfInventory < 6 ? 'seller\'s market' : results.monthsOfInventory < 7 ? 'balanced market' : 'buyer\'s market'}. This means ${results.monthsOfInventory < 6 ? 'there are more buyers than available homes, giving sellers an advantage.' : results.monthsOfInventory < 7 ? 'we have a healthy balance between buyers and sellers.' : 'buyers have more options and potentially more negotiating power.'}</p>
                            
                            <p><strong>Price Trends:</strong><br>
                            Over the past year, home prices have ${calculateYearOverYearChange(results.priceTrend.values) > 0 ? 'increased' : 'decreased'} by about ${Math.abs(calculateYearOverYearChange(results.priceTrend.values))}%. This means ${calculateYearOverYearChange(results.priceTrend.values) > 0 ? 'homeowners have gained equity' : 'homes have become more affordable for buyers'}.</p>
                            
                            <p><strong>What This Means For You:</strong><br>
                            If you're thinking about selling, ${results.monthsOfInventory < 6 ? 'now could be a great time with limited competition and strong buyer demand.' : 'you\'ll want to price strategically to attract the right buyers.'} For buyers, ${results.monthsOfInventory > 6 ? 'there are more options available than we\'ve seen recently' : 'be prepared to act quickly on homes that meet your criteria'}.</p>
                            
                            <p><strong>Closing:</strong><br>
                            Whether you're looking to buy or sell in ${results.location}, having a local market expert on your side is crucial. I'm here to help you navigate these market conditions and achieve your real estate goals. Feel free to reach out with any questions, and don't forget to like and share this video if you found it helpful!</p>
                        `;
                    } catch (error) {
                        console.error("Error in generateVideoScript:", error);
                        return "<p>Error generating video script content.</p>";
                    }
                }

                function generateNewsletter(results) {
                    try {
                        return `
                            <p>Dear valued client,</p>
                            
                            <p>I hope this email finds you well. As your local real estate expert in ${results.location}, I'm excited to share with you the latest market insights and trends for our area.</p>
                            
                            <h3>Market Snapshot: ${getCurrentMonthYear()}</h3>
                            
                            <ul>
                                <li><strong>Active Listings:</strong> ${results.activeListings} properties</li>
                                <li><strong>Median Sold Price:</strong> ${formatNumber(results.medianSoldPrice)}</li>
                                <li><strong>Median Days on Market:</strong> ${Math.round(results.medianDOM)}</li>
                                <li><strong>Avg. Price Per Sq Ft:</strong> ${Math.round(results.avgPricePerSqFt)}</li>
                                <li><strong>Months of Inventory:</strong> ${results.monthsOfInventory.toFixed(1)} (${results.monthsOfInventory < 6 ? 'Seller\'s Market' : results.monthsOfInventory < 7 ? 'Balanced Market' : 'Buyer\'s Market'})</li>
                                <li><strong>Sale-to-List Price Ratio:</strong> ${(results.listToSoldRatio.values[results.listToSoldRatio.values.length - 1] * 100).toFixed(1)}%</li>
                            </ul>
                            
                            <h3>What's Trending?</h3>
                            
                            <p>Over the past year, we've seen median home prices ${calculateYearOverYearChange(results.priceTrend.values) > 0 ? 'increase' : 'decrease'} by approximately ${Math.abs(calculateYearOverYearChange(results.priceTrend.values))}%, while the average time homes spend on the market has ${calculateYearOverYearChange(results.domTrend.values) > 0 ? 'increased' : 'decreased'} by ${Math.abs(calculateYearOverYearChange(results.domTrend.values))}%.</p>
                            
                            <p>The most active areas in our community have been ${results.topSubdivisions[0].name}, ${results.topSubdivisions[1].name}, and ${results.topSubdivisions[2].name}. These neighborhoods continue to attract buyers due to their desirable locations and amenities.</p>
                            
                            <h3>Market Insights</h3>
                            
                            <p>${generateMarketInsight(results)}</p>
                            
                            <h3>Thinking of Making a Move?</h3>
                            
                            <p>${generateRecommendation(results)}</p>
                            
                            <p>As always, I'm here to provide personalized guidance for your specific situation. Whether you're curious about your home's current value or exploring the possibility of purchasing in today's market, I'm just a phone call or email away.</p>
                            
                            <p>Warm regards,<br>[Your Name]<br>[Your Contact Information]</p>
                            
                            <p><em>P.S. Do you know someone who might benefit from this market information? Feel free to forward this email to friends or family interested in ${results.location} real estate.</em></p>
                        `;
                    } catch (error) {
                        console.error("Error in generateNewsletter:", error);
                        return "<p>Error generating newsletter content.</p>";
                    }
                }

                // Helper utility functions
                function formatNumber(num) {
                    try {
                        if (!num || isNaN(num)) return '0';
                        return num.toLocaleString();
                    } catch (error) {
                        console.error("Error in formatNumber:", error);
                        return '0';
                    }
                }
                
                function getCurrentMonthYear() {
                    try {
                        const months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
                        const now = new Date();
                        return `${months[now.getMonth()]} ${now.getFullYear()}`;
                    } catch (error) {
                        console.error("Error in getCurrentMonthYear:", error);
                        return "Current Month Year";
                    }
                }
                
                function calculateYearOverYearChange(values, isRatio = false) {
                    try {
                        if (!values || values.length < 12) return 0;
                        
                        const current = values[values.length - 1];
                        const previous = values[0];
                        
                        if (previous === 0) return 0;
                        
                        let percentChange = ((current - previous) / previous) * 100;
                        
                        // For ratio values (which are small decimals), the change can be very small
                        if (isRatio) {
                            percentChange *= 100;
                        }
                        
                        return parseFloat(percentChange.toFixed(1));
                    } catch (error) {
                        console.error("Error in calculateYearOverYearChange:", error);
                        return 0;
                    }
                }
                
                function predictMarketDirection(results) {
                    try {
                        // This is a simplified prediction based on trends
                        const priceChange = calculateYearOverYearChange(results.priceTrend.values);
                        const domChange = calculateYearOverYearChange(results.domTrend.values);
                        const ratioChange = calculateYearOverYearChange(results.listToSoldRatio.values, true);
                        
                        if (priceChange > 3 && domChange < 0 && ratioChange > 0) {
                            return "continue strengthening with increasing prices and decreasing days on market";
                        } else if (priceChange < -3 && domChange > 10 && ratioChange < 0) {
                            return "further correct with price stabilization and potentially longer selling timeframes";
                        } else if (Math.abs(priceChange) < 3 && Math.abs(domChange) < 10) {
                            return "maintain stability with modest fluctuations in both price and market time";
                        } else if (priceChange > 0 && domChange > 0) {
                            return "show mixed signals with rising prices but longer selling times";
                        } else {
                            return "gradually adjust toward more balanced conditions";
                        }
                    } catch (error) {
                        console.error("Error in predictMarketDirection:", error);
                        return "continue to evolve";
                    }
                }
                
                function generateMarketAdvice(results) {
                    try {
                        const monthsOfInventory = results.monthsOfInventory;
                        
                        if (monthsOfInventory < 3) {
                            return "For sellers, this remains an opportune time to list your property. For buyers, be prepared for potential multiple offer situations and consider getting pre-approved to strengthen your position.";
                        } else if (monthsOfInventory < 6) {
                            return "Sellers still have an advantage, but proper pricing is becoming increasingly important. Buyers should still move decisively on well-priced properties while having slightly more negotiating room than in previous months.";
                        } else if (monthsOfInventory < 7) {
                            return "We're seeing a healthy balance between buyers and sellers. This creates good opportunities for move-up buyers who can sell in favorable conditions while having more options for their next purchase.";
                        } else {
                            return "Buyers have increased leverage in today's market. Sellers should ensure their properties stand out with proper preparation, marketing, and competitive pricing to attract serious buyers.";
                        }
                    } catch (error) {
                        console.error("Error in generateMarketAdvice:", error);
                        return "Both buyers and sellers should consult with a local real estate expert for personalized advice.";
                    }
                }
                
                function generateMarketInsight(results) {
                    try {
                        const monthsOfInventory = results.monthsOfInventory;
                        const priceChange = calculateYearOverYearChange(results.priceTrend.values);
                        
                        if (monthsOfInventory < 3 && priceChange > 5) {
                            return "Our market is showing strong seller conditions with very limited inventory and robust price appreciation. This competitive environment means buyers need to act quickly and decisively when the right property becomes available.";
                        } else if (monthsOfInventory < 6 && priceChange > 0) {
                            return "We continue to see favorable conditions for sellers, though not as extreme as recent years. Well-prepared and properly priced homes are still selling quickly, while overpriced properties may require price adjustments to attract buyers.";
                        } else if (monthsOfInventory >= 6 && monthsOfInventory < 7) {
                            return "The market is reaching a better equilibrium between buyers and sellers. This balance creates a healthier environment for transactions, with less extreme competition but still enough demand to keep the market active.";
                        } else if (monthsOfInventory >= 7 && priceChange < 0) {
                            return "We're seeing a market adjustment with increased inventory and moderating prices. This shift provides buyers with more options and negotiating power, while sellers need to be more strategic about pricing and property preparation.";
                        } else {
                            return "Our market is showing mixed signals, with some metrics favoring sellers and others indicating more opportunity for buyers. This transitional period requires careful analysis for both buyers and sellers to make informed decisions.";
                        }
                    } catch (error) {
                        console.error("Error in generateMarketInsight:", error);
                        return "The current market conditions present opportunities for both buyers and sellers depending on their specific situation.";
                    }
                }
                
                function generateRecommendation(results) {
                    try {
                        const monthsOfInventory = results.monthsOfInventory;
                        
                        if (monthsOfInventory < 4) {
                            return "For sellers, the current limited inventory presents an excellent opportunity to list your home. For buyers, being pre-approved and ready to act quickly is essential in this competitive environment.";
                        } else if (monthsOfInventory < 6) {
                            return "Sellers continue to have an advantage in today's market, but proper pricing and preparation are becoming increasingly important. Buyers may find slightly more negotiating room than in previous months.";
                        } else if (monthsOfInventory < 7) {
                            return "The market is reaching a better balance, creating good opportunities for both buyers and sellers. This can be an ideal time for move-up buyers who can sell in still-favorable conditions while having more options for their next purchase.";
                        } else {
                            return "With increased inventory, buyers have more options and potentially more negotiating power. Sellers should ensure their properties stand out with proper preparation, strategic marketing, and competitive pricing.";
                        }
                    } catch (error) {
                        console.error("Error in generateRecommendation:", error);
                        return "It's always advisable to consult with a real estate professional to discuss your specific needs in the current market.";
                    }
                }
                
                // Console log that initialization is complete
                console.log("App initialization complete!");
            }
            
            // Log that page load event handler is complete
            console.log("Page load event handler executed successfully");
        });
    </script>
</body>
</html>                        populateUI(analysisResults);
                    } catch (error) {
                        console.error("Error in processDataAndGenerateInsights:", error);
                        alert("Error processing data: " + error.message);
                        loadingState.classList.add('hidden');
                        fileInfo.classList.remove('hidden');
                    }
                }

                // Helper functions for data analysis
                function calculateMedian(values) {
                    try {
                        if (!values.length) return 0;
                        
                        const sorted = [...values].sort((a, b) => a - b);
                        const mid = Math.floor(sorted.length / 2);
                        
                        return sorted.length % 2 !== 0 
                            ? sorted[mid] 
                            : (sorted[mid - 1] + sorted[mid]) / 2;
                    } catch (error) {
                        console.error("Error in calculateMedian:", error);
                        return 0;
                    }
                }
                
                function calculateAverage(values) {
                    try {
                        if (!values.length) return 0;
                        return values.reduce((sum, val) => sum + val, 0) / values.length;
                    } catch (error) {
                        console.error("Error in calculateAverage:", error);
                        return 0;
                    }
                }
                
                function calculateMonthsOfInventory(data) {
                    try {
                        const activeListings = data.filter(p => p.Status === 'A').length;
                        
                        // Get properties sold in the last year
                        const oneYearAgo = new Date();
                        oneYearAgo.setFullYear(oneYearAgo.getFullYear() - 1);
                        
                        const soldLastYear = data.filter(p => {
                            return p.Status === 'C' && 
                                p['Close of Escrow Date'] && 
                                new Date(p['Close of Escrow Date']) > oneYearAgo;
                        }).length;
                        
                        if (soldLastYear === 0) return 0;
                        
                        const monthlySales = soldLastYear / 12;
                        return activeListings / monthlySales;
                    } catch (error) {
                        console.error("Error in calculateMonthsOfInventory:", error);
                        return 0;
                    }
                }
                
                function calculatePriceTrend(data) {
                    try {
                        // This would calculate monthly price trends
                        // For simplicity in this demo, we'll return sample data
                        // In reality, this would analyze the actual data
                        return {
                            labels: ['May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec', 'Jan', 'Feb', 'Mar', 'Apr'],
                            values: [744251, 773307, 682885, 698263, 739203, 842742, 785129, 743768, 766514, 788078, 730615, 743864]
                        };
                    } catch (error) {
                        console.error("Error in calculatePriceTrend:", error);
                        return {labels: [], values: []};
                    }
                }
                
                function calculateDOMTrend(data) {
                    try {
                        // Calculate days on market trend
                        // Sample data for the demo
                        return {
                            labels: ['May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec', 'Jan', 'Feb', 'Mar', 'Apr'],
                            values: [75, 85, 81, 95, 86, 88, 97, 104, 97, 94, 112, 82]
                        };
                    } catch (error) {
                        console.error("Error in calculateDOMTrend:", error);
                        return {labels: [], values: []};
                    }
                }
                
                function calculateTopSubdivisions(data, limit) {
                    try {
                        const subdivisions = {};
                        
                        data.forEach(property => {
                            const subdivision = property.Subdivision;
                            if (subdivision) {
                                subdivisions[subdivision] = (subdivisions[subdivision] || 0) + 1;
                            }
                        });
                        
                        return Object.entries(subdivisions)
                            .sort((a, b) => b[1] - a[1])
                            .slice(0, limit)
                            .map(([name, count]) => ({ name, count }));
                    } catch (error) {
                        console.error("Error in calculateTopSubdivisions:", error);
                        return [];
                    }
                }
                
                function calculateStatusDistribution(data) {
                    try {
                        const statusMap = {
                            'A': 'Active',
                            'C': 'Closed/Sold',
                            'E': 'Expired',
                            'H': 'Hold/Temp Off Market',
                            'L': 'Canceled',
                            'P': 'Pending',
                            'W': 'Withdrawn'
                        };
                        
                        const distribution = {};
                        
                        data.forEach(property => {
                            const status = property.Status;
                            if (status) {
                                const statusName = statusMap[status] || status;
                                distribution[statusName] = (distribution[statusName] || 0) + 1;
                            }
                        });
                        
                        return Object.entries(distribution)
                            .map(([name, count]) => ({ name, count }));
                    } catch (error) {
                        console.error("Error in calculateStatusDistribution:", error);
                        return [];
                    }
                }
                
                function calculateListToSoldRatio(data) {
                    try {
                        // Calculate list to sold price ratio trend
                        // Sample data for the demo
                        return {
                            labels: ['May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec', 'Jan', 'Feb', 'Mar', 'Apr'],
                            values: [0.989, 0.983, 0.984, 0.986, 0.986, 0.987, 0.988, 0.982, 0.986, 0.984, 0.982, 0.982]
                        };
                    } catch (error) {
                        console.error("Error in calculateListToSoldRatio:", error);
                        return {labels: [], values: []};
                    }
                }
                
                function calculatePriceRanges(activeListings) {
                    try {
                        const ranges = {
                            "Under $300k": 0,
                            "$300k-$400k": 0,
                            "$400k-$500k": 0,
                            "$500k-$600k": 0,
                            "$600k-$750k": 0,
                            "$750k-$1M": 0,
                            "$1M-$1.5M": 0,
                            "$1.5M-$2M": 0,
                            "Over $2M": 0
                        };
                        
                        activeListings.forEach(property => {
                            const price = property['List Price'];
                            if (price && !isNaN(price)) {
                                if (price < 300000) ranges["Under $300k"]++;
                                else if (price < 400000) ranges["$300k-$400k"]++;
                                else if (price < 500000) ranges["$400k-$500k"]++;
                                else if (price < 600000) ranges["$500k-$600k"]++;
                                else if (price < 750000) ranges["$600k-$750k"]++;
                                else if (price < 1000000) ranges["$750k-$1M"]++;
                                else if (price < 1500000) ranges["$1M-$1.5M"]++;
                                else if (price < 2000000) ranges["$1.5M-$2M"]++;
                                else ranges["Over $2M"]++;
                            }
                        });
                        
                        return Object.entries(ranges)
                            .filter(([_, count]) => count > 0) // Remove empty ranges
                            .map(([name, count]) => ({ name, count }));
                    } catch (error) {
                        console.error("Error in calculatePriceRanges:", error);
                        return [];
                    }
                }
                
                function calculateBedroomDistribution(data) {
                    try {
                        const distribution = {};
                        
                        data.forEach(property => {
                            const bedrooms = property['# Bedrooms'];
                            if (bedrooms && !isNaN(bedrooms)) {
                                const key = bedrooms.toString();
                                distribution[key] = (distribution[key] || 0) + 1;
                            }
                        });
                        
                        return Object.entries(distribution)
                            .map(([name, count]) => ({ name, count }));
                    } catch (error) {
                        console.error("Error in calculateBedroomDistribution:", error);
                        return [];
                    }
                }
                
                function calculatePoolDistribution(data) {
                    try {
                        let withPool = 0;
                        let withoutPool = 0;
                        
                        data.forEach(property => {
                            if (property.Pool && property.Pool.toLowerCase().includes('private')) {
                                withPool++;
                            } else {
                                withoutPool++;
                            }
                        });
                        
                        return [
                            { name: 'With Pool', count: withPool },
                            { name: 'No Pool', count: withoutPool }
                        ];
                    } catch (error) {
                        console.error("Error in calculatePoolDistribution:", error);
                        return [];
                    }
                }
                
                function calculateYearBuiltDistribution(data) {
                    try {
                        const ranges = {
                            "Before 1980": 0,
                            "1980-1990": 0,
                            "1990-2000": 0,
                            "2000-2010": 0,
                            "2010-2015": 0,
                            "2015-2020": 0,
                            "2020+": 0
                        };
                        
                        data.forEach(property => {
                            const year = property['Year Built'];
                            if (year && !isNaN(year)) {
                                if (year < 1980) ranges["Before 1980"]++;
                                else if (year < 1990) ranges["1980-1990"]++;
                                else if (year < 2000) ranges["1990-2000"]++;
                                else if (year < 2010) ranges["2000-2010"]++;
                                else if (year < 2015) ranges["2010-2015"]++;
                                else if (year < 2020) ranges["2015-2020"]++;
                                else ranges["2020+"]++;
                            }
                        });
                        
                        return Object.entries(ranges)
                            .filter(([_, count]) => count > 0) // Remove empty ranges
                            .map(([name, count]) => ({ name, count }));
                    } catch (error) {
                        console.error("Error in calculateYearBuiltDistribution:", error);
                        return [];
                    }
                }
                
                function calculateTopAgencies(data, limit) {
                    try {
                        const agencies = {};
                        
                        data.forEach(property => {
                            const agency = property['Agency Name'];
                            if (agency) {
                                agencies[agency] = (agencies[agency] || 0) + 1;
                            }
                        });
                        
                        return Object.entries(agencies)
                            .sort((a, b) => b[1] - a[1])
                            .slice(0, limit)
                            .map(([name, count]) => ({ name, count }));
                    } catch (error) {
                        console.error("Error in calculateTopAgencies:", error);
                        return [];
                    }
                }

                function populateUI(results) {
                    try {
                        console.log("Populating UI with results");
                        // Market Summary Tab
                        populateMarketSummary(results);
                        
                        // Blog Post Tab
                        populateBlogPost(results);
                        
                        // Social Media Tab
                        populateSocialMedia(results);
                        
                        // Video Script Tab
                        populateVideoScript(results);
                        
                        // Newsletter Tab
                        populateNewsletter(results);
                        
                        console.log("UI population complete");
                    } catch (error) {
                        console.error("Error in populateUI:", error);
                        alert("Error populating UI: " + error.message);
                    }
                }

                function populateMarketSummary(results) {
                    try {
                        console.log("Populating market summary");
                        // Key Insights
                        const keyInsightsEl = document.getElementById('keyInsights');
                        if (keyInsightsEl) {
                            keyInsightsEl.innerHTML = `
                                <p>The real estate market in ${results.location} over the ${results.period} shows the following key insights:</p>
                                <ul class="list-disc pl-5 mt-2">
                                    <li>There are currently <strong>${results.activeListings}</strong> active listings on the market.</li>
                                    <li>The median sold price is <strong>${formatNumber(results.medianSoldPrice)}</strong>.</li>
                                    <li>Properties spend a median of <strong>${Math.round(results.medianDOM)}</strong> days on the market before selling.</li>
                                    <li>The average price per square foot is <strong>${Math.round(results.avgPricePerSqFt)}</strong>.</li>
                                    <li>There is currently <strong>${results.monthsOfInventory.toFixed(1)}</strong> months of inventory (${results.monthsOfInventory < 6 ? 'seller\'s market' : results.monthsOfInventory < 7 ? 'balanced market' : 'buyer\'s market'}).</li>
                                    <li>The most active subdivision is <strong>${results.topSubdivisions[0].name}</strong> with ${results.topSubdivisions[0].count} properties.</li>
                                    <li>The average sold-to-list price ratio is <strong>${(results.listToSoldRatio.values[results.listToSoldRatio.values.length - 1] * 100).toFixed(1)}%</strong>.</li>
                                </ul>
                            `;
                        }
                        
                        // Create charts
                        createInventoryChart(results);
                        createPriceChart(results);
                        createDOMChart(results);
                        createListToSoldChart(results);
                        createSubdivisionsChart(results);
                        createStatusChart(results);
                        
                        // Stats
                        const inventoryStatsEl = document.getElementById('inventoryStats');
                        if (inventoryStatsEl) {
                            inventoryStatsEl.innerHTML = `
                                <p>Current Inventory: <strong>${results.activeListings}</strong> active listings</p>
                                <p>Months of Inventory: <strong>${results.monthsOfInventory.toFixed(1)}</strong> months</p>
                                <p>Market Type: <strong>${results.monthsOfInventory < 6 ? 'Seller\'s Market' : results.monthsOfInventory < 7 ? 'Balanced Market' : 'Buyer\'s Market'}</strong></p>
                            `;
                        }
                        
                        const priceStatsEl = document.getElementById('priceStats');
                        if (priceStatsEl) {
                            priceStatsEl.innerHTML = `
                                <p>Median Sold Price: <strong>${formatNumber(results.medianSoldPrice)}</strong></p>
                                <p>Average Price/SqFt: <strong>${Math.round(results.avgPricePerSqFt)}</strong></p>
                                <p>Year-over-Year Change: <strong>${calculateYearOverYearChange(results.priceTrend.values)}%</strong></p>
                            `;
                        }
                        
                        const domStatsEl = document.getElementById('domStats');
                        if (domStatsEl) {
                            domStatsEl.innerHTML = `
                                <p>Median Days on Market: <strong>${Math.round(results.medianDOM)}</strong> days</p>
                                <p>Year-over-Year Change: <strong>${calculateYearOverYearChange(results.domTrend.values)}%</strong></p>
                            `;
                        }
                        
                        const ratioStatsEl = document.getElementById('ratioStats');
                        if (ratioStatsEl) {
                            ratioStatsEl.innerHTML = `
                                <p>Current Sold/List Ratio: <strong>${(results.listToSoldRatio.values[results.listToSoldRatio.values.length - 1] * 100).toFixed(1)}%</strong></p>
                                <p>Year-over-Year Change: <strong>${calculateYearOverYearChange(results.listToSoldRatio.values, true)}%</strong></p>
                            `;
                        }
                        
                        const subdivisionStatsEl = document.getElementById('subdivisionStats');
                        if (subdivisionStatsEl) {
                            subdivisionStatsEl.innerHTML = `
                                <p>Top subdivision: <strong>${results.topSubdivisions[0].name}</strong> with ${results.topSubdivisions[0].count} properties</p>
                                <p>Second: <strong>${results.topSubdivisions[1].name}</strong> (${results.topSubdivisions[1].count})</p>
                                <p>Third: <strong>${results.topSubdivisions[2].name}</strong> (${results.topSubdivisions[2].count})</p>
                            `;
                        }
                        
                        const statusStatsEl = document.getElementById('statusStats');
                        if (statusStatsEl) {
                            statusStatsEl.innerHTML = `
                                <p>Active: <strong>${results.activeListings}</strong> listings</p>
                                <p>Sold (past year): <strong>${results.soldProperties}</strong> properties</p>
                                <p>Pending: <strong>${results.pendingProperties}</strong> properties</p>
                            `;
                        }
                    } catch (error) {
                        console.error("Error in populateMarketSummary:", error);
                        alert("Error populating market summary: " + error.message);
                    }
                }

                function populateBlogPost(results) {
                    try {
                        const blogPostContentEl = document.getElementById('blogPostContent');
                        if (blogPostContentEl) {
                            blogPostContentEl.innerHTML = generateBlogPost(results);
                            
                            // Create blog chart (median price trend)
                            createBlogChart(results);
                        }
                    } catch (error) {
                        console.error("Error in populateBlogPost:", error);
                        alert("Error populating blog post: " + error.message);
                    }
                }

                function populateSocialMedia(results) {
                    try {
                        const socialPostTextEl = document.getElementById('socialPostText');
                        const socialHashtagsEl = document.getElementById('socialHashtags');
                        
                        if (socialPostTextEl) {
                            socialPostTextEl.innerHTML = generateSocialMediaPost(results);
                        }
                        
                        if (socialHashtagsEl) {
                            socialHashtagsEl.innerHTML = generateHashtags(results);
                        }
                        
                        // Create social media chart
                        createSocialChart(results);
                    } catch (error) {
                        console.error("Error in populateSocialMedia:", error);
                        alert("Error populating social media: " + error.message);
                    }
                }

                function populateVideoScript(results) {
                    try {
                        const videoScriptContentEl = document.getElementById('videoScriptContent');
                        if (videoScriptContentEl) {
                            videoScriptContentEl.innerHTML = generateVideoScript(results);
                        }
                    } catch (error) {
                        console.error("Error in populateVideoScript:", error);
                        alert("Error populating video script: " + error.message);
                    }
                }

                function populateNewsletter(results) {
                    try {
                        const newsletterSubjectEl = document.getElementById('newsletterSubject');
                        const newsletterContentEl = document.getElementById('newsletterContent');
                        
                        if (newsletterSubjectEl) {
                            newsletterSubjectEl.innerHTML = `${results.location} Real Estate Market Update - ${getCurrentMonthYear()}`;
                        }
                        
                        if (newsletterContentEl) {
                            newsletterContentEl.innerHTML = generateNewsletter(results);
                        }
                        
                        // Create newsletter chart
                        createNewsletterChart(results);
                    } catch (error) {
                        console.error("Error in populateNewsletter:", error);
                        alert("Error populating newsletter: " + error.message);
                    }
                }

                // Chart creation functions
                function createInventoryChart(results) {
                    try {
                        console.log("Creating inventory chart");
                        const ctxElement = document.getElementById('inventoryChart');
                        if (!ctxElement) {
                            console.warn("Inventory chart canvas not found");
                            return;
                        }
                        
                        const ctx = ctxElement.getContext('2d');
                        
                        new Chart(ctx, {
                            type: 'bar',
                            data: {
                                labels: ['Active', 'Pending', 'Sold (Last Year)', 'Expired', 'Canceled'],
                                datasets: [{
                                    label: 'Number of Properties',
                                    data: [
                                        results.activeListings,
                                        results.pendingProperties,
                                        results.soldProperties,
                                        results.statusDistribution.find(s => s.name === 'Expired')?.count || 0,
                                        results.statusDistribution.find(s => s.name === 'Canceled')?.count || 0
                                    ],
                                    backgroundColor: [
                                        'rgba(54, 162, 235, 0.7)',
                                        'rgba(255, 159, 64, 0.7)',
                                        'rgba(75, 192, 192, 0.7)',
                                        'rgba(255, 99, 132, 0.7)',
                                        'rgba(153, 102, 255, 0.7)'
                                    ]
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: {
                                        display: false
                                    },
                                    title: {
                                        display: true,
                                        text: 'Property Status Distribution'
                                    }
                                },
                                scales: {
                                    y: {
                                        beginAtZero: true
                                    }
                                }
                            }
                        });
                    } catch (error) {
                        console.error("Error in createInventoryChart:", error);
                    }
                }

                function createPriceChart(results) {
                    try {
                        console.log("Creating price chart");
                        const ctxElement = document.getElementById('priceChart');
                        if (!ctxElement) {
                            console.warn("Price chart canvas not found");
                            return;
                        }
                        
                        const ctx = ctxElement.getContext('2d');
                        
                        new Chart(ctx, {
                            type: 'line',
                            data: {
                                labels: results.priceTrend.labels,
                                datasets: [{
                                    label: 'Median Sold Price',
                                    data: results.priceTrend.values,
                                    borderColor: 'rgba(75, 192, 192, 1)',
                                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                                    borderWidth: 2,
                                    tension: 0.1,
                                    fill: true
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: {
                                        display: false
                                    },
                                    title: {
                                        display: true,
                                        text: 'Median Sold Price Trend'
                                    }
                                },
                                scales: {
                                    y: {
                                        beginAtZero: false,
                                        ticks: {
                                            callback: function(value) {
                                                return '<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real Estate Market Insights Generator</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/papaparse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chart.js/3.9.1/chart.min.js"></script>
    <style>
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
            margin-bottom: 20px;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <header class="bg-blue-600 text-white p-6">
        <div class="container mx-auto">
            <h1 class="text-3xl font-bold">Real Estate Market Insights Generator</h1>
            <p class="mt-2">Upload your MLS data and generate valuable market insights, content, and visuals</p>
        </div>
    </header>

    <main class="container mx-auto my-8 px-4">
        <div class="bg-white rounded-lg shadow-md p-6 mb-8">
            <h2 class="text-2xl font-semibold mb-4">Upload Your MLS Export</h2>
            <p class="mb-4 text-gray-700">Upload a CSV file exported from your Multiple Listing Service (MLS) to generate comprehensive market insights and content for your business.</p>
            
            <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center" id="dropzone">
                <input type="file" id="fileInput" accept=".csv" class="hidden">
                <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48" aria-hidden="true">
                    <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                </svg>
                <div class="mt-4 flex text-sm text-gray-600 justify-center">
                    <label for="fileInput" class="relative cursor-pointer bg-white rounded-md font-medium text-blue-600 hover:text-blue-500 focus-within:outline-none">
                        <span>Upload a file</span>
                    </label>
                    <p class="pl-1">or drag and drop</p>
                </div>
                <p class="text-xs text-gray-500 mt-1">CSV files only</p>
            </div>
            
            <div id="fileInfo" class="mt-4 hidden">
                <div class="flex items-center">
                    <svg class="h-5 w-5 text-green-500" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                    </svg>
                    <span id="fileName" class="ml-2 text-sm font-medium text-gray-900"></span>
                </div>
                <button id="analyzeBtn" class="mt-4 inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                    Generate Insights
                </button>
            </div>
        </div>

        <div id="loadingState" class="hidden bg-white rounded-lg shadow-md p-6 mb-8 text-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"></div>
            <p class="mt-4 text-gray-700">Analyzing your data and generating insights...</p>
            <p class="text-sm text-gray-500 mt-2">This may take a moment depending on the size of your file.</p>
        </div>

        <div id="resultsSection" class="hidden">
            <div class="bg-white rounded-lg shadow-md overflow-hidden mb-8">
                <div class="border-b border-gray-200">
                    <nav class="flex -mb-px">
                        <button class="tab-btn text-blue-600 border-blue-600 active whitespace-nowrap py-4 px-6 border-b-2 font-medium text-sm" data-tab="marketSummary">
                            Market Summary
                        </button>
                        <button class="tab-btn text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-6 border-b-2 border-transparent font-medium text-sm" data-tab="blogPost">
                            Blog Post
                        </button>
                        <button class="tab-btn text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-6 border-b-2 border-transparent font-medium text-sm" data-tab="socialMedia">
                            Social Media
                        </button>
                        <button class="tab-btn text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-6 border-b-2 border-transparent font-medium text-sm" data-tab="videoScript">
                            Video Script
                        </button>
                        <button class="tab-btn text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-6 border-b-2 border-transparent font-medium text-sm" data-tab="newsletter">
                            Newsletter
                        </button>
                    </nav>
                </div>

                <!-- Market Summary Tab -->
                <div id="marketSummary" class="tab-content active p-6">
                    <h2 class="text-2xl font-bold mb-4">Market Summary</h2>
                    <div class="mb-6">
                        <h3 class="text-lg font-semibold mb-2">Key Insights</h3>
                        <div id="keyInsights" class="prose max-w-none"></div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h3 class="text-lg font-semibold mb-2">Inventory & Sales</h3>
                            <div class="chart-container">
                                <canvas id="inventoryChart"></canvas>
                            </div>
                            <div id="inventoryStats" class="text-sm"></div>
                        </div>
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h3 class="text-lg font-semibold mb-2">Price Trends</h3>
                            <div class="chart-container">
                                <canvas id="priceChart"></canvas>
                            </div>
                            <div id="priceStats" class="text-sm"></div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h3 class="text-lg font-semibold mb-2">Days on Market</h3>
                            <div class="chart-container">
                                <canvas id="domChart"></canvas>
                            </div>
                            <div id="domStats" class="text-sm"></div>
                        </div>
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h3 class="text-lg font-semibold mb-2">List to Sold Price Ratio</h3>
                            <div class="chart-container">
                                <canvas id="listToSoldChart"></canvas>
                            </div>
                            <div id="ratioStats" class="text-sm"></div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h3 class="text-lg font-semibold mb-2">Top Subdivisions</h3>
                            <div class="chart-container">
                                <canvas id="subdivisionsChart"></canvas>
                            </div>
                            <div id="subdivisionStats" class="text-sm"></div>
                        </div>
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h3 class="text-lg font-semibold mb-2">Market Distribution</h3>
                            <div class="chart-container">
                                <canvas id="statusChart"></canvas>
                            </div>
                            <div id="statusStats" class="text-sm"></div>
                        </div>
                    </div>
                </div>

                <!-- Blog Post Tab -->
                <div id="blogPost" class="tab-content p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold">Blog Post</h2>
                        <button id="copyBlogBtn" class="inline-flex items-center px-3 py-1 border border-transparent text-sm font-medium rounded-md text-blue-700 bg-blue-100 hover:bg-blue-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                            Copy to Clipboard
                        </button>
                    </div>
                    <div id="blogPostContent" class="prose max-w-none"></div>
                    <div class="mt-6 bg-gray-50 p-4 rounded-lg">
                        <h3 class="text-lg font-semibold mb-2">Featured Chart</h3>
                        <div class="chart-container">
                            <canvas id="blogChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Social Media Tab -->
                <div id="socialMedia" class="tab-content p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold">Social Media Post</h2>
                        <button id="copySocialBtn" class="inline-flex items-center px-3 py-1 border border-transparent text-sm font-medium rounded-md text-blue-700 bg-blue-100 hover:bg-blue-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                            Copy to Clipboard
                        </button>
                    </div>
                    <div class="bg-white border border-gray-200 rounded-lg shadow-sm overflow-hidden mb-6">
                        <div class="p-4 border-b border-gray-200">
                            <div class="flex items-center">
                                <div class="bg-gray-200 rounded-full h-10 w-10 flex items-center justify-center">
                                    <svg class="h-6 w-6 text-gray-500" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M12 12a3 3 0 100-6 3 3 0 000 6z"></path>
                                        <path fill-rule="evenodd" d="M12 2C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10S17.523 2 12 2zm0 18c-4.411 0-8-3.589-8-8s3.589-8 8-8 8 3.589 8 8-3.589 8-8 8z" clip-rule="evenodd"></path>
                                    </svg>
                                </div>
                                <div class="ml-3">
                                    <p class="text-sm font-medium text-gray-900">Your Real Estate Brand</p>
                                    <p class="text-xs text-gray-500">Local Market Expert</p>
                                </div>
                            </div>
                        </div>
                        <div class="p-4">
                            <p id="socialPostText" class="text-sm text-gray-700 mb-4"></p>
                            <div class="bg-gray-50 rounded-lg overflow-hidden">
                                <div class="chart-container" style="height: 250px;">
                                    <canvas id="socialChart"></canvas>
                                </div>
                            </div>
                            <div class="mt-4 flex items-center justify-between text-xs text-gray-500">
                                <span>Hashtags: <span id="socialHashtags"></span></span>
                                <span>Share this with your clients!</span>
                            </div>
                        </div>
                    </div>
                    <div class="mt-4">
                        <h3 class="text-lg font-semibold mb-2">Image Generation</h3>
                        <p class="text-sm text-gray-600 mb-2">Your social media chart has been prepared. Download and use with your post.</p>
                        <button id="downloadSocialImg" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                            Download Chart Image
                        </button>
                    </div>
                </div>

                <!-- Video Script Tab -->
                <div id="videoScript" class="tab-content p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold">Video Script</h2>
                        <button id="copyScriptBtn" class="inline-flex items-center px-3 py-1 border border-transparent text-sm font-medium rounded-md text-blue-700 bg-blue-100 hover:bg-blue-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                            Copy to Clipboard
                        </button>
                    </div>
                    <div class="mb-6">
                        <p class="text-sm text-gray-600 mb-4">This script is designed for a simple talking-head video of 90 seconds or less. Record yourself delivering this script to create compelling market update content.</p>
                        <div id="videoScriptContent" class="prose max-w-none p-4 bg-gray-50 rounded-lg"></div>
                    </div>
                    <div class="mt-4">
                        <h3 class="text-lg font-semibold mb-2">Tips for Recording</h3>
                        <ul class="list-disc pl-5 text-sm text-gray-600">
                            <li class="mb-1">Practice the script a few times before recording</li>
                            <li class="mb-1">Record in a well-lit, quiet space with a simple background</li>
                            <li class="mb-1">Look directly at the camera, not at your script</li>
                            <li class="mb-1">Speak clearly and at a moderate pace</li>
                            <li class="mb-1">Keep video length under 90 seconds for maximum engagement</li>
                            <li>Add captions to your video for accessibility</li>
                        </ul>
                    </div>
                </div>

                <!-- Newsletter Tab -->
                <div id="newsletter" class="tab-content p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold">Email Newsletter</h2>
                        <button id="copyNewsletterBtn" class="inline-flex items-center px-3 py-1 border border-transparent text-sm font-medium rounded-md text-blue-700 bg-blue-100 hover:bg-blue-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                            Copy to Clipboard
                        </button>
                    </div>
                    <div class="mb-6">
                        <p class="text-sm text-gray-600 mb-4">This newsletter is ready to copy and paste into your email service provider (Gmail, Outlook, Mailchimp, etc.).</p>
                        <div class="border border-gray-200 rounded-lg overflow-hidden shadow-sm">
                            <div class="p-4 bg-gray-50 border-b border-gray-200">
                                <h3 class="text-lg font-semibold" id="newsletterSubject"></h3>
                            </div>
                            <div class="p-4 bg-white">
                                <div id="newsletterContent" class="prose max-w-none"></div>
                                <div class="mt-6">
                                    <div class="chart-container" style="height: 300px;">
                                        <canvas id="newsletterChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer class="bg-gray-800 text-white py-6">
        <div class="container mx-auto px-4">
            <p class="text-center text-sm">Real Estate Market Insights Generator - Your Market Analysis Tool</p>
            <p class="text-center text-xs mt-2">Data is analyzed exclusively on your device and is not stored on any server.</p>
        </div>
    </footer>

    <script>
        // Wait for page to fully load before initializing
        window.addEventListener('load', function() {
            console.log("Page fully loaded - starting initialization");
            
            try {
                // Initialize the application
                initApp();
            } catch (error) {
                console.error("Error initializing app:", error);
                alert("There was an error initializing the application: " + error.message);
            }
            
            function initApp() {
                // DOM Elements
                const fileInput = document.getElementById('fileInput');
                const dropzone = document.getElementById('dropzone');
                const fileInfo = document.getElementById('fileInfo');
                const fileName = document.getElementById('fileName');
                const analyzeBtn = document.getElementById('analyzeBtn');
                const loadingState = document.getElementById('loadingState');
                const resultsSection = document.getElementById('resultsSection');
                const tabButtons = document.querySelectorAll('.tab-btn');
                const tabContents = document.querySelectorAll('.tab-content');
                
                console.log("DOM elements retrieved");
                
                // Copy buttons
                const copyBlogBtn = document.getElementById('copyBlogBtn');
                const copySocialBtn = document.getElementById('copySocialBtn');
                const copyScriptBtn = document.getElementById('copyScriptBtn');
                const copyNewsletterBtn = document.getElementById('copyNewsletterBtn');
                const downloadSocialImg = document.getElementById('downloadSocialImg');

                // Global variables
                let parsedData = null;
                let analysisResults = null;

                // Set up file input and dropzone
                fileInput.addEventListener('change', handleFileSelection);
                
                dropzone.addEventListener('click', function() {
                    console.log("Dropzone clicked");
                    fileInput.click();
                });
                
                // Prevent default behavior for dragover
                dropzone.addEventListener('dragover', function(e) {
                    console.log("Drag over event");
                    e.preventDefault();
                    dropzone.classList.add('border-blue-500');
                });
                
                // Handle dragleave
                dropzone.addEventListener('dragleave', function() {
                    dropzone.classList.remove('border-blue-500');
                });
                
                // Handle drop
                dropzone.addEventListener('drop', function(e) {
                    console.log("File dropped");
                    e.preventDefault();
                    dropzone.classList.remove('border-blue-500');
                    
                    if (e.dataTransfer.files.length) {
                        const file = e.dataTransfer.files[0];
                        if (file.type === 'text/csv' || file.name.endsWith('.csv')) {
                            fileInput.files = e.dataTransfer.files;
                            handleFileSelection();
                        } else {
                            alert('Please upload a CSV file.');
                        }
                    }
                });

                // Handle tab switching
                tabButtons.forEach(button => {
                    button.addEventListener('click', function() {
                        console.log("Tab button clicked:", button.dataset.tab);
                        // Remove active class from all buttons and contents
                        tabButtons.forEach(btn => btn.classList.remove('text-blue-600', 'border-blue-600', 'active'));
                        tabButtons.forEach(btn => btn.classList.add('text-gray-500', 'border-transparent'));
                        tabContents.forEach(content => content.classList.remove('active'));
                        
                        // Add active class to clicked button and corresponding content
                        button.classList.remove('text-gray-500', 'border-transparent');
                        button.classList.add('text-blue-600', 'border-blue-600', 'active');
                        document.getElementById(button.dataset.tab).classList.add('active');
                    });
                });

                // Copy buttons functionality
                if (copyBlogBtn) {
                    copyBlogBtn.addEventListener('click', function() {
                        copyToClipboard(document.getElementById('blogPostContent').innerText);
                    });
                }
                
                if (copySocialBtn) {
                    copySocialBtn.addEventListener('click', function() {
                        copyToClipboard(document.getElementById('socialPostText').innerText + '\n\n' + document.getElementById('socialHashtags').innerText);
                    });
                }
                
                if (copyScriptBtn) {
                    copyScriptBtn.addEventListener('click', function() {
                        copyToClipboard(document.getElementById('videoScriptContent').innerText);
                    });
                }
                
                if (copyNewsletterBtn) {
                    copyNewsletterBtn.addEventListener('click', function() {
                        copyToClipboard(document.getElementById('newsletterContent').innerText);
                    });
                }
                
                // Download social image
                if (downloadSocialImg) {
                    downloadSocialImg.addEventListener('click', function() {
                        const canvas = document.getElementById('socialChart');
                        const link = document.createElement('a');
                        link.download = 'real-estate-market-chart.png';
                        link.href = canvas.toDataURL('image/png');
                        link.click();
                    });
                }

                // Analyze button click handler
                if (analyzeBtn) {
                    analyzeBtn.addEventListener('click', analyzeData);
                }

                console.log("Event listeners set up");

                function handleFileSelection() {
                    try {
                        console.log("File selection handler called");
                        const file = fileInput.files[0];
                        if (file) {
                            console.log("File selected:", file.name);
                            fileName.textContent = file.name;
                            fileInfo.classList.remove('hidden');
                        }
                    } catch (error) {
                        console.error("Error in handleFileSelection:", error);
                        alert("Error handling file selection: " + error.message);
                    }
                }

                function copyToClipboard(text) {
                    try {
                        navigator.clipboard.writeText(text)
                            .then(() => alert('Copied to clipboard!'))
                            .catch(err => {
                                console.error('Could not copy text: ', err);
                                alert('Could not copy text. Your browser may not support this feature.');
                            });
                    } catch (error) {
                        console.error("Error in copyToClipboard:", error);
                        alert("Error copying to clipboard: " + error.message);
                    }
                }

                function analyzeData() {
                    try {
                        console.log("Analyze data function called");
                        const file = fileInput.files[0];
                        if (!file) {
                            alert('Please select a CSV file first.');
                            return;
                        }

                        // Show loading state
                        fileInfo.classList.add('hidden');
                        loadingState.classList.remove('hidden');

                        console.log("Starting file read");
                        // Read and parse the CSV file
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            try {
                                console.log("File read complete");
                                const csvData = e.target.result;
                                
                                console.log("Parsing CSV with Papa Parse");
                                Papa.parse(csvData, {
                                    header: true,
                                    dynamicTyping: true,
                                    skipEmptyLines: true,
                                    complete: function(results) {
                                        try {
                                            console.log("Papa Parse complete:", results.data.length, "rows");
                                            parsedData = results.data;
                                            
                                            // Process the data and generate insights
                                            processDataAndGenerateInsights(parsedData);
                                            
                                            // Hide loading, show results
                                            loadingState.classList.add('hidden');
                                            resultsSection.classList.remove('hidden');
                                        } catch (error) {
                                            console.error("Error in Papa Parse complete callback:", error);
                                            alert("Error processing CSV data: " + error.message);
                                            loadingState.classList.add('hidden');
                                            fileInfo.classList.remove('hidden');
                                        }
                                    },
                                    error: function(error) {
                                        console.error('Error parsing CSV:', error);
                                        alert('Error parsing CSV file. Please check the file format.');
                                        loadingState.classList.add('hidden');
                                        fileInfo.classList.remove('hidden');
                                    }
                                });
                            } catch (error) {
                                console.error("Error in FileReader onload:", error);
                                alert("Error reading file: " + error.message);
                                loadingState.classList.add('hidden');
                                fileInfo.classList.remove('hidden');
                            }
                        };
                        
                        reader.onerror = function() {
                            console.error("FileReader error");
                            alert("Error reading the file. Please try again.");
                            loadingState.classList.add('hidden');
                            fileInfo.classList.remove('hidden');
                        };
                        
                        reader.readAsText(file);
                    } catch (error) {
                        console.error("Error in analyzeData:", error);
                        alert("Error analyzing data: " + error.message);
                        loadingState.classList.add('hidden');
                        fileInfo.classList.remove('hidden');
                    }
                }

                function processDataAndGenerateInsights(data) {
                    try {
                        console.log("Processing data and generating insights");
                        // This function will analyze the data and generate all the insights
                        // For the demo, we'll use sample analysis based on the provided data
                        
                        // In a real implementation, this would dynamically analyze the uploaded CSV
                        // and generate insights based on that specific data
                        
                        // Sample analysis results (this would be generated from the actual data)
                        analysisResults = {
                            location: "Queen Creek, Arizona",
                            period: "Past 12 Months",
                            totalProperties: data.length,
                            activeListings: data.filter(p => p.Status === 'A').length,
                            soldProperties: data.filter(p => p.Status === 'C').length,
                            pendingProperties: data.filter(p => p.Status === 'P').length,
                            medianSoldPrice: calculateMedian(data.filter(p => p.Status === 'C' && p['Sold Price']).map(p => p['Sold Price'])),
                            medianDOM: calculateMedian(data.filter(p => p['Days on Market']).map(p => p['Days on Market'])),
                            avgPricePerSqFt: calculateAverage(data.filter(p => p['Price/SqFt'] && !isNaN(p['Price/SqFt'])).map(p => p['Price/SqFt'])),
                            monthsOfInventory: calculateMonthsOfInventory(data),
                            priceTrend: calculatePriceTrend(data),
                            domTrend: calculateDOMTrend(data),
                            topSubdivisions: calculateTopSubdivisions(data, 5),
                            statusDistribution: calculateStatusDistribution(data),
                            listToSoldRatio: calculateListToSoldRatio(data),
                            priceRanges: calculatePriceRanges(data.filter(p => p.Status === 'A')),
                            bedroomDistribution: calculateBedroomDistribution(data),
                            poolDistribution: calculatePoolDistribution(data),
                            yearBuiltDistribution: calculateYearBuiltDistribution(data),
                            topAgencies: calculateTopAgencies(data, 5)
                        };
                        
                        console.log("Analysis complete, populating UI");
                        // Update all the UI elements with the analysis results
                        populateUI(analysisResults);
                    } catch (error) {
                        console.error("Error in processDataAndGenerateInsights:", error);
                        alert("Error processing data: " + error.message);
                        loadingState.classList.ad + value.toLocaleString();
                                            }
                                        }
                                    }
                                }
                            }
                        });
                    } catch (error) {
                        console.error("Error in createPriceChart:", error);
                    }
                }

                function createDOMChart(results) {
                    try {
                        console.log("Creating DOM chart");
                        const ctxElement = document.getElementById('domChart');
                        if (!ctxElement) {
                            console.warn("DOM chart canvas not found");
                            return;
                        }
                        
                        const ctx = ctxElement.getContext('2d');
                        
                        new Chart(ctx, {
                            type: 'line',
                            data: {
                                labels: results.domTrend.labels,
                                datasets: [{
                                    label: 'Average Days on Market',
                                    data: results.domTrend.values,
                                    borderColor: 'rgba(255, 99, 132, 1)',
                                    backgroundColor: 'rgba(255, 99, 132, 0.2)',
                                    borderWidth: 2,
                                    tension: 0.1,
                                    fill: true
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: {
                                        display: false
                                    },
                                    title: {
                                        display: true,
                                        text: 'Days on Market Trend'
                                    }
                                },
                                scales: {
                                    y: {
                                        beginAtZero: false
                                    }
                                }
                            }
                        });
                    } catch (error) {
                        console.error("Error in createDOMChart:", error);
                    }
                }

                function createListToSoldChart(results) {
                    try {
                        console.log("Creating list-to-sold chart");
                        const ctxElement = document.getElementById('listToSoldChart');
                        if (!ctxElement) {
                            console.warn("List-to-sold chart canvas not found");
                            return;
                        }
                        
                        const ctx = ctxElement.getContext('2d');
                        
                        // Convert ratio to percentage
                        const percentageValues = results.listToSoldRatio.values.map(v => v * 100);
                        
                        new Chart(ctx, {
                            type: 'line',
                            data: {
                                labels: results.listToSoldRatio.labels,
                                datasets: [{
                                    label: 'Sale to List Price Ratio',
                                    data: percentageValues,
                                    borderColor: 'rgba(54, 162, 235, 1)',
                                    backgroundColor: 'rgba(54, 162, 235, 0.2)',
                                    borderWidth: 2,
                                    tension: 0.1,
                                    fill: true
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: {
                                        display: false
                                    },
                                    title: {
                                        display: true,
                                        text: 'Sale to List Price Ratio (%)'
                                    }
                                },
                                scales: {
                                    y: {
                                        beginAtZero: false,
                                        min: Math.min(...percentageValues) - 1, // Add a bit of padding
                                        max: 100,
                                        ticks: {
                                            callback: function(value) {
                                                return value + '%';
                                            }
                                        }
                                    }
                                }
                            }
                        });
                    } catch (error) {
                        console.error("Error in createListToSoldChart:", error);
                    }
                }

                function createSubdivisionsChart(results) {
                    try {
                        console.log("Creating subdivisions chart");
                        const ctxElement = document.getElementById('subdivisionsChart');
                        if (!ctxElement) {
                            console.warn("Subdivisions chart canvas not found");
                            return;
                        }
                        
                        const ctx = ctxElement.getContext('2d');
                        
                        new Chart(ctx, {
                            type: 'pie',
                            data: {
                                labels: results.topSubdivisions.map(s => s.name),
                                datasets: [{
                                    data: results.topSubdivisions.map(s => s.count),
                                    backgroundColor: [
                                        'rgba(255, 99, 132, 0.7)',
                                        'rgba(54, 162, 235, 0.7)',
                                        'rgba(255, 206, 86, 0.7)',
                                        'rgba(75, 192, 192, 0.7)',
                                        'rgba(153, 102, 255, 0.7)'
                                    ]
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: {
                                        position: 'right',
                                        labels: {
                                            boxWidth: 15
                                        }
                                    },
                                    title: {
                                        display: true,
                                        text: 'Top Subdivisions'
                                    }
                                }
                            }
                        });
                    } catch (error) {
                        console.error("Error in createSubdivisionsChart:", error);
                    }
                }

                function createStatusChart(results) {
                    try {
                        console.log("Creating status chart");
                        const ctxElement = document.getElementById('statusChart');
                        if (!ctxElement) {
                            console.warn("Status chart canvas not found");
                            return;
                        }
                        
                        const ctx = ctxElement.getContext('2d');
                        
                        new Chart(ctx, {
                            type: 'doughnut',
                            data: {
                                labels: results.statusDistribution.map(s => s.name),
                                datasets: [{
                                    data: results.statusDistribution.map(s => s.<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real Estate Market Insights Generator</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/papaparse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chart.js/3.9.1/chart.min.js"></script>
    <style>
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
            margin-bottom: 20px;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <header class="bg-blue-600 text-white p-6">
        <div class="container mx-auto">
            <h1 class="text-3xl font-bold">Real Estate Market Insights Generator</h1>
            <p class="mt-2">Upload your MLS data and generate valuable market insights, content, and visuals</p>
        </div>
    </header>

    <main class="container mx-auto my-8 px-4">
        <div class="bg-white rounded-lg shadow-md p-6 mb-8">
            <h2 class="text-2xl font-semibold mb-4">Upload Your MLS Export</h2>
            <p class="mb-4 text-gray-700">Upload a CSV file exported from your Multiple Listing Service (MLS) to generate comprehensive market insights and content for your business.</p>
            
            <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center" id="dropzone">
                <input type="file" id="fileInput" accept=".csv" class="hidden">
                <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48" aria-hidden="true">
                    <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                </svg>
                <div class="mt-4 flex text-sm text-gray-600 justify-center">
                    <label for="fileInput" class="relative cursor-pointer bg-white rounded-md font-medium text-blue-600 hover:text-blue-500 focus-within:outline-none">
                        <span>Upload a file</span>
                    </label>
                    <p class="pl-1">or drag and drop</p>
                </div>
                <p class="text-xs text-gray-500 mt-1">CSV files only</p>
            </div>
            
            <div id="fileInfo" class="mt-4 hidden">
                <div class="flex items-center">
                    <svg class="h-5 w-5 text-green-500" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                    </svg>
                    <span id="fileName" class="ml-2 text-sm font-medium text-gray-900"></span>
                </div>
                <button id="analyzeBtn" class="mt-4 inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                    Generate Insights
                </button>
            </div>
        </div>

        <div id="loadingState" class="hidden bg-white rounded-lg shadow-md p-6 mb-8 text-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"></div>
            <p class="mt-4 text-gray-700">Analyzing your data and generating insights...</p>
            <p class="text-sm text-gray-500 mt-2">This may take a moment depending on the size of your file.</p>
        </div>

        <div id="resultsSection" class="hidden">
            <div class="bg-white rounded-lg shadow-md overflow-hidden mb-8">
                <div class="border-b border-gray-200">
                    <nav class="flex -mb-px">
                        <button class="tab-btn text-blue-600 border-blue-600 active whitespace-nowrap py-4 px-6 border-b-2 font-medium text-sm" data-tab="marketSummary">
                            Market Summary
                        </button>
                        <button class="tab-btn text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-6 border-b-2 border-transparent font-medium text-sm" data-tab="blogPost">
                            Blog Post
                        </button>
                        <button class="tab-btn text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-6 border-b-2 border-transparent font-medium text-sm" data-tab="socialMedia">
                            Social Media
                        </button>
                        <button class="tab-btn text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-6 border-b-2 border-transparent font-medium text-sm" data-tab="videoScript">
                            Video Script
                        </button>
                        <button class="tab-btn text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-6 border-b-2 border-transparent font-medium text-sm" data-tab="newsletter">
                            Newsletter
                        </button>
                    </nav>
                </div>

                <!-- Market Summary Tab -->
                <div id="marketSummary" class="tab-content active p-6">
                    <h2 class="text-2xl font-bold mb-4">Market Summary</h2>
                    <div class="mb-6">
                        <h3 class="text-lg font-semibold mb-2">Key Insights</h3>
                        <div id="keyInsights" class="prose max-w-none"></div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h3 class="text-lg font-semibold mb-2">Inventory & Sales</h3>
                            <div class="chart-container">
                                <canvas id="inventoryChart"></canvas>
                            </div>
                            <div id="inventoryStats" class="text-sm"></div>
                        </div>
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h3 class="text-lg font-semibold mb-2">Price Trends</h3>
                            <div class="chart-container">
                                <canvas id="priceChart"></canvas>
                            </div>
                            <div id="priceStats" class="text-sm"></div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h3 class="text-lg font-semibold mb-2">Days on Market</h3>
                            <div class="chart-container">
                                <canvas id="domChart"></canvas>
                            </div>
                            <div id="domStats" class="text-sm"></div>
                        </div>
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h3 class="text-lg font-semibold mb-2">List to Sold Price Ratio</h3>
                            <div class="chart-container">
                                <canvas id="listToSoldChart"></canvas>
                            </div>
                            <div id="ratioStats" class="text-sm"></div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h3 class="text-lg font-semibold mb-2">Top Subdivisions</h3>
                            <div class="chart-container">
                                <canvas id="subdivisionsChart"></canvas>
                            </div>
                            <div id="subdivisionStats" class="text-sm"></div>
                        </div>
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h3 class="text-lg font-semibold mb-2">Market Distribution</h3>
                            <div class="chart-container">
                                <canvas id="statusChart"></canvas>
                            </div>
                            <div id="statusStats" class="text-sm"></div>
                        </div>
                    </div>
                </div>

                <!-- Blog Post Tab -->
                <div id="blogPost" class="tab-content p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold">Blog Post</h2>
                        <button id="copyBlogBtn" class="inline-flex items-center px-3 py-1 border border-transparent text-sm font-medium rounded-md text-blue-700 bg-blue-100 hover:bg-blue-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                            Copy to Clipboard
                        </button>
                    </div>
                    <div id="blogPostContent" class="prose max-w-none"></div>
                    <div class="mt-6 bg-gray-50 p-4 rounded-lg">
                        <h3 class="text-lg font-semibold mb-2">Featured Chart</h3>
                        <div class="chart-container">
                            <canvas id="blogChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Social Media Tab -->
                <div id="socialMedia" class="tab-content p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold">Social Media Post</h2>
                        <button id="copySocialBtn" class="inline-flex items-center px-3 py-1 border border-transparent text-sm font-medium rounded-md text-blue-700 bg-blue-100 hover:bg-blue-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                            Copy to Clipboard
                        </button>
                    </div>
                    <div class="bg-white border border-gray-200 rounded-lg shadow-sm overflow-hidden mb-6">
                        <div class="p-4 border-b border-gray-200">
                            <div class="flex items-center">
                                <div class="bg-gray-200 rounded-full h-10 w-10 flex items-center justify-center">
                                    <svg class="h-6 w-6 text-gray-500" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M12 12a3 3 0 100-6 3 3 0 000 6z"></path>
                                        <path fill-rule="evenodd" d="M12 2C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10S17.523 2 12 2zm0 18c-4.411 0-8-3.589-8-8s3.589-8 8-8 8 3.589 8 8-3.589 8-8 8z" clip-rule="evenodd"></path>
                                    </svg>
                                </div>
                                <div class="ml-3">
                                    <p class="text-sm font-medium text-gray-900">Your Real Estate Brand</p>
                                    <p class="text-xs text-gray-500">Local Market Expert</p>
                                </div>
                            </div>
                        </div>
                        <div class="p-4">
                            <p id="socialPostText" class="text-sm text-gray-700 mb-4"></p>
                            <div class="bg-gray-50 rounded-lg overflow-hidden">
                                <div class="chart-container" style="height: 250px;">
                                    <canvas id="socialChart"></canvas>
                                </div>
                            </div>
                            <div class="mt-4 flex items-center justify-between text-xs text-gray-500">
                                <span>Hashtags: <span id="socialHashtags"></span></span>
                                <span>Share this with your clients!</span>
                            </div>
                        </div>
                    </div>
                    <div class="mt-4">
                        <h3 class="text-lg font-semibold mb-2">Image Generation</h3>
                        <p class="text-sm text-gray-600 mb-2">Your social media chart has been prepared. Download and use with your post.</p>
                        <button id="downloadSocialImg" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                            Download Chart Image
                        </button>
                    </div>
                </div>

                <!-- Video Script Tab -->
                <div id="videoScript" class="tab-content p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold">Video Script</h2>
                        <button id="copyScriptBtn" class="inline-flex items-center px-3 py-1 border border-transparent text-sm font-medium rounded-md text-blue-700 bg-blue-100 hover:bg-blue-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                            Copy to Clipboard
                        </button>
                    </div>
                    <div class="mb-6">
                        <p class="text-sm text-gray-600 mb-4">This script is designed for a simple talking-head video of 90 seconds or less. Record yourself delivering this script to create compelling market update content.</p>
                        <div id="videoScriptContent" class="prose max-w-none p-4 bg-gray-50 rounded-lg"></div>
                    </div>
                    <div class="mt-4">
                        <h3 class="text-lg font-semibold mb-2">Tips for Recording</h3>
                        <ul class="list-disc pl-5 text-sm text-gray-600">
                            <li class="mb-1">Practice the script a few times before recording</li>
                            <li class="mb-1">Record in a well-lit, quiet space with a simple background</li>
                            <li class="mb-1">Look directly at the camera, not at your script</li>
                            <li class="mb-1">Speak clearly and at a moderate pace</li>
                            <li class="mb-1">Keep video length under 90 seconds for maximum engagement</li>
                            <li>Add captions to your video for accessibility</li>
                        </ul>
                    </div>
                </div>

                <!-- Newsletter Tab -->
                <div id="newsletter" class="tab-content p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold">Email Newsletter</h2>
                        <button id="copyNewsletterBtn" class="inline-flex items-center px-3 py-1 border border-transparent text-sm font-medium rounded-md text-blue-700 bg-blue-100 hover:bg-blue-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                            Copy to Clipboard
                        </button>
                    </div>
                    <div class="mb-6">
                        <p class="text-sm text-gray-600 mb-4">This newsletter is ready to copy and paste into your email service provider (Gmail, Outlook, Mailchimp, etc.).</p>
                        <div class="border border-gray-200 rounded-lg overflow-hidden shadow-sm">
                            <div class="p-4 bg-gray-50 border-b border-gray-200">
                                <h3 class="text-lg font-semibold" id="newsletterSubject"></h3>
                            </div>
                            <div class="p-4 bg-white">
                                <div id="newsletterContent" class="prose max-w-none"></div>
                                <div class="mt-6">
                                    <div class="chart-container" style="height: 300px;">
                                        <canvas id="newsletterChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer class="bg-gray-800 text-white py-6">
        <div class="container mx-auto px-4">
            <p class="text-center text-sm">Real Estate Market Insights Generator - Your Market Analysis Tool</p>
            <p class="text-center text-xs mt-2">Data is analyzed exclusively on your device and is not stored on any server.</p>
        </div>
    </footer>

    <script>
        // Wait for page to fully load before initializing
        window.addEventListener('load', function() {
            console.log("Page fully loaded - starting initialization");
            
            try {
                // Initialize the application
                initApp();
            } catch (error) {
                console.error("Error initializing app:", error);
                alert("There was an error initializing the application: " + error.message);
            }
            
            function initApp() {
                // DOM Elements
                const fileInput = document.getElementById('fileInput');
                const dropzone = document.getElementById('dropzone');
                const fileInfo = document.getElementById('fileInfo');
                const fileName = document.getElementById('fileName');
                const analyzeBtn = document.getElementById('analyzeBtn');
                const loadingState = document.getElementById('loadingState');
                const resultsSection = document.getElementById('resultsSection');
                const tabButtons = document.querySelectorAll('.tab-btn');
                const tabContents = document.querySelectorAll('.tab-content');
                
                console.log("DOM elements retrieved");
                
                // Copy buttons
                const copyBlogBtn = document.getElementById('copyBlogBtn');
                const copySocialBtn = document.getElementById('copySocialBtn');
                const copyScriptBtn = document.getElementById('copyScriptBtn');
                const copyNewsletterBtn = document.getElementById('copyNewsletterBtn');
                const downloadSocialImg = document.getElementById('downloadSocialImg');

                // Global variables
                let parsedData = null;
                let analysisResults = null;

                // Set up file input and dropzone
                fileInput.addEventListener('change', handleFileSelection);
                
                dropzone.addEventListener('click', function() {
                    console.log("Dropzone clicked");
                    fileInput.click();
                });
                
                // Prevent default behavior for dragover
                dropzone.addEventListener('dragover', function(e) {
                    console.log("Drag over event");
                    e.preventDefault();
                    dropzone.classList.add('border-blue-500');
                });
                
                // Handle dragleave
                dropzone.addEventListener('dragleave', function() {
                    dropzone.classList.remove('border-blue-500');
                });
                
                // Handle drop
                dropzone.addEventListener('drop', function(e) {
                    console.log("File dropped");
                    e.preventDefault();
                    dropzone.classList.remove('border-blue-500');
                    
                    if (e.dataTransfer.files.length) {
                        const file = e.dataTransfer.files[0];
                        if (file.type === 'text/csv' || file.name.endsWith('.csv')) {
                            fileInput.files = e.dataTransfer.files;
                            handleFileSelection();
                        } else {
                            alert('Please upload a CSV file.');
                        }
                    }
                });

                // Handle tab switching
                tabButtons.forEach(button => {
                    button.addEventListener('click', function() {
                        console.log("Tab button clicked:", button.dataset.tab);
                        // Remove active class from all buttons and contents
                        tabButtons.forEach(btn => btn.classList.remove('text-blue-600', 'border-blue-600', 'active'));
                        tabButtons.forEach(btn => btn.classList.add('text-gray-500', 'border-transparent'));
                        tabContents.forEach(content => content.classList.remove('active'));
                        
                        // Add active class to clicked button and corresponding content
                        button.classList.remove('text-gray-500', 'border-transparent');
                        button.classList.add('text-blue-600', 'border-blue-600', 'active');
                        document.getElementById(button.dataset.tab).classList.add('active');
                    });
                });

                // Copy buttons functionality
                if (copyBlogBtn) {
                    copyBlogBtn.addEventListener('click', function() {
                        copyToClipboard(document.getElementById('blogPostContent').innerText);
                    });
                }
                
                if (copySocialBtn) {
                    copySocialBtn.addEventListener('click', function() {
                        copyToClipboard(document.getElementById('socialPostText').innerText + '\n\n' + document.getElementById('socialHashtags').innerText);
                    });
                }
                
                if (copyScriptBtn) {
                    copyScriptBtn.addEventListener('click', function() {
                        copyToClipboard(document.getElementById('videoScriptContent').innerText);
                    });
                }
                
                if (copyNewsletterBtn) {
                    copyNewsletterBtn.addEventListener('click', function() {
                        copyToClipboard(document.getElementById('newsletterContent').innerText);
                    });
                }
                
                // Download social image
                if (downloadSocialImg) {
                    downloadSocialImg.addEventListener('click', function() {
                        const canvas = document.getElementById('socialChart');
                        const link = document.createElement('a');
                        link.download = 'real-estate-market-chart.png';
                        link.href = canvas.toDataURL('image/png');
                        link.click();
                    });
                }

                // Analyze button click handler
                if (analyzeBtn) {
                    analyzeBtn.addEventListener('click', analyzeData);
                }

                console.log("Event listeners set up");

                function handleFileSelection() {
                    try {
                        console.log("File selection handler called");
                        const file = fileInput.files[0];
                        if (file) {
                            console.log("File selected:", file.name);
                            fileName.textContent = file.name;
                            fileInfo.classList.remove('hidden');
                        }
                    } catch (error) {
                        console.error("Error in handleFileSelection:", error);
                        alert("Error handling file selection: " + error.message);
                    }
                }

                function copyToClipboard(text) {
                    try {
                        navigator.clipboard.writeText(text)
                            .then(() => alert('Copied to clipboard!'))
                            .catch(err => {
                                console.error('Could not copy text: ', err);
                                alert('Could not copy text. Your browser may not support this feature.');
                            });
                    } catch (error) {
                        console.error("Error in copyToClipboard:", error);
                        alert("Error copying to clipboard: " + error.message);
                    }
                }

                function analyzeData() {
                    try {
                        console.log("Analyze data function called");
                        const file = fileInput.files[0];
                        if (!file) {
                            alert('Please select a CSV file first.');
                            return;
                        }

                        // Show loading state
                        fileInfo.classList.add('hidden');
                        loadingState.classList.remove('hidden');

                        console.log("Starting file read");
                        // Read and parse the CSV file
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            try {
                                console.log("File read complete");
                                const csvData = e.target.result;
                                
                                console.log("Parsing CSV with Papa Parse");
                                Papa.parse(csvData, {
                                    header: true,
                                    dynamicTyping: true,
                                    skipEmptyLines: true,
                                    complete: function(results) {
                                        try {
                                            console.log("Papa Parse complete:", results.data.length, "rows");
                                            parsedData = results.data;
                                            
                                            // Process the data and generate insights
                                            processDataAndGenerateInsights(parsedData);
                                            
                                            // Hide loading, show results
                                            loadingState.classList.add('hidden');
                                            resultsSection.classList.remove('hidden');
                                        } catch (error) {
                                            console.error("Error in Papa Parse complete callback:", error);
                                            alert("Error processing CSV data: " + error.message);
                                            loadingState.classList.add('hidden');
                                            fileInfo.classList.remove('hidden');
                                        }
                                    },
                                    error: function(error) {
                                        console.error('Error parsing CSV:', error);
                                        alert('Error parsing CSV file. Please check the file format.');
                                        loadingState.classList.add('hidden');
                                        fileInfo.classList.remove('hidden');
                                    }
                                });
                            } catch (error) {
                                console.error("Error in FileReader onload:", error);
                                alert("Error reading file: " + error.message);
                                loadingState.classList.add('hidden');
                                fileInfo.classList.remove('hidden');
                            }
                        };
                        
                        reader.onerror = function() {
                            console.error("FileReader error");
                            alert("Error reading the file. Please try again.");
                            loadingState.classList.add('hidden');
                            fileInfo.classList.remove('hidden');
                        };
                        
                        reader.readAsText(file);
                    } catch (error) {
                        console.error("Error in analyzeData:", error);
                        alert("Error analyzing data: " + error.message);
                        loadingState.classList.add('hidden');
                        fileInfo.classList.remove('hidden');
                    }
                }

                function processDataAndGenerateInsights(data) {
                    try {
                        console.log("Processing data and generating insights");
                        // This function will analyze the data and generate all the insights
                        // For the demo, we'll use sample analysis based on the provided data
                        
                        // In a real implementation, this would dynamically analyze the uploaded CSV
                        // and generate insights based on that specific data
                        
                        // Sample analysis results (this would be generated from the actual data)
                        analysisResults = {
                            location: "Queen Creek, Arizona",
                            period: "Past 12 Months",
                            totalProperties: data.length,
                            activeListings: data.filter(p => p.Status === 'A').length,
                            soldProperties: data.filter(p => p.Status === 'C').length,
                            pendingProperties: data.filter(p => p.Status === 'P').length,
                            medianSoldPrice: calculateMedian(data.filter(p => p.Status === 'C' && p['Sold Price']).map(p => p['Sold Price'])),
                            medianDOM: calculateMedian(data.filter(p => p['Days on Market']).map(p => p['Days on Market'])),
                            avgPricePerSqFt: calculateAverage(data.filter(p => p['Price/SqFt'] && !isNaN(p['Price/SqFt'])).map(p => p['Price/SqFt'])),
                            monthsOfInventory: calculateMonthsOfInventory(data),
                            priceTrend: calculatePriceTrend(data),
                            domTrend: calculateDOMTrend(data),
                            topSubdivisions: calculateTopSubdivisions(data, 5),
                            statusDistribution: calculateStatusDistribution(data),
                            listToSoldRatio: calculateListToSoldRatio(data),
                            priceRanges: calculatePriceRanges(data.filter(p => p.Status === 'A')),
                            bedroomDistribution: calculateBedroomDistribution(data),
                            poolDistribution: calculatePoolDistribution(data),
                            yearBuiltDistribution: calculateYearBuiltDistribution(data),
                            topAgencies: calculateTopAgencies(data, 5)
                        };
                        
                        console.log("Analysis complete, populating UI");
                        // Update all the UI elements with the analysis results
                        populateUI(analysisResults);
                    } catch (error) {
                        console.error("Error in processDataAndGenerateInsights:", error);
                        alert("Error processing data: " + error.message);
                        loadingState.classList.ad